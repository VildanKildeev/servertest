<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
  />
  <title>СМЗ.РФ — заявки, техника, чат</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    referrerpolicy="no-referrer"
  />
  <style>
    :root{
      --bg:#f7f7f8;
      --card:#fff;
      --text:#1d1d1f;
      --muted:#6b7280;
      --primary:#ef7d1a;
      --primary-600:#d46f16;
      --border:#e5e7eb;
      --success:#16a34a;
      --danger:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:inherit}
    button{cursor:pointer}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .card.pad{padding:16px}
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .col{flex:1}
    .muted{color:var(--muted)}
    .mb8{margin-bottom:8px}.mb12{margin-bottom:12px}.mb16{margin-bottom:16px}.mb24{margin-bottom:24px}
    .mt8{margin-top:8px}.mt16{margin-top:16px}
    .title{font-size:18px;font-weight:700}
    .btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 14px}
    .btn:active{transform:translateY(1px)}
    .btn.outline{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    .btn.gray{background:#e5e7eb;color:#111}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    textarea{min-height:90px;resize:vertical}
    .tabs{position:sticky;bottom:0;left:0;right:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(8px);border-top:1px solid var(--border);display:flex;gap:8px;padding:10px;z-index:5}
    .tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted)}
    .tab.active{color:var(--primary)}
    .list{display:grid;gap:12px}
    .item{border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .chip{background:#f3f4f6;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px}
    .right{margin-left:auto}
    .hidden{display:none !important}
    .status{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#f9fafb}
    .status.open{border-color:#86efac;background:#f0fdf4}
    .status.closed{border-color:#fecaca;background:#fff1f2}
    /* чат */
    #chatLog{height:330px;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px}
    .msg{display:flex;gap:8px;margin-bottom:10px}
    .msg .bubble{padding:8px 10px;border-radius:12px;border:1px solid var(--border);max-width:75%}
    .msg.self{justify-content:flex-end}
    .msg.self .bubble{background:#fef3c7;border-color:#fcd34d}
    .msg.other .bubble{background:#f3f4f6}
    .msg .time{font-size:11px;color:var(--muted);margin-top:4px}
    .chat-bar{display:flex;gap:8px;margin-top:8px}
    .chat-bar input{flex:1}
    .danger{color:var(--danger)}
    .success{color:var(--success)}
  </style>
</head>
<body>
<div class="wrap">

  <!-- АВТОРИЗАЦИЯ -->
  <section id="authPage" class="card pad mb16">
    <div class="title mb12">Вход / Регистрация</div>
    <div class="row wrap">
      <div class="col">
        <div class="mb8 muted">Email</div>
        <input id="auth_email" type="email" placeholder="you@example.com"/>
      </div>
      <div class="col">
        <div class="mb8 muted">Пароль</div>
        <input id="auth_password" type="password" placeholder="••••••••"/>
      </div>
    </div>
    <div class="row mt16">
      <button class="btn" id="btnLogin"><i class="fa-solid fa-right-to-bracket"></i>&nbsp;Войти</button>
      <button class="btn outline" id="btnRegister"><i class="fa-solid fa-user-plus"></i>&nbsp;Зарегистрироваться</button>
      <span class="right muted" id="auth_state"></span>
    </div>
  </section>

  <!-- ГЛАВНЫЙ ЭКРАН -->
  <section id="mainPage" class="hidden">
    <div class="card pad mb16">
      <div class="row">
        <div class="title">СМЗ.РФ</div>
        <div class="right muted" id="userEmail"></div>
      </div>
      <div class="row mt16 wrap">
        <div class="col">
          <div class="muted mb8">Город</div>
          <select id="citySelect"></select>
        </div>
        <div class="col">
          <div class="muted mb8">Быстрые действия</div>
          <div class="row">
            <button class="btn" id="btnNewWorkReq"><i class="fa-solid fa-plus"></i>&nbsp;Заявка (работа)</button>
            <button class="btn gray" id="btnNewMachineryReq">Спецтехника</button>
            <button class="btn gray" id="btnNewToolReq">Инструмент</button>
            <button class="btn gray" id="btnNewMaterialAd">Материалы</button>
          </div>
        </div>
      </div>
      <div class="kpi mt16">
        <div class="chip" id="kpiWork">Заявок: —</div>
        <div class="chip" id="kpiMachinery">Спецтехника: —</div>
        <div class="chip" id="kpiTools">Инструмент: —</div>
        <div class="chip" id="kpiMaterials">Материалы: —</div>
      </div>
    </div>

    <!-- СПИСОК ЗАЯВОК (РАБОТА) -->
    <div class="card pad mb16">
      <div class="row mb12">
        <div class="title">Заявки на работу</div>
        <button class="btn right" id="refreshWork"><i class="fa-solid fa-rotate"></i></button>
      </div>
      <div id="workList" class="list"></div>
    </div>

    <!-- СПЕЦТЕХНИКА -->
    <div class="card pad mb16">
      <div class="row mb12">
        <div class="title">Запросы спецтехники</div>
        <button class="btn right" id="refreshMachinery"><i class="fa-solid fa-rotate"></i></button>
      </div>
      <div id="machineryList" class="list"></div>
    </div>

    <!-- ИНСТРУМЕНТ -->
    <div class="card pad mb16">
      <div class="row mb12">
        <div class="title">Запросы инструмента</div>
        <button class="btn right" id="refreshTools"><i class="fa-solid fa-rotate"></i></button>
      </div>
      <div id="toolsList" class="list"></div>
    </div>

    <!-- МАТЕРИАЛЫ -->
    <div class="card pad mb24">
      <div class="row mb12">
        <div class="title">Объявления материалов</div>
        <button class="btn right" id="refreshMaterials"><i class="fa-solid fa-rotate"></i></button>
      </div>
      <div id="materialsList" class="list"></div>
    </div>
  </section>

  <!-- МОИ ЧАТЫ -->
  <section id="myChatsPage" class="card pad hidden">
    <div class="row mb12">
      <div class="title">Мои чаты</div>
      <button class="btn right" id="refreshChats"><i class="fa-solid fa-rotate"></i></button>
    </div>
    <p class="muted mb12">
      Здесь показаны активные диалоги по заявкам. Для установления WS-соединения понадобятся
      <b>request_id</b> и <b>opponent_id</b> (временная мера до появления участника в API).
    </p>
    <div id="chatsList" class="list"></div>
  </section>

  <!-- СТРАНИЦА ЧАТА -->
  <section id="chatPage" class="card pad hidden">
    <div class="row mb12">
      <div class="title" id="chatTitle">Чат</div>
      <button class="btn gray right" id="btnExitChat"><i class="fa-solid fa-xmark"></i>&nbsp;Закрыть</button>
    </div>

    <div id="chatLog"></div>

    <form id="chatForm" class="chat-bar">
      <input id="chatInput" type="text" placeholder="Сообщение..." autocomplete="off"/>
      <button class="btn" type="submit"><i class="fa-solid fa-paper-plane"></i></button>
    </form>

    <div class="mt8 muted" id="chatHint"></div>
  </section>

  <!-- НИЖНЕЕ МЕНЮ -->
  <nav class="tabs card">
    <button class="tab" data-tab="mainPage"><i class="fa-solid fa-list"></i><span>Заявки</span></button>
    <button class="tab" data-tab="myChatsPage"><i class="fa-solid fa-comments"></i><span>Чаты</span></button>
    <button class="tab" id="btnLogout"><i class="fa-solid fa-arrow-right-from-bracket"></i><span>Выход</span></button>
  </nav>
</div>

<script>
/** === КОНФИГ/ХЕЛПЕРЫ === **/
const API_URL = '/api';
let accessToken = localStorage.getItem('access_token') || null;
let currentUser = null;

function wsUrl(requestId, opponentId){
  const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
  return `${proto}://${location.host}${API_URL}/ws/chat/${requestId}/${opponentId}?token=${accessToken}`;
}
async function api(path, opts = {}) {
  const headers = opts.headers || {};
  if(accessToken) headers['Authorization'] = `Bearer ${accessToken}`;
  if(opts.body && !(opts.body instanceof FormData)){
    headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(opts.body);
  }
  const res = await fetch(`${API_URL}${path}`, {...opts, headers});
  if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return res.json();
}
function fmtDate(s){try{return new Date(s).toLocaleString()}catch{return s}}
function el(tag, cls, html){const e=document.createElement(tag); if(cls)e.className=cls; if(html!==undefined)e.innerHTML=html; return e}
function show(id){
  for(const sec of document.querySelectorAll('section')) sec.classList.add('hidden');
  document.getElementById(id).classList.remove('hidden');
  for(const t of document.querySelectorAll('.tab')) t.classList.remove('active');
  const tab = document.querySelector(`.tab[data-tab="${id}"]`); if(tab) tab.classList.add('active');
}

/** === АВТОРИЗАЦИЯ === **/
async function me(){
  try{
    const u = await api('/users/me');
    currentUser = u;
    document.getElementById('userEmail').textContent = u.email;
    document.getElementById('authPage').classList.add('hidden');
    document.getElementById('mainPage').classList.remove('hidden');
    document.querySelector('.tabs').classList.remove('hidden');
  }catch{
    currentUser = null;
    document.getElementById('authPage').classList.remove('hidden');
    document.getElementById('mainPage').classList.add('hidden');
    document.querySelector('.tabs').classList.add('hidden');
  }
}
async function login(email, password){
  const form = new URLSearchParams(); form.set('username', email); form.set('password', password);
  const res = await fetch(`${API_URL}/token`, {method:'POST', body:form});
  if(!res.ok) throw new Error('Неверный логин/пароль');
  const data = await res.json();
  accessToken = data.access_token;
  localStorage.setItem('access_token', accessToken);
}

/** === СПРАВОЧНИКИ === **/
async function loadCities(){
  const list = await api('/cities');
  const sel = document.getElementById('citySelect');
  sel.innerHTML = '';
  list.forEach(c=>{
    const o = el('option','',c.name); o.value = c.id; sel.appendChild(o);
  });
}

/** === ЗАЯВКИ/СПИСКИ === **/
async function loadWork(){
  const list = await api('/work_requests');
  document.getElementById('kpiWork').textContent = `Заявок: ${list.length}`;
  const wrap = document.getElementById('workList'); wrap.innerHTML='';
  list.forEach(r=>{
    const it=el('div','item');
    it.innerHTML = `
      <div class="row mb8">
        <b>#${r.id} — ${r.title}</b>
        <span class="right status ${r.status==='open'?'open':'closed'}">${r.status}</span>
      </div>
      <div class="muted mb8">${r.description || ''}</div>
      <div class="row muted"><span>Город ID: ${r.city_id}</span><span class="right">${fmtDate(r.created_at)}</span></div>
    `;
    wrap.appendChild(it);
  });
}
async function loadMachinery(){
  const list = await api('/machinery_requests');
  document.getElementById('kpiMachinery').textContent = `Спецтехника: ${list.length}`;
  const wrap = document.getElementById('machineryList'); wrap.innerHTML='';
  list.forEach(r=>{
    const it=el('div','item');
    it.innerHTML = `
      <div class="row mb8"><b>#${r.id} — ${r.title}</b></div>
      <div class="muted mb8">${r.description || ''}</div>
      <div class="row muted"><span>Тип: ${r.type}</span><span class="right">${fmtDate(r.created_at)}</span></div>
    `;
    wrap.appendChild(it);
  });
}
async function loadTools(){
  const list = await api('/tool_requests');
  document.getElementById('kpiTools').textContent = `Инструмент: ${list.length}`;
  const wrap = document.getElementById('toolsList'); wrap.innerHTML='';
  list.forEach(r=>{
    const it=el('div','item');
    it.innerHTML = `
      <div class="row mb8"><b>#${r.id} — ${r.title}</b></div>
      <div class="muted mb8">${r.description || ''}</div>
      <div class="row muted"><span>Инструмент: ${r.tool}</span><span class="right">${fmtDate(r.created_at)}</span></div>
    `;
    wrap.appendChild(it);
  });
}
async function loadMaterials(){
  const list = await api('/material_ads');
  document.getElementById('kpiMaterials').textContent = `Материалы: ${list.length}`;
  const wrap = document.getElementById('materialsList'); wrap.innerHTML='';
  list.forEach(r=>{
    const it=el('div','item');
    it.innerHTML = `
      <div class="row mb8"><b>#${r.id} — ${r.title}${r.price?` — ${r.price} ₽`:''}</b></div>
      <div class="muted mb8">${r.description || ''}</div>
      <div class="row muted"><span>Тип: ${r.material_type}</span><span class="right">${fmtDate(r.created_at)}</span></div>
    `;
    wrap.appendChild(it);
  });
}

/** === СОЗДАНИЕ СУЩНОСТЕЙ (диалоги вместо модалок, чтобы упростить верстку) === **/
function promptNonEmpty(label){ const v = prompt(label); if(v===null) return null; return v.trim()?v.trim():null }
async function createWorkReq(){
  const city_id = +document.getElementById('citySelect').value;
  const title = promptNonEmpty('Название заявки (работа)'); if(!title) return;
  const description = promptNonEmpty('Описание'); if(!description) return;
  const budgetStr = prompt('Бюджет (необязательно)'); const budget = budgetStr? +budgetStr : null;
  await api('/work_requests',{method:'POST', body:{city_id,title,description,budget}});
  await loadWork();
}
async function createMachineryReq(){
  const city_id = +document.getElementById('citySelect').value;
  const type = promptNonEmpty('Тип спецтехники (например, Экскаватор)'); if(!type) return;
  const title = promptNonEmpty('Заголовок'); if(!title) return;
  const description = promptNonEmpty('Описание'); if(!description) return;
  await api('/machinery_requests',{method:'POST', body:{city_id,type,title,description}});
  await loadMachinery();
}
async function createToolReq(){
  const city_id = +document.getElementById('citySelect').value;
  const tool = promptNonEmpty('Инструмент (например, Перфоратор)'); if(!tool) return;
  const title = promptNonEmpty('Заголовок'); if(!title) return;
  const description = promptNonEmpty('Описание'); if(!description) return;
  await api('/tool_requests',{method:'POST', body:{city_id,tool,title,description}});
  await loadTools();
}
async function createMaterialAd(){
  const city_id = +document.getElementById('citySelect').value;
  const material_type = promptNonEmpty('Тип материала (например, Песок)'); if(!material_type) return;
  const title = promptNonEmpty('Заголовок'); if(!title) return;
  const description = promptNonEmpty('Описание'); if(!description) return;
  const priceStr = prompt('Цена (необязательно)'); const price = priceStr? +priceStr : null;
  await api('/material_ads',{method:'POST', body:{city_id,material_type,title,description,price}});
  await loadMaterials();
}

/** === МОИ ЧАТЫ === **/
async function loadMyChats(){
  const list = await api('/chats/my_active_chats');
  const wrap = document.getElementById('chatsList'); wrap.innerHTML='';
  if(!list.length){
    wrap.appendChild(el('div','muted','Пока нет сообщений.'));
    return;
  }
  list.forEach(c=>{
    const it=el('div','item');
    // поле ввода opponent_id — временно, пока в API нет собеседника
    const opponentIdInputId = `opp_${c.request_id}`;
    it.innerHTML = `
      <div class="row mb8">
        <b>Заявка #${c.request_id}</b>
        <span class="right muted">посл.: ${fmtDate(c.last_message_at)}</span>
      </div>
      <div class="row">
        <div class="col"><input id="${opponentIdInputId}" type="number" placeholder="opponent_id (ID собеседника)"/></div>
        <button class="btn" data-open="${c.request_id}"><i class="fa-solid fa-comments"></i>&nbsp;Открыть чат</button>
      </div>
    `;
    wrap.appendChild(it);
    it.querySelector('button[data-open]').addEventListener('click', ()=>{
      const opp = document.getElementById(opponentIdInputId).value.trim();
      if(!opp){ alert('Введите opponent_id'); return; }
      openChat(c.request_id, +opp);
    });
  });
}

/** === ЧАТ ПО WS === **/
let chatSocket = null;
let chatCtx = {requestId:null, opponentId:null};

function appendMsg({sender_id,message,timestamp}, self){
  const log = document.getElementById('chatLog');
  const row = el('div',`msg ${self?'self':'other'}`);
  const bubble = el('div','bubble', `<div>${message.replace(/</g,'&lt;')}</div><div class="time">${fmtDate(timestamp)}</div>`);
  row.appendChild(bubble);
  log.appendChild(row);
  log.scrollTop = log.scrollHeight;
}

function openChat(requestId, opponentId){
  // закрыть предыдущее
  if(chatSocket){ try{ chatSocket.close(); }catch{} chatSocket=null; }
  chatCtx = {requestId, opponentId};
  document.getElementById('chatTitle').textContent = `Чат — заявка #${requestId} (opponent: ${opponentId})`;
  document.getElementById('chatLog').innerHTML='';
  document.getElementById('chatHint').textContent = 'История пока не загружается (только LIVE).';

  // соединение
  const url = wsUrl(requestId, opponentId);
  chatSocket = new WebSocket(url);

  chatSocket.onopen = ()=> {
    show('chatPage');
    document.getElementById('chatHint').innerHTML = `<span class="success"><i class="fa-solid fa-circle-check"></i> Соединение установлено</span>`;
  };
  chatSocket.onclose = ()=> {
    document.getElementById('chatHint').innerHTML = `<span class="danger"><i class="fa-solid fa-circle-xmark"></i> Соединение закрыто</span>`;
  };
  chatSocket.onerror = ()=> {
    document.getElementById('chatHint').innerHTML = `<span class="danger"><i class="fa-solid fa-triangle-exclamation"></i> Ошибка соединения</span>`;
  };
  chatSocket.onmessage = (ev)=>{
    try{
      const data = JSON.parse(ev.data);
      const self = (data.sender_id === currentUser?.id);
      appendMsg({sender_id:data.sender_id,message:data.message,timestamp:data.timestamp}, self);
    }catch{
      // текст без JSON — тоже покажем
      appendMsg({sender_id:null,message:ev.data,timestamp:new Date().toISOString()}, false);
    }
  };
}

document.getElementById('chatForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const input = document.getElementById('chatInput');
  const txt = input.value.trim();
  if(!txt || !chatSocket || chatSocket.readyState!==1) return;
  chatSocket.send(txt);
  appendMsg({sender_id:currentUser?.id,message:txt,timestamp:new Date().toISOString()}, true);
  input.value='';
});
document.getElementById('btnExitChat').addEventListener('click', ()=>{
  if(chatSocket){ try{ chatSocket.close(); }catch{} chatSocket=null; }
  show('myChatsPage');
});

/** === ИНИЦИАЛИЗАЦИЯ UI === **/
document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const email = document.getElementById('auth_email').value.trim();
  const pwd = document.getElementById('auth_password').value;
  const s = document.getElementById('auth_state');
  s.textContent = 'Вход...';
  try{
    await login(email,pwd);
    await me();
    await loadCities();
    await Promise.all([loadWork(),loadMachinery(),loadTools(),loadMaterials()]);
    s.textContent = 'Готово';
  }catch(err){
    s.textContent = ''; alert(err.message || 'Ошибка входа');
  }
});
document.getElementById('btnRegister').addEventListener('click', async ()=>{
  const email = document.getElementById('auth_email').value.trim();
  const pwd = document.getElementById('auth_password').value;
  const s = document.getElementById('auth_state');
  s.textContent = 'Регистрация...';
  try{
    await api('/register',{method:'POST', body:{email,password:pwd}});
    await login(email,pwd);
    await me();
    await loadCities();
    await Promise.all([loadWork(),loadMachinery(),loadTools(),loadMaterials()]);
    s.textContent = 'Готово';
  }catch(err){
    s.textContent=''; alert(err.message || 'Ошибка регистрации');
  }
});

document.getElementById('refreshWork').addEventListener('click', loadWork);
document.getElementById('refreshMachinery').addEventListener('click', loadMachinery);
document.getElementById('refreshTools').addEventListener('click', loadTools);
document.getElementById('refreshMaterials').addEventListener('click', loadMaterials);
document.getElementById('refreshChats').addEventListener('click', loadMyChats);

document.getElementById('btnNewWorkReq').addEventListener('click', createWorkReq);
document.getElementById('btnNewMachineryReq').addEventListener('click', createMachineryReq);
document.getElementById('btnNewToolReq').addEventListener('click', createToolReq);
document.getElementById('btnNewMaterialAd').addEventListener('click', createMaterialAd);

document.querySelectorAll('.tab[data-tab]').forEach(t=>{
  t.addEventListener('click', ()=>{
    const id=t.getAttribute('data-tab');
    show(id);
    if(id==='mainPage'){ Promise.all([loadWork(),loadMachinery(),loadTools(),loadMaterials()]); }
    if(id==='myChatsPage'){ loadMyChats(); }
  });
});
document.getElementById('btnLogout').addEventListener('click', ()=>{
  localStorage.removeItem('access_token'); accessToken=null; currentUser=null;
  if(chatSocket){ try{ chatSocket.close(); }catch{} chatSocket=null; }
  show('authPage');
});

// автозагрузка
(async function init(){
  await me();
  if(currentUser){
    await loadCities();
    await Promise.all([loadWork(),loadMachinery(),loadTools(),loadMaterials()]);
    show('mainPage');
  }else{
    show('authPage');
  }
})();
</script>
</body>
</html>
