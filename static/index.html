<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СМЗ.РФ - Рабочие и спецтехника</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Ваши стили */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; color: white; overflow: hidden; background: black; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .background-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; }
        .selected-city { margin-top: 12px; font-size: 16px; color: #fff; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; flex-wrap: wrap; }
        #changeCityButton { background: none; border: none; color: white; font-weight: bold; text-decoration: underline; cursor: pointer; font-size: 14px; padding: 6px 10px; border-radius: 6px; }
        .grid-container { margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 12px; width: 90%; max-width: 400px; z-index: 10; }
        .grid-row { display: flex; width: 100%; gap: 12px; }
        .tile-btn { flex: 1; color: #333; background: #e0d6c8; border: 2px solid #c0b0a0; padding: 16px 8px; font-size: 15px; font-weight: bold; border-radius: 16px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); text-align: center; position: relative; overflow: hidden; min-height: 80px; display: flex; flex-direction: column; justify-content: center; text-shadow: none; }
        .tile-btn::after { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.1); border-radius: 16px; z-index: 0; pointer-events: none; }
        .tile-btn span { position: relative; z-index: 1; display: block; }
        .tile-btn small { font-size: 12px; opacity: 0.9; margin-top: 4px; }
        .tile-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4); }
        .navigation { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(216, 201, 183, 0.95); display: flex; justify-content: space-around; padding: 12px 0; z-index: 50; backdrop-filter: blur(10px); border-top: 1px solid #c0b0a0; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; background: none; border: none; cursor: pointer; padding: 8px 16px; border-radius: 12px; transition: all 0.2s ease; background: #f5f0e6; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); }
        .nav-btn span { font-size: 13px; color: #5a4a3a; }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); background: #e8dccf; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: none; justify-content: center; align-items: center; z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal.active { display: flex; opacity: 1; pointer-events: all; }
        .modal-content { background: #d8c9b7; border: 2px solid #c0b0a0; border-radius: 16px; padding: 20px; width: 90%; max-width: 420px; text-align: center; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; align-items: center; position: relative; overflow: hidden; transform: scale(0.9); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: #333; max-height: 90vh; overflow-y: auto; }
        .modal.active .modal-content { transform: scale(1); opacity: 1; }
        .modal-title { font-size: 20px; margin-bottom: 16px; color: #5a4a3a; text-align: center; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
        .search-container { width: 90%; position: relative; margin-bottom: 12px; }
        .search-container input { width: 100%; padding: 10px 10px 10px 36px; border: 1px solid #c0b0a0; border-radius: 8px; font-size: 15px; background: #e8dccf; color: #333; outline: none; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #7d6b59; font-size: 16px; pointer-events: none; }
        .modal-buttons { display: flex; flex-direction: column; gap: 12px; width: 100%; align-items: center; margin-top: 10px; }
        .modal-button { color: #5a4a3a; border: 2px solid #5a4a3a; padding: 14px; font-size: 16px; font-weight: bold; border-radius: 10px; cursor: pointer; background: #f5f0e6; width: 90%; max-width: 300px; margin: 8px 0; transition: all 0.3s ease; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
        .modal-button:hover { background: #e0d6c8; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4); }
        .close-modal { position: absolute; top: 12px; right: 12px; font-size: 24px; color: #5a4a3a; cursor: pointer; background: none; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); }
        #authModal, #registerModal, #profilePage, #requestFormPage, #takeOrderPage, #myRequestsPage, #machineryFormPage, #toolsFormPage, #chatPage, #marketplacePage, #materialsFormPage { display: none; flex-direction: column; align-items: center; width: 100%; height: 100vh; background: #d8c9b7; position: fixed; top: 0; left: 0; z-index: 200; padding: 20px 16px; overflow-y: auto; color: #333; }
        #buttonContainer { display: none; }
        .auth-header { font-size: 24px; color: #5a4a3a; text-align: center; margin-bottom: 20px; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); }
        .form-container { background: #e8dccf; border: 1px solid #c0b0a0; border-radius: 12px; padding: 20px; width: 90%; max-width: 500px; margin: 0 auto; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .form-group { width: 100%; margin-bottom: 16px; text-align: left; }
        .form-group label { display: block; margin-bottom: 6px; color: #7d6b59; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #c0b0a0; border-radius: 8px; background: #e8dccf; color: #333; font-size: 16px; }
        .auth-button { background: #4caf50; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; margin-top: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .profile-header { font-size: 20px; color: #5a4a3a; text-align: center; margin-bottom: 20px; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); }
        .profile-card { background: #e8dccf; border: 1px solid #c0b0a0; border-radius: 12px; padding: 16px; width: 90%; max-width: 400px; margin-bottom: 16px; color: #333; text-align: left; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .profile-card strong { color: #7d6b59; }
        .profile-button { background: #4caf50; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 90%; max-width: 400px; margin-top: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .logout-button { background: #f44336; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 90%; max-width: 400px; margin-top: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .subscription-info { background: #e8dccf; border: 1px solid #c0b0a0; border-radius: 12px; padding: 16px; width: 90%; max-width: 400px; margin-bottom: 16px; color: #333; text-align: left; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .subscription-info h3 { color: #5a4a3a; margin-bottom: 12px; text-align: center; }
        .subscription-status { font-weight: bold; color: #d4380d; }
        .subscription-status.active { color: #4caf50; }
        .subscription-button { background: #4caf50; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; margin-top: 10px; transition: background-color 0.3s; }
        .subscription-button:disabled { background-color: #a5d6a7; cursor: not-allowed; }
        .form-title { text-align: center; color: #5a4a3a; margin-bottom: 20px; font-size: 20px; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .checkbox-group input[type="checkbox"] { width: auto; }
        .submit-button { background: #4caf50; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; margin-top: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .back-button { margin-top: 20px; color: #7d6b59; font-size: 15px; text-decoration: underline; cursor: pointer; display: block; text-align: center; }
        .orders-header, .requests-header, .marketplace-header { text-align: center; color: #5a4a3a; margin-bottom: 20px; font-size: 20px; }
        .orders-list { width: 90%; max-width: 500px; margin: 0 auto; }
        .order-card, .request-card, .post-card { background: #e8dccf; border: 1px solid #c0b0a0; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: #333; }
        .order-card strong, .request-card strong, .post-card strong { color: #5a4a3a; display: block; margin-bottom: 8px; font-size: 16px; }
        .order-card div, .request-card div, .post-card div { margin-bottom: 4px; font-size: 14px; color: #333; word-wrap: break-word; }
        .order-card div small, .request-card div small, .post-card div small { color: #7d6b59; }
        .order-card .subscription-notice { margin-top: 8px; padding: 8px; background-color: #f5e4cc; border-radius: 6px; font-size: 13px; color: #8c6c46; border: 1px dashed #c0b0a0; }
        .take-order-btn { background: #4caf50; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; width: 100%; margin-top: 10px; }
        .no-orders { text-align: center; color: #7d6b59; padding: 20px; }
        .post-card .post-date { font-size: 12px; color: #7d6b59; text-align: right; margin-top: 10px; border-top: 1px solid #c0b0a0; padding-top: 8px; }
        .tool-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #e8dccf; border: 1px solid #c0b0a0; border-radius: 8px; margin-bottom: 10px; }
        .tool-item button { background: #d4380d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <video autoplay muted loop class="background-video">
        <source src="https://telegram.org/file/8111409990/10b37f3868/240978" type="video/mp4">
        Ваш браузер не поддерживает видео.
    </video>
    <div class="selected-city">
        <span>Город: <span id="cityName">Не выбран</span></span>
        <button id="changeCityButton">Изменить</button>
    </div>
    <div class="grid-container" id="buttonContainer">
        <div class="grid-row">
            <button type="button" class="tile-btn" id="masterButton"><span>НАЙТИ МАСТЕРА</span><small>создать заявку</small></button>
            <button type="button" class="tile-btn" id="machineryButton"><span>АРЕНДА ТЕХНИКИ</span><small>создать заявку</small></button>
        </div>
        <div class="grid-row">
            <button type="button" class="tile-btn" id="toolsButton"><span>АРЕНДА ИНСТРУМЕНТА</span><small>создать заявку</small></button>
            <button type="button" class="tile-btn" id="sellMaterialsButton"><span>ПРОДАТЬ МАТЕРИАЛЫ</span><small>разместить объявление</small></button>
        </div>
        <div class="grid-row">
            <button type="button" class="tile-btn" id="marketplaceButton"><span>ДОСКА ОБЪЯВЛЕНИЙ</span><small>купить/продать</small></button>
            <button type="button" class="tile-btn" id="profileButton"><span>ЛИЧНЫЙ КАБИНЕТ</span><small>профиль и заявки</small></button>
        </div>
    </div>
    <div class="navigation">
        <button class="nav-btn" id="navMaster"><i class="fas fa-hammer"></i><span>Заказы</span></button>
        <button class="nav-btn" id="navCreate"><i class="fas fa-plus-circle"></i><span>Создать</span></button>
        <button class="nav-btn" id="navProfile"><i class="fas fa-user"></i><span>Профиль</span></button>
        <button class="nav-btn" id="navSubscription"><i class="fas fa-crown"></i><span>Подписка</span></button>
    </div>
    <div class="modal" id="cityModal"><div class="modal-content"><button class="close-modal">&times;</button><h2 class="modal-title">Выберите ваш город</h2><div class="search-container"><i class="fas fa-search search-icon"></i><input type="text" id="citySearch" placeholder="Поиск..."></div><div class="modal-buttons" id="cityButtons"></div></div></div>
    <div id="authModal"><h2 class="auth-header">Вход в аккаунт</h2><form id="authForm" class="form-container"><div class="form-group"><label for="userPhone">Номер телефона:</label><input type="tel" id="userPhone" placeholder="+7 (999) 999-99-99" required></div><div class="form-group"><label for="userPassword">Пароль:</label><input type="password" id="userPassword" placeholder="Введите пароль" required></div><button type="submit" class="auth-button">ВОЙТИ</button><a href="#" id="switchToRegister" class="back-button">У меня нет аккаунта (Регистрация)</a></form></div>
    <div id="registerModal" style="display: none;"><h2 class="auth-header">Регистрация</h2><form id="registerForm" class="form-container">
        <div class="form-group"><label for="regUserType">Я...</label><select id="regUserType" required><option value="">Выберите тип пользователя...</option><option value="ЗАКАЗЧИК">Заказчик</option><option value="ИСПОЛНИТЕЛЬ">Исполнитель</option><option value="ВЛАДЕЛЕЦ СПЕЦТЕХНИКИ">Владелец спецтехники</option></select></div>
        <div class="form-group"><label for="regUserName">Мое имя:</label><input type="text" id="regUserName" placeholder="Введите ваше имя" required></div>
        <div class="form-group"><label for="regUserCity">Мой город:</label><select id="regUserCity" required></select></div>
        <div class="form-group"><label for="regUserPhone">Мой номер телефона:</label><input type="tel" id="regUserPhone" placeholder="+7 (999) 999-99-99" required></div>
        <div class="form-group"><label for="regUserPassword">Придумайте пароль:</label><input type="password" id="regUserPassword" placeholder="Надежный пароль" required></div>
        <div class="form-group" id="regSpecializationGroup" style="display: none;"><label for="regSpecializationSelect">Моя основная специализация:</label><select id="regSpecializationSelect"></select></div>
        <button type="submit" class="auth-button">ЗАРЕГИСТРИРОВАТЬСЯ</button>
        <a href="#" id="switchToLogin" class="back-button">У меня уже есть аккаунт (Войти)</a></form>
    </div>
    <div id="profilePage">
        <h2 class="profile-header">Ваш профиль</h2>
        <div class="profile-card">
            <div><strong>Тип:</strong> <span id="profileType"></span></div>
            <div><strong>Имя:</strong> <span id="profileName"></span></div>
            <div><strong>Телефон:</strong> <span id="profilePhone"></span></div>
            <div><strong>Город:</strong> <span id="profileCity"></span></div>
            <div id="profileSpecializationDisplay" style="margin-top: 10px; display: none;"><strong>Специализация:</strong> <span id="profileSpecialization"></span></div>
        </div>
        <div class="form-container" id="specializationGroup" style="display: none; padding: 15px; margin-top: 0; max-width: 400px;">
            <div class="form-group" style="width: 100%; margin:0;">
                <label for="profileSpecializationSelect">Изменить специализацию:</label>
                <select id="profileSpecializationSelect" style="width: 100%; padding: 10px;"></select>
                <button type="button" id="saveSpecialization" class="auth-button" style="margin-top: 10px; width: 100%;">Сохранить</button>
            </div>
        </div>
        <div class="subscription-info">
            <h3>Подписка "Профи"</h3>
            <div>Статус: <span id="subscriptionStatus" class="subscription-status">Не активна</span></div>
            <div>Срок действия: <span id="subscriptionExpiry">-</span></div>
            <button class="subscription-button" id="subscriptionButton">Оформить подписку</button>
        </div>
        <button class="profile-button" id="myRequestsButton">Мои заявки</button>
        <button class="logout-button" id="logoutButton">ВЫЙТИ</button>
        <a href="#" class="back-button" id="backToMain">← Назад</a>
    </div>
    <div id="requestFormPage">
         <div class="form-container">
            <h2 class="form-title">Создать заявку на работы</h2>
            <form id="requestForm">
                <div class="form-group"><label for="workType">Тип работ:</label><select id="workType" required></select></div>
                <div class="checkbox-group"><input type="checkbox" id="visitCheckbox"><label for="visitCheckbox">Нужен выезд мастера на адрес</label></div>
                <div class="form-group" id="addressField" style="display: none;"><label for="workAddress">Адрес выполнения работ:</label><input type="text" id="workAddress" placeholder="Укажите адрес"></div>
                <div class="form-group"><label for="requestDescription">Подробное описание задачи:</label><textarea id="requestDescription" placeholder="Опишите детали заказа..." required></textarea></div>
                <div class="form-group"><label for="requestPhotos">Фотографии (необязательно):</label><input type="file" id="requestPhotos" accept="image/*" multiple></div>
                <button type="submit" class="submit-button">ОТПРАВИТЬ ЗАЯВКУ</button>
                <a href="#" class="back-button" id="backToMainFromRequest">← Назад</a>
            </form>
        </div>
    </div>
    <div id="machineryFormPage">
        <div class="form-container">
            <h2 class="form-title">Заявка на аренду спецтехники</h2>
            <form id="machineryForm">
                <div class="form-group"><label for="machineryType">Тип спецтехники:</label><select id="machineryType" required></select></div>
                <div class="form-group"><label for="machineryAddress">Адрес подачи техники:</label><input type="text" id="machineryAddress" placeholder="Укажите адрес" required></div>
                <div class="checkbox-group"><input type="checkbox" id="minOrderCheckbox"><label for="minOrderCheckbox">Минимальный заказ (4 часа)</label></div>
                <div class="checkbox-group"><input type="checkbox" id="preorderCheckbox"><label for="preorderCheckbox">Предварительный заказ</label></div>
                <div id="preorderFields" style="display: none;">
                    <div class="form-group"><label for="preorderDate">Дата и время:</label><input type="datetime-local" id="preorderDate"></div>
                </div>
                <div class="form-group"><label for="machineryDescription">Описание задачи:</label><textarea id="machineryDescription" placeholder="Дополнительная информация..."></textarea></div>
                <div class="form-group"><label for="machineryPhotos">Фотографии (необязательно):</label><input type="file" id="machineryPhotos" accept="image/*" multiple></div>
                <button type="submit" class="submit-button">ОТПРАВИТЬ ЗАЯВКУ</button>
                <a href="#" class="back-button" id="backToMainFromMachinery">← Назад</a>
            </form>
        </div>
    </div>
    <div id="toolsFormPage">
         <div class="form-container">
            <h2 class="form-title">Заявка на аренду инструмента</h2>
            <form id="toolsForm">
                <div class="form-group">
                    <label for="toolsSelect">Какой инструмент нужен?</label>
                    <select id="toolsSelect"></select>
                    <button type="button" id="addToolBtn" class="profile-button" style="margin-top: 10px;">Добавить в список</button>
                </div>
                <div id="selectedToolsList" style="margin: 15px 0;"></div>
                <div class="form-group"><label for="rentStartDate">Дата начала аренды:</label><input type="date" id="rentStartDate" required></div>
                <div class="form-group"><label for="rentEndDate">Дата окончания аренды:</label><input type="date" id="rentEndDate" required></div>
                <div class="checkbox-group"><input type="checkbox" id="deliveryCheckbox"><label for="deliveryCheckbox">Нужна доставка</label></div>
                <div class="form-group" id="deliveryAddressField" style="display: none;"><label for="deliveryAddress">Адрес доставки:</label><input type="text" id="deliveryAddress" placeholder="Укажите адрес доставки"></div>
                <div class="form-group"><label for="toolsDescription">Дополнительная информация:</label><textarea id="toolsDescription" placeholder="Например, нужен ли оператор..."></textarea></div>
                <button type="submit" class="submit-button">ОТПРАВИТЬ ЗАЯВКУ</button>
                <a href="#" class="back-button" id="backToMainFromTools">← Назад</a>
            </form>
        </div>
    </div>
    <div id="takeOrderPage"><h2 class="orders-header">Доступные заявки</h2><div class="orders-list" id="ordersList"></div><a href="#" class="back-button" id="backToMainFromTakeOrder">← Назад</a></div>
    <div id="myRequestsPage"><h2 class="requests-header">Мои заявки</h2><div class="orders-list" id="userRequestsList"></div><a href="#" class="back-button" id="backToProfileFromRequests">← Назад в профиль</a></div>
    <div id="materialsFormPage">
         <div class="form-container">
            <h2 class="form-title">Продать материалы</h2>
            <form id="materialsForm">
                <div class="form-group">
                    <label for="materialsInput">Материал(ы):</label>
                    <input type="text" id="materialsInput" placeholder="Например: Кирпич, Цемент" required>
                </div>
                <div class="form-group">
                    <label for="materialsDescription">Описание (состояние, кол-во, цена):</label>
                    <textarea id="materialsDescription" placeholder="Осталось 100 кирпичей. Самовывоз." required></textarea>
                </div>
                <div class="form-group">
                    <label for="materialPrice">Цена:</label>
                    <input type="number" id="materialPrice" placeholder="Укажите цену" required>
                </div>
                <div class="form-group">
                    <label for="materialPhotos">Фотографии (необязательно):</label>
                    <input type="file" id="materialPhotos" accept="image/*" multiple>
                </div>
                <button type="submit" class="submit-button" id="submitMaterialButton">ОТПРАВИТЬ ОБЪЯВЛЕНИЕ</button>
                <a href="#" class="back-button" id="backToMainFromMaterials">← Назад</a>
            </form>
        </div>
    </div>
    <div id="marketplacePage"><h2 class="marketplace-header">Доска объявлений</h2><div class="orders-list" id="marketplacePostsList"></div><a href="#" class="back-button" id="backToMainFromMarketplace">← Назад</a></div>
    <div id="chatPage">
        <h2 class="requests-header">Чат с заказчиком</h2>
        <div class="form-container" style="padding: 10px; max-width: 400px; max-height: 70vh; overflow-y: auto;">
            <div id="chatMessages"></div>
            <div id="chatStatus"></div>
        </div>
        <form id="chatForm" class="form-container" style="padding: 10px; max-width: 400px;">
            <div class="form-group" style="margin-bottom: 0;"><textarea id="chatInput" placeholder="Введите сообщение..." style="resize: none;"></textarea></div>
            <button type="submit" class="submit-button" style="padding: 10px; width: auto; margin-left: 10px;">Отправить</button>
            <a href="#" class="back-button" id="backToRequests">← Назад к заявкам</a>
        </form>
    </div>
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 class="modal-title">Оплата подписки</h2>
            <form id="paymentForm">
                <div class="form-group">
                    <label for="cardNumber">Номер карты:</label>
                    <input type="text" id="cardNumber" placeholder="0000 0000 0000 0000" required>
                </div>
                <div class="form-group">
                    <label for="cardExpiry">Срок действия (ММ/ГГ):</label>
                    <input type="text" id="cardExpiry" placeholder="ММ/ГГ" required>
                </div>
                <div class="form-group">
                    <label for="cardCVC">CVC:</label>
                    <input type="text" id="cardCVC" placeholder="CVC" required>
                </div>
                <button type="submit" class="submit-button" id="payButton">ОПЛАТИТЬ</button>
            </form>
        </div>
    </div>
    <script>
    const API_URL = 'http://127.0.0.1:8000/api';
    const cityModal = document.getElementById('cityModal');
    const cityButtons = document.getElementById('cityButtons');
    const citySearch = document.getElementById('citySearch');
    const cityNameEl = document.getElementById('cityName');
    const buttonContainer = document.getElementById('buttonContainer');
    const navMasterBtn = document.getElementById('navMaster');
    const navCreateBtn = document.getElementById('navCreate');
    const navProfileBtn = document.getElementById('navProfile');
    const marketplaceBtn = document.getElementById('marketplaceButton');
    const masterButton = document.getElementById('masterButton');
    const machineryButton = document.getElementById('machineryButton');
    const toolsButton = document.getElementById('toolsButton');
    const sellMaterialsButton = document.getElementById('sellMaterialsButton');
    const profileButton = document.getElementById('profileButton');
    const authForm = document.getElementById('authForm');
    const registerForm = document.getElementById('registerForm');
    const requestForm = document.getElementById('requestForm');
    const machineryForm = document.getElementById('machineryForm');
    const toolsForm = document.getElementById('toolsForm');
    const materialsForm = document.getElementById('materialsForm');
    const profilePage = document.getElementById('profilePage');
    const myRequestsPage = document.getElementById('myRequestsPage');
    const marketplacePage = document.getElementById('marketplacePage');
    const ordersList = document.getElementById('ordersList');
    const machineryList = document.getElementById('machineryList');
    const toolsList = document.getElementById('toolsList');
    const materialsList = document.getElementById('materialsList');
    const myRequestsList = document.getElementById('myRequestsList');
    const workTypeSelect = document.getElementById('workType');
    const machineryTypeSelect = document.getElementById('machineryType');
    const toolTypeSelect = document.getElementById('toolType');
    const materialTypeSelect = document.getElementById('materialType');
    const subscriptionStatusEl = document.getElementById('subscriptionStatus');
    const subscriptionExpiryEl = document.getElementById('subscriptionExpiry');
    const subscriptionButton = document.getElementById('subscriptionButton');
    const profileType = document.getElementById('profileType');
    const profileName = document.getElementById('profileName');
    const profilePhone = document.getElementById('profilePhone');
    const profileCity = document.getElementById('profileCity');
    const profileSpecializationDisplay = document.getElementById('profileSpecializationDisplay');
    const profileSpecialization = document.getElementById('profileSpecialization');
    const profileSpecializationSelect = document.getElementById('profileSpecializationSelect');

    let allCities = [];
    let allSpecializations = [];
    let allWorkTypes = [];
    let allMachineryTypes = [];
    let allToolTypes = [];
    let allMaterialTypes = [];

    async function fetchData(endpoint, options = {}) {
        const token = localStorage.getItem('token');
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers,
        };
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        const response = await fetch(`${API_URL}/${endpoint}`, { ...options, headers });
        if (!response.ok) {
            throw new Error(`Ошибка API: ${response.statusText}`);
        }
        return response.json();
    }

    function showPage(pageId) {
        document.querySelectorAll('body > div').forEach(page => {
            if (page.id !== pageId) {
                page.style.display = 'none';
            }
        });
        document.getElementById(pageId).style.display = 'flex';
        document.querySelector('.navigation').style.display = ['authModal', 'registerModal', 'requestFormPage', 'machineryFormPage', 'toolsFormPage', 'materialsFormPage', 'takeOrderPage', 'myRequestsPage'].includes(pageId) ? 'none' : 'flex';
    }

    function getSelectedCity() {
        const cityId = localStorage.getItem('city_id');
        return allCities.find(c => c.id == cityId);
    }

    function saveSelectedCity(city) {
        localStorage.setItem('city_id', city.id);
        localStorage.setItem('city_name', city.name);
    }

    async function fetchCities() {
        try {
            allCities = await fetchData('cities');
            renderCityButtons();
        } catch (error) {
            console.error('Ошибка при загрузке городов:', error);
        }
    }

    function renderCityButtons() {
        cityButtons.innerHTML = '';
        const searchTerm = citySearch.value.toLowerCase();
        const filteredCities = allCities.filter(city => city.name.toLowerCase().includes(searchTerm));
        if (filteredCities.length === 0) {
            cityButtons.innerHTML = '<div class="no-orders">Города не найдены.</div>';
            return;
        }
        filteredCities.forEach(city => {
            const button = document.createElement('button');
            button.className = 'modal-button';
            button.textContent = city.name;
            button.addEventListener('click', () => {
                saveSelectedCity(city);
                cityNameEl.textContent = city.name;
                cityModal.classList.remove('active');
                checkAuthentication();
            });
            cityButtons.appendChild(button);
        });
    }

    async function fetchSpecializations() {
        try {
            allSpecializations = await fetchData('specializations');
            renderSpecializationSelect(document.getElementById('regSpecializationSelect'));
            renderSpecializationSelect(document.getElementById('profileSpecializationSelect'));
            renderSpecializationSelect(document.getElementById('workType'));
        } catch (error) {
            console.error('Ошибка при загрузке специализаций:', error);
        }
    }

    function renderSpecializationSelect(selectElement) {
        if (!selectElement) return;
        selectElement.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Выберите...';
        selectElement.appendChild(defaultOption);
        allSpecializations.forEach(spec => {
            const option = document.createElement('option');
            option.value = spec;
            option.textContent = spec;
            selectElement.appendChild(option);
        });
    }

    async function fetchMachineryTypes() {
        try {
            allMachineryTypes = await fetchData('machinery-types');
            machineryTypeSelect.innerHTML = '<option value="">Выберите...</option>';
            allMachineryTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                machineryTypeSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Ошибка при загрузке типов спецтехники:', error);
        }
    }

    async function fetchToolTypes() {
        try {
            allToolTypes = await fetchData('tool-types');
            toolTypeSelect.innerHTML = '<option value="">Выберите...</option>';
            allToolTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                toolTypeSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Ошибка при загрузке типов инструментов:', error);
        }
    }

    async function fetchMaterialTypes() {
        try {
            allMaterialTypes = await fetchData('material-types');
            materialTypeSelect.innerHTML = '<option value="">Выберите...</option>';
            allMaterialTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                materialTypeSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Ошибка при загрузке типов материалов:', error);
        }
    }

    async function fetchUserSubscription() {
        try {
            const subscription = await fetchData('subscriptions/me');
            return subscription;
        } catch (error) {
            console.error('Ошибка при загрузке подписки:', error);
            return null;
        }
    }

    function checkSubscription(subscription) {
        if (!subscription || !subscription.active || new Date(subscription.expiry) < new Date()) {
            subscriptionStatusEl.textContent = 'Не активна';
            subscriptionStatusEl.classList.remove('active');
            subscriptionExpiryEl.textContent = '-';
            subscriptionButton.textContent = 'Оформить подписку';
            subscriptionButton.disabled = false;
            return false;
        }
        subscriptionStatusEl.textContent = 'Активна';
        subscriptionStatusEl.classList.add('active');
        subscriptionExpiryEl.textContent = new Date(subscription.expiry).toLocaleDateString();
        subscriptionButton.textContent = 'Подписка активна';
        subscriptionButton.disabled = true;
        return true;
    }

    async function fetchAds(page, isMyRequests = false) {
        const city = getSelectedCity();
        if (!city) return;

        const container = isMyRequests ? myRequestsList : document.getElementById(page + 'List');
        container.innerHTML = '<div class="no-orders">Загрузка...</div>';
        
        let endpoint = page;
        if (page === 'work-requests' || page === 'machinery-requests') {
             endpoint = page;
        } else if (page === 'material-ads') {
            endpoint = 'materials';
        } else {
             endpoint = page;
        }

        let ads;
        try {
            ads = await fetchData(`${endpoint}?city_id=${city.id}`);
        } catch (error) {
            console.error(`Ошибка при загрузке ${page}:`, error);
            container.innerHTML = `<div class="no-orders">Не удалось загрузить данные.</div>`;
            return;
        }

        if (ads.length === 0) {
            container.innerHTML = `<div class="no-orders">Нет объявлений в вашем городе.</div>`;
            return;
        }

        container.innerHTML = '';
        ads.forEach(ad => {
            const card = document.createElement('div');
            card.className = page === 'marketplace' ? 'post-card' : (isMyRequests ? 'request-card' : 'order-card');
            
            let htmlContent = '';
            if (page === 'work-requests') {
                htmlContent += `<div><strong>Тип работы:</strong> ${ad.work_type}</div>`;
                htmlContent += `<div><strong>Описание:</strong> ${ad.description}</div>`;
                if (ad.needs_visit) {
                    htmlContent += `<div><strong>Нужен выезд мастера:</strong> Да</div>`;
                    htmlContent += ad.address ? `<div><strong>Адрес:</strong> ${ad.address}</div>` : '';
                }
            } else if (page === 'machinery-requests') {
                 htmlContent += `<div><strong>Тип техники:</strong> ${ad.machinery_type}</div>`;
                 htmlContent += `<div><strong>Адрес:</strong> ${ad.address}</div>`;
                 htmlContent += ad.description ? `<div><strong>Описание:</strong> ${ad.description}</div>` : '';
                 htmlContent += `<div><strong>Минимальный заказ:</strong> ${ad.is_min_order ? 'Да' : 'Нет'}</div>`;
                 htmlContent += `<div><strong>Предзаказ:</strong> ${ad.is_preorder ? 'Да' : 'Нет'}</div>`;
                 htmlContent += ad.preorder_date ? `<div><strong>Дата предзаказа:</strong> ${ad.preorder_date}</div>` : '';
            } else if (page === 'material-ads') {
                 htmlContent += `<div><strong>Тип материала:</strong> ${ad.material_type}</div>`;
                 htmlContent += `<div><strong>Цена:</strong> ${ad.price} руб.</div>`;
                 htmlContent += `<div><strong>Описание:</strong> ${ad.description}</div>`;
            } else if (page === 'tool-requests') {
                htmlContent += `<div><strong>Инструменты:</strong> ${ad.tools ? ad.tools.join(', ') : 'Не указаны'}</div>`;
                htmlContent += `<div><strong>Срок аренды:</strong> ${ad.start_date} - ${ad.end_date}</div>`;
                htmlContent += `<div><strong>Доставка:</strong> ${ad.needs_delivery ? 'Да' : 'Нет'}</div>`;
                htmlContent += ad.delivery_address ? `<div><strong>Адрес доставки:</strong> ${ad.delivery_address}</div>` : '';
                htmlContent += ad.description ? `<div><strong>Описание:</strong> ${ad.description}</div>` : '';
            }

            htmlContent += `<div class="post-date">Создано: ${new Date(ad.created_at).toLocaleString()}</div>`;

            if (!isMyRequests) {
                const isSubscriptionActive = checkSubscription(JSON.parse(localStorage.getItem('subscription')));
                if (isSubscriptionActive) {
                    htmlContent += `<button class="take-order-btn" onclick="takeOrder(${ad.id}, '${page}')">Взять заказ</button>`;
                } else {
                    htmlContent += `<div class="subscription-notice">Для просмотра контактов оформите подписку.</div>`;
                }
            }

            card.innerHTML = htmlContent;
            container.appendChild(card);
        });
    }

    async function checkAuthentication() {
        const token = localStorage.getItem('token');
        if (token) {
            try {
                const user = await fetchData('users/me');
                localStorage.setItem('user', JSON.stringify(user));
                showPage('buttonContainer');
                document.getElementById('navMaster').click();
                updateProfilePage();
                fetchUserSubscription().then(sub => {
                    localStorage.setItem('subscription', JSON.stringify(sub));
                    checkSubscription(sub);
                });
            } catch (error) {
                console.error('Ошибка аутентификации:', error);
                localStorage.removeItem('token');
                showPage('authModal');
            }
        } else {
            showPage('authModal');
        }
    }

    function updateProfilePage() {
        const user = JSON.parse(localStorage.getItem('user'));
        if (user) {
            profileType.textContent = user.user_type;
            profileName.textContent = user.user_name;
            profilePhone.textContent = user.username;
            profileCity.textContent = localStorage.getItem('city_name');

            if (user.user_type === 'ИСПОЛНИТЕЛЬ' || user.user_type === 'ВЛАДЕЛЕЦ СПЕЦТЕХНИКИ') {
                profileSpecializationDisplay.style.display = 'block';
                document.getElementById('specializationGroup').style.display = 'block';
                profileSpecialization.textContent = user.specialization || 'Не указана';
                document.getElementById('profileSpecializationSelect').value = user.specialization || '';
            } else {
                profileSpecializationDisplay.style.display = 'none';
                document.getElementById('specializationGroup').style.display = 'none';
            }
        }
    }

    navMasterBtn.addEventListener('click', () => { showPage('takeOrderPage'); fetchAds('work-requests'); });
    navCreateBtn.addEventListener('click', () => { showPage('buttonContainer'); });
    navProfileBtn.addEventListener('click', () => { showPage('profilePage'); });
    marketplaceBtn.addEventListener('click', () => { showPage('marketplacePage'); fetchAds('marketplace'); });
    masterButton.addEventListener('click', () => { showPage('requestFormPage'); });
    machineryButton.addEventListener('click', () => { showPage('machineryFormPage'); fetchMachineryTypes(); });
    toolsButton.addEventListener('click', () => { showPage('toolsFormPage'); fetchToolTypes(); });
    sellMaterialsButton.addEventListener('click', () => { showPage('materialsFormPage'); fetchMaterialTypes(); });
    profileButton.addEventListener('click', () => { showPage('profilePage'); });
    
    document.getElementById('changeCityButton').addEventListener('click', () => { cityModal.classList.add('active'); });
    document.querySelector('#cityModal .close-modal').addEventListener('click', () => { cityModal.classList.remove('active'); });
    citySearch.addEventListener('input', renderCityButtons);

    document.getElementById('switchToRegister').addEventListener('click', (e) => { e.preventDefault(); showPage('registerModal'); });
    document.getElementById('switchToLogin').addEventListener('click', (e) => { e.preventDefault(); showPage('authModal'); });

    authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('userPhone').value.replace(/[\s()-]/g, '');
        const password = document.getElementById('userPassword').value;
        try {
            const token = await fetchData('token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `grant_type=&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&scope=&client_id=&client_secret=`,
            });
            localStorage.setItem('token', token.access_token);
            checkAuthentication();
        } catch (error) {
            alert('Неверный логин или пароль');
            console.error('Ошибка авторизации:', error);
        }
    });

    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userType = document.getElementById('regUserType').value;
        const userName = document.getElementById('regUserName').value;
        const cityId = document.getElementById('regUserCity').value;
        const username = document.getElementById('regUserPhone').value.replace(/[\s()-]/g, '');
        const password = document.getElementById('regUserPassword').value;
        const specialization = userType === 'ИСПОЛНИТЕЛЬ' ? document.getElementById('regSpecializationSelect').value : null;

        if (userType === 'ИСПОЛНИТЕЛЬ' && !specialization) {
            alert('Пожалуйста, выберите вашу специализацию.');
            return;
        }

        try {
            const newUser = await fetchData('users/', {
                method: 'POST',
                body: JSON.stringify({
                    username: username,
                    password: password,
                    user_name: userName,
                    user_type: userType,
                    city_id: parseInt(cityId),
                    specialization: specialization
                }),
            });
            alert('Регистрация успешна!');
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('registerModal').style.display = 'none';
        } catch (error) {
            alert('Ошибка регистрации: ' + error.message);
        }
    });

    requestForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const city = getSelectedCity();
        if (!city) { alert('Город не выбран'); return; }

        const formData = {
            work_type: document.getElementById('workType').value,
            needs_visit: document.getElementById('visitCheckbox').checked,
            address: document.getElementById('visitCheckbox').checked ? document.getElementById('workAddress').value : null,
            description: document.getElementById('requestDescription').value,
            city_id: city.id,
        };

        try {
            await fetchData('work-requests', {
                method: 'POST',
                body: JSON.stringify(formData),
            });
            alert('Заявка на работу успешно создана!');
            requestForm.reset();
            showPage('buttonContainer');
        } catch (error) {
            alert('Ошибка создания заявки: ' + error.message);
        }
    });

    machineryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const city = getSelectedCity();
        if (!city) { alert('Город не выбран'); return; }

        const formData = {
            machinery_type: document.getElementById('machineryType').value,
            address: document.getElementById('machineryAddress').value,
            is_min_order: document.getElementById('minOrderCheckbox').checked,
            is_preorder: document.getElementById('preorderCheckbox').checked,
            preorder_date: document.getElementById('preorderCheckbox').checked ? document.getElementById('preorderDate').value : null,
            description: document.getElementById('machineryDescription').value,
            city_id: city.id,
        };

        try {
            await fetchData('machinery-requests', {
                method: 'POST',
                body: JSON.stringify(formData),
            });
            alert('Заявка на спецтехнику успешно создана!');
            machineryForm.reset();
            showPage('buttonContainer');
        } catch (error) {
            alert('Ошибка создания заявки: ' + error.message);
        }
    });

    toolsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const city = getSelectedCity();
        if (!city) { alert('Город не выбран'); return; }
        
        const selectedTools = Array.from(document.querySelectorAll('#selectedToolsList input')).map(input => input.value);
        if (selectedTools.length === 0) {
            alert('Выберите хотя бы один инструмент.');
            return;
        }

        const formData = {
            tools: selectedTools,
            start_date: document.getElementById('toolStartDate').value,
            end_date: document.getElementById('toolEndDate').value,
            needs_delivery: document.getElementById('deliveryCheckbox').checked,
            delivery_address: document.getElementById('deliveryCheckbox').checked ? document.getElementById('deliveryAddress').value : null,
            description: document.getElementById('toolDescription').value,
            city_id: city.id,
        };

        try {
            await fetchData('tool-requests', {
                method: 'POST',
                body: JSON.stringify(formData),
            });
            alert('Заявка на инструмент успешно создана!');
            toolsForm.reset();
            document.getElementById('selectedToolsList').innerHTML = '';
            showPage('buttonContainer');
        } catch (error) {
            alert('Ошибка создания заявки: ' + error.message);
        }
    });

    materialsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const city = getSelectedCity();
        if (!city) { alert('Город не выбран'); return; }
        
        const formData = {
            material_type: document.getElementById('materialType').value,
            description: document.getElementById('materialDescription').value,
            price: parseFloat(document.getElementById('materialPrice').value),
            city_id: city.id,
        };

        try {
            await fetchData('materials', {
                method: 'POST',
                body: JSON.stringify(formData),
            });
            alert('Объявление о материалах успешно создано!');
            materialsForm.reset();
            showPage('buttonContainer');
        } catch (error) {
            alert('Ошибка создания объявления: ' + error.message);
        }
    });

    document.getElementById('myRequestsButton').addEventListener('click', () => {
        showPage('myRequestsPage');
        fetchMyRequests();
    });

    async function fetchMyRequests() {
        const myRequestsList = document.getElementById('myRequestsList');
        myRequestsList.innerHTML = '<div class="no-orders">Загрузка...</div>';
        try {
            const user = JSON.parse(localStorage.getItem('user'));
            const requests = await fetchData(`requests/user/${user.id}`);
            if (requests.length === 0) {
                myRequestsList.innerHTML = '<div class="no-orders">У вас еще нет созданных заявок.</div>';
                return;
            }

            myRequestsList.innerHTML = '';
            requests.forEach(req => {
                const card = document.createElement('div');
                card.className = 'request-card';
                let htmlContent = '';
                if (req.work_type) {
                    htmlContent += `<strong>Тип работы:</strong> ${req.work_type}<br>`;
                    htmlContent += `<strong>Описание:</strong> ${req.description}<br>`;
                    htmlContent += `<strong>Нужен выезд:</strong> ${req.needs_visit ? 'Да' : 'Нет'}<br>`;
                    if (req.address) htmlContent += `<strong>Адрес:</strong> ${req.address}<br>`;
                } else if (req.machinery_type) {
                    htmlContent += `<strong>Тип техники:</strong> ${req.machinery_type}<br>`;
                    htmlContent += `<strong>Описание:</strong> ${req.description}<br>`;
                } else if (req.material_type) {
                    htmlContent += `<strong>Тип материала:</strong> ${req.material_type}<br>`;
                    htmlContent += `<strong>Описание:</strong> ${req.description}<br>`;
                    htmlContent += `<strong>Цена:</strong> ${req.price} руб.<br>`;
                } else if (req.tools) {
                    htmlContent += `<strong>Инструменты:</strong> ${req.tools.join(', ')}<br>`;
                    htmlContent += `<strong>Срок:</strong> ${req.start_date} - ${req.end_date}<br>`;
                    htmlContent += `<strong>Доставка:</strong> ${req.needs_delivery ? 'Да' : 'Нет'}<br>`;
                    if (req.delivery_address) htmlContent += `<strong>Адрес доставки:</strong> ${req.delivery_address}<br>`;
                }
                htmlContent += `<small>Создано: ${new Date(req.created_at).toLocaleString()}</small>`;
                card.innerHTML = htmlContent;
                myRequestsList.appendChild(card);
            });
        } catch (error) {
            console.error('Ошибка при загрузке моих заявок:', error);
            myRequestsList.innerHTML = `<div class="no-orders">Не удалось загрузить ваши заявки.</div>`;
        }
    }

    document.getElementById('visitCheckbox').addEventListener('change', (e) => {
        document.getElementById('addressField').style.display = e.target.checked ? 'block' : 'none';
    });

    document.getElementById('preorderCheckbox').addEventListener('change', (e) => {
        document.getElementById('preorderDateField').style.display = e.target.checked ? 'block' : 'none';
    });
    
    document.getElementById('deliveryCheckbox').addEventListener('change', (e) => {
        document.getElementById('deliveryAddressField').style.display = e.target.checked ? 'block' : 'none';
    });
    
    document.getElementById('addToolButton').addEventListener('click', () => {
        const selectedTool = document.getElementById('toolType').value;
        const selectedToolsList = document.getElementById('selectedToolsList');
        if (selectedTool && !Array.from(selectedToolsList.children).some(el => el.textContent.includes(selectedTool))) {
            const toolItem = document.createElement('div');
            toolItem.className = 'tool-item';
            toolItem.innerHTML = `<span>${selectedTool}</span><input type="hidden" value="${selectedTool}"><button type="button">Удалить</button>`;
            toolItem.querySelector('button').addEventListener('click', () => toolItem.remove());
            selectedToolsList.appendChild(toolItem);
        }
    });

    document.getElementById('regUserType').addEventListener('change', (e) => {
        const specializationGroup = document.getElementById('regSpecializationGroup');
        const regSpecializationSelect = document.getElementById('regSpecializationSelect');
        if (e.target.value === 'ИСПОЛНИТЕЛЬ') {
            specializationGroup.style.display = 'block';
            regSpecializationSelect.required = true;
        } else {
            specializationGroup.style.display = 'none';
            regSpecializationSelect.required = false;
        }
    });

    document.getElementById('saveSpecialization').addEventListener('click', async () => {
        const user = JSON.parse(localStorage.getItem('user'));
        const newSpecialization = document.getElementById('profileSpecializationSelect').value;
        if (!newSpecialization) {
            alert('Пожалуйста, выберите специализацию.');
            return;
        }
        try {
            await fetchData(`users/${user.id}/specialization`, {
                method: 'PUT',
                body: JSON.stringify({ specialization: newSpecialization }),
            });
            alert('Специализация успешно обновлена!');
            const updatedUser = await fetchData('users/me');
            localStorage.setItem('user', JSON.stringify(updatedUser));
            updateProfilePage();
        } catch (error) {
            alert('Ошибка обновления специализации: ' + error.message);
        }
    });

    document.getElementById('logoutButton').addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        localStorage.removeItem('subscription');
        showPage('authModal');
    });

    document.getElementById('subscriptionButton').addEventListener('click', async () => {
        try {
            const result = await fetchData('subscriptions/subscribe', { method: 'POST' });
            if (result.success) {
                alert('Подписка успешно оформлена!');
                fetchUserSubscription().then(sub => {
                    localStorage.setItem('subscription', JSON.stringify(sub));
                    checkSubscription(sub);
                });
            }
        } catch (error) {
            alert('Ошибка оформления подписки: ' + error.message);
        }
    });

    function getSelectedCityFromLocalStorage() {
        const cityId = localStorage.getItem('city_id');
        const cityName = localStorage.getItem('city_name');
        if (cityId && cityName) {
            return { id: parseInt(cityId), name: cityName };
        }
        return null;
    }

    document.getElementById('backToMainFromRequest').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
    document.getElementById('backToMainFromMachinery').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
    document.getElementById('backToMainFromTools').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
    document.getElementById('backToMainFromMaterials').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
    document.getElementById('backToMainFromTakeOrder').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
    document.getElementById('backToMainFromMarketplace').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
    document.getElementById('backToProfileFromRequests').addEventListener('click', (e) => { e.preventDefault(); showPage('profilePage'); });
    document.getElementById('backToMain').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });

    fetchCities();
    fetchSpecializations();
    fetchMachineryTypes();
    fetchToolTypes();
    fetchMaterialTypes();
    
    if (getSelectedCityFromLocalStorage()) {
        cityNameEl.textContent = getSelectedCityFromLocalStorage().name;
        checkAuthentication();
    } else {
        cityModal.classList.add('active');
    }
</script>
</body>
</html>