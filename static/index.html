<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СМЗ.РФ - Рабочие и спецтехника</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Новая палитра: Бежево-оранжевая тема */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; color: #4A4A4A; overflow-x: hidden; background: #F5F2EA; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .background-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; filter: brightness(0.8); }
        .selected-city { margin-top: 12px; font-size: 16px; color: #4A4A4A; display: flex; align-items: center; cursor: pointer; }
        .selected-city i { margin-right: 5px; color: #E76F51; }
        header { width: 100%; max-width: 600px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; background: #F5F2EA; z-index: 10; border-bottom: 1px solid #E0DBCF; }
        .logo { font-size: 24px; font-weight: 700; color: #E76F51; text-transform: uppercase; letter-spacing: 1px; }
        
        .main-content { padding: 20px; width: 100%; max-width: 600px; min-height: calc(100vh - 100px); /* С учетом хедера и кнопок */ }
        .page { display: none; padding-top: 20px; }
        .page.active { display: block; }
        
        /* Кнопки и формы */
        .btn-container { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
        button { padding: 15px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.1s; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #E76F51; color: white; }
        .btn-primary:hover { background-color: #E68A6E; transform: translateY(-1px); }
        .btn-secondary { background-color: #FFFFFF; color: #E76F51; border: 1px solid #E76F51; }
        .btn-secondary:hover { background-color: #F5F2EA; transform: translateY(-1px); }

        form { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; gap: 15px; }
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], select, textarea { 
            padding: 12px; border: 1px solid #E0DBCF; border-radius: 6px; font-size: 16px; width: 100%; 
        }
        input:focus, select:focus, textarea:focus { border-color: #E76F51; outline: none; box-shadow: 0 0 0 2px rgba(231, 111, 81, 0.2); }
        label { font-weight: 500; color: #4A4A4A; }
        .form-group { width: 100%; }

        /* Сообщения о статусе */
        .status-message { padding: 10px; border-radius: 6px; margin-top: 15px; font-weight: 600; text-align: center; display: none; }
        .status-success { background-color: #D4EDDA; color: #155724; }
        .status-error { background-color: #F8D7DA; color: #721C24; }
        
        /* Карточки объявлений */
        .card-list { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); border-left: 5px solid #E76F51; }
        .card h3 { color: #E76F51; margin-bottom: 5px; font-size: 18px; }
        .card p { font-size: 14px; color: #666; margin-bottom: 3px; }
        .card .details { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #E0DBCF; }
        .card .contact-button { margin-top: 10px; background-color: #2A9D8F; color: white; padding: 8px 12px; font-size: 14px; border-radius: 6px; display: inline-block; }
        
        /* Модальное окно города */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0;
            pointer-events: none; transition: opacity 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%; text-align: center; position: relative; }
        .city-select-container { margin-top: 20px; }
        .city-select-container select { padding: 12px; border-color: #E76F51; }

    </style>
</head>
<body>
    
    <header>
        <div class="logo">СМЗ.РФ</div>
        <div class="selected-city" id="citySelector">
            <i class="fas fa-map-marker-alt"></i>
            <span id="cityName">Выбрать город</span>
        </div>
        <button id="logoutButton" class="btn-secondary" style="display: none; padding: 10px 15px; font-size: 14px;" onclick="logout()">Выход</button>
    </header>

    <div class="main-content">
        
        <div id="cityModal" class="modal">
            <div class="modal-content">
                <h2>Выберите ваш город</h2>
                <p>Это необходимо для отображения релевантных заявок и объявлений.</p>
                <div class="city-select-container">
                    <select id="citySelect"></select>
                    <button class="btn-primary" style="margin-top: 15px;" onclick="selectCity()">Подтвердить</button>
                </div>
            </div>
        </div>

        <div id="buttonContainer" class="page">
            <h2>Добро пожаловать, <span id="userFullName"></span>!</h2>
            <div class="btn-container">
                <button class="btn-primary" onclick="showPage('findWorkPage')"><i class="fas fa-hammer"></i> Искать заявки на работу</button>
                <button class="btn-primary" onclick="showPage('machineryPage')"><i class="fas fa-truck-monster"></i> Аренда спецтехники</button>
                <button class="btn-primary" onclick="showPage('toolsPage')"><i class="fas fa-tools"></i> Аренда инструмента</button>
                <button class="btn-primary" onclick="showPage('materialsPage')"><i class="fas fa-box-open"></i> Продажа материалов</button>
                <hr style="width: 100%; margin: 10px 0; border: none; border-top: 1px solid #E0DBCF;">
                <button class="btn-secondary" onclick="showPage('myRequestsPage')"><i class="fas fa-list-alt"></i> Мои заявки/объявления</button>
                <button class="btn-secondary" onclick="showPage('profilePage')"><i class="fas fa-user-circle"></i> Мой профиль</button>
            </div>
        </div>
        
        <div id="loginPage" class="page active">
            <h2>Вход</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Пароль:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn-primary">Войти</button>
                <div id="loginStatus" class="status-message status-error"></div>
            </form>
            <p style="margin-top: 15px; text-align: center;">
                Нет аккаунта? <a href="#" onclick="showPage('registerPage')">Зарегистрироваться</a>
            </p>
        </div>
        
        <div id="registerPage" class="page">
            <h2>Регистрация</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="regEmail">Email:</label>
                    <input type="email" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">Пароль:</label>
                    <input type="password" id="regPassword" required>
                </div>
                <div class="form-group">
                    <label for="regFullName">Имя / Название компании:</label>
                    <input type="text" id="regFullName" required>
                </div>
                <div class="form-group">
                    <label for="regPhone">Телефон:</label>
                    <input type="text" id="regPhone" required>
                </div>
                <div class="form-group">
                    <label for="regRole">Роль:</label>
                    <select id="regRole" required>
                        <option value="ИСПОЛНИТЕЛЬ">Исполнитель / Частное лицо</option>
                        <option value="ЗАКАЗЧИК">Заказчик / Компания</option>
                    </select>
                </div>
                <div class="form-group specialization-group" style="display: none;">
                    <label for="regSpecialization">Специализация:</label>
                    <select id="regSpecialization"></select>
                </div>
                <div class="form-group">
                    <label for="regCity">Город:</label>
                    <select id="regCity"></select>
                </div>
                <button type="submit" class="btn-primary">Зарегистрироваться</button>
                <div id="registerStatus" class="status-message status-error"></div>
            </form>
            <p style="margin-top: 15px; text-align: center;">
                Уже есть аккаунт? <a href="#" onclick="showPage('loginPage')">Войти</a>
            </p>
        </div>
        
        <div id="findWorkPage" class="page">
            <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Заявки на работу в <span id="workCityName"></span></h2>
            <div class="card-list" id="workRequestsList">
                <p>Загрузка заявок...</p>
            </div>
        </div>

        <div id="createRequestPage" class="page">
            <button class="btn-secondary" onclick="showPage('myRequestsPage')"><i class="fas fa-arrow-left"></i> Назад к моим заявкам</button>
            <h2>Создать заявку на работу</h2>
            <form id="workRequestForm">
                <div class="form-group">
                    <label for="requestTitle">Заголовок:</label>
                    <input type="text" id="requestTitle" required>
                </div>
                <div class="form-group">
                    <label for="requestDescription">Описание:</label>
                    <textarea id="requestDescription" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label for="requestSpecialization">Специализация:</label>
                    <select id="requestSpecialization" required></select>
                </div>
                <div class="form-group">
                    <label for="requestBudget">Бюджет (руб., не обязательно):</label>
                    <input type="number" id="requestBudget">
                </div>
                <div class="form-group">
                    <label for="requestContact">Контакт (телефон или email):</label>
                    <input type="text" id="requestContact" required>
                </div>
                <button type="submit" class="btn-primary">Разместить заявку</button>
                <div id="requestStatus" class="status-message status-error"></div>
            </form>
        </div>

        <div id="myRequestsPage" class="page">
            <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Мои заявки и объявления</h2>
            <div class="btn-container" style="margin-top: 20px;">
                <button class="btn-primary" onclick="showPage('createRequestPage')">Создать заявку на работу</button>
            </div>
            <div class="card-list" id="myAdsList">
                <p>Загрузка ваших объявлений...</p>
            </div>
        </div>

        <div id="machineryPage" class="page">
            <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Аренда спецтехники в <span id="machineryCityName"></span></h2>
            <div class="btn-container" style="margin-top: 20px;">
                <button class="btn-primary" onclick="showPage('createMachineryPage')">Сдать в аренду технику</button>
            </div>
            <div class="card-list" id="machineryList">
                <p>Загрузка объявлений...</p>
            </div>
        </div>

        <div id="createMachineryPage" class="page">
            <button class="btn-secondary" onclick="showPage('machineryPage')"><i class="fas fa-arrow-left"></i> Назад к объявлениям</button>
            <h2>Разместить объявление о спецтехнике</h2>
            <form id="machineryAdForm">
                <div class="form-group">
                    <label for="machineryType">Тип техники:</label>
                    <select id="machineryType" required></select>
                </div>
                <div class="form-group">
                    <label for="machineryDescription">Описание:</label>
                    <textarea id="machineryDescription" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="machineryPrice">Цена аренды (руб/час):</label>
                    <input type="number" id="machineryPrice" required>
                </div>
                <div class="form-group">
                    <label for="machineryContact">Контакт:</label>
                    <input type="text" id="machineryContact" required>
                </div>
                <button type="submit" class="btn-primary">Разместить объявление</button>
                <div id="machineryAdStatus" class="status-message status-error"></div>
            </form>
        </div>

        <div id="toolsPage" class="page">
            <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Аренда инструмента в <span id="toolCityName"></span></h2>
            <div class="btn-container" style="margin-top: 20px;">
                <button class="btn-primary" onclick="showPage('createToolPage')">Сдать в аренду инструмент</button>
            </div>
            <div class="card-list" id="toolList">
                <p>Загрузка объявлений...</p>
            </div>
        </div>
        
        <div id="createToolPage" class="page">
            <button class="btn-secondary" onclick="showPage('toolsPage')"><i class="fas fa-arrow-left"></i> Назад к объявлениям</button>
            <h2>Разместить объявление об инструменте</h2>
            <form id="toolAdForm">
                <div class="form-group">
                    <label for="toolName">Название инструмента:</label>
                    <select id="toolName" required></select>
                </div>
                <div class="form-group">
                    <label for="toolDescription">Описание:</label>
                    <textarea id="toolDescription" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="toolCount">Количество:</label>
                    <input type="number" id="toolCount" value="1" min="1">
                </div>
                <div class="form-group">
                    <label for="toolPrice">Цена аренды (руб/день):</label>
                    <input type="number" id="toolPrice" required>
                </div>
                <div class="form-group">
                    <label for="toolContact">Контакт:</label>
                    <input type="text" id="toolContact" required>
                </div>
                <button type="submit" class="btn-primary">Разместить объявление</button>
                <div id="toolAdStatus" class="status-message status-error"></div>
            </form>
        </div>
        
        <div id="materialsPage" class="page">
            <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Продажа материалов в <span id="materialCityName"></span></h2>
            <div class="btn-container" style="margin-top: 20px;">
                <button class="btn-primary" onclick="showPage('createMaterialPage')">Продать материалы</button>
            </div>
            <div class="card-list" id="materialList">
                <p>Загрузка объявлений...</p>
            </div>
        </div>

        <div id="createMaterialPage" class="page">
            <button class="btn-secondary" onclick="showPage('materialsPage')"><i class="fas fa-arrow-left"></i> Назад к объявлениям</button>
            <h2>Разместить объявление о продаже материалов</h2>
            <form id="materialAdForm">
                <div class="form-group">
                    <label for="materialType">Тип материала:</label>
                    <select id="materialType" required></select>
                </div>
                <div class="form-group">
                    <label for="materialDescription">Описание:</label>
                    <textarea id="materialDescription" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="materialPrice">Цена (руб):</label>
                    <input type="number" id="materialPrice" required>
                </div>
                <div class="form-group">
                    <label for="materialContact">Контакт:</label>
                    <input type="text" id="materialContact" required>
                </div>
                <button type="submit" class="btn-primary">Разместить объявление</button>
                <div id="materialAdStatus" class="status-message status-error"></div>
            </form>
        </div>


        <div id="profilePage" class="page">
            <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Мой профиль</h2>
            <div id="profileInfo" class="card" style="border-left-color: #2A9D8F;">
                </div>
            <p style="margin-top: 20px;">Рейтинг: <span id="userRating">...</span> (<span id="userRatingCount">...</span> оценок)</p>
        </div>
        
    </div> <script>
        const API_URL = '/api';
        let accessToken = null;
        let currentUser = null;
        let selectedCityId = null;

        const cityModal = document.getElementById('cityModal');
        const cityNameEl = document.getElementById('cityName');
        const citySelectEl = document.getElementById('citySelect');
        const regCitySelectEl = document.getElementById('regCity');
        const loginPage = document.getElementById('loginPage');
        const specializationGroup = document.querySelector('.specialization-group');
        const regRoleSelect = document.getElementById('regRole');

        // --- Утилиты ---

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            
            // Сброс сообщений о статусе
            document.querySelectorAll('.status-message').forEach(msg => msg.style.display = 'none');

            // Обновление кнопок
            const isLoggedIn = !!localStorage.getItem('accessToken');
            document.getElementById('logoutButton').style.display = isLoggedIn ? 'block' : 'none';

            // Обновление данных при переключении
            if (pageId === 'findWorkPage' && selectedCityId) {
                fetchWorkRequests(selectedCityId);
            }
            if (pageId === 'machineryPage' && selectedCityId) {
                fetchMachineryRequests(selectedCityId);
            }
            if (pageId === 'toolsPage' && selectedCityId) {
                fetchToolRequests(selectedCityId);
            }
            if (pageId === 'materialsPage' && selectedCityId) {
                fetchMaterialAds(selectedCityId);
            }
            if (pageId === 'myRequestsPage' && currentUser) {
                fetchMyAds();
            }
            if (pageId === 'profilePage' && currentUser) {
                displayProfile();
            }
        }

        function getSelectedCity() {
            const cityData = localStorage.getItem('selectedCity');
            return cityData ? JSON.parse(cityData) : null;
        }

        function saveSelectedCity(city) {
            localStorage.setItem('selectedCity', JSON.stringify(city));
        }

        async function handleFormSubmit(formId, url, payload, statusId, onSuccess = null) {
            const statusEl = document.getElementById(statusId);
            statusEl.style.display = 'none';
            statusEl.classList.remove('status-error', 'status-success');

            const form = document.getElementById(formId);
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(accessToken && {'Authorization': `Bearer ${accessToken}`})
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    statusEl.textContent = 'Успешно!';
                    statusEl.classList.add('status-success');
                    form.reset();
                    if (onSuccess) onSuccess(data);
                } else {
                    statusEl.textContent = data.detail || `Ошибка: ${response.status} ${response.statusText}`;
                    statusEl.classList.add('status-error');
                }
            } catch (error) {
                console.error('Ошибка при отправке формы:', error);
                statusEl.textContent = 'Произошла ошибка сети.';
                statusEl.classList.add('status-error');
            } finally {
                statusEl.style.display = 'block';
                submitButton.disabled = false;
            }
        }

        async function apiRequest(url, config = {}) {
            config.headers = {
                ...config.headers,
                'Authorization': `Bearer ${accessToken}`
            };
            const response = await fetch(url, config);
            if (response.status === 401) {
                logout();
                throw new Error("Не авторизован");
            }
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Ошибка: ${response.status}`);
            }
            return response.json();
        }

        // --- Загрузка данных ---

        async function fetchCities() {
            try {
                // ИСПРАВЛЕНО: Добавлен замыкающий слэш (/)
                const response = await fetch(`${API_URL}/cities/`); 
                const cities = await response.json();
                
                // Заполнение выпадающих списков городов
                [citySelectEl, regCitySelectEl].forEach(select => {
                    select.innerHTML = '';
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.id;
                        option.textContent = city.name;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error("Ошибка загрузки городов:", error);
            }
        }

        // Функция для загрузки и заполнения справочников (специализации, техника, инструменты и т.д.)
        async function fetchAndPopulateSelect(endpoint, selectId) {
            try {
                // ИСПРАВЛЕНО: Добавлен замыкающий слэш (/)
                const response = await fetch(`${API_URL}/${endpoint}/`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const selectEl = document.getElementById(selectId);
                selectEl.innerHTML = '';
                
                // Добавляем пустую опцию для обязательных полей
                if (selectId === 'regSpecialization' || selectId === 'requestSpecialization') {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "Выберите специализацию";
                    selectEl.appendChild(defaultOption);
                }

                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.name; 
                    option.textContent = item.name;
                    selectEl.appendChild(option);
                });
                
            } catch (error) {
                console.error(`Ошибка загрузки ${endpoint}:`, error);
            }
        }
        
        async function fetchSpecializations() {
            // Загружаем специализации для формы регистрации и формы создания заявки
            await fetchAndPopulateSelect('specializations', 'regSpecialization');
            await fetchAndPopulateSelect('specializations', 'requestSpecialization');
        }

        async function fetchProfile() {
            try {
                currentUser = await apiRequest(`${API_URL}/users/me`);
                document.getElementById('userFullName').textContent = currentUser.first_name || 'Пользователь';
            } catch (error) {
                console.error("Ошибка загрузки профиля:", error);
                logout();
            }
        }

        // --- Управление городом ---

        function selectCity() {
            const selectedId = parseInt(citySelectEl.value);
            const selectedName = citySelectEl.options[citySelectEl.selectedIndex].textContent;

            saveSelectedCity({ id: selectedId, name: selectedName });
            cityNameEl.textContent = selectedName;
            selectedCityId = selectedId;
            
            // Обновляем названия городов на страницах
            document.getElementById('workCityName').textContent = selectedName;
            document.getElementById('machineryCityName').textContent = selectedName;
            document.getElementById('toolCityName').textContent = selectedName;
            document.getElementById('materialCityName').textContent = selectedName;
            
            cityModal.classList.remove('active');
            checkAuthentication();
        }

        document.getElementById('citySelector').addEventListener('click', () => {
            cityModal.classList.add('active');
        });
        
        // --- Логика отображения ---

        function displayProfile() {
            const infoEl = document.getElementById('profileInfo');
            const ratingEl = document.getElementById('userRating');
            const ratingCountEl = document.getElementById('userRatingCount');
            
            infoEl.innerHTML = `
                <h3>${currentUser.first_name}</h3>
                <p><strong>Email:</strong> ${currentUser.email}</p>
                <p><strong>Телефон:</strong> ${currentUser.phone_number}</p>
                <p><strong>Роль:</strong> ${currentUser.user_type}</p>
                ${currentUser.specialization ? `<p><strong>Специализация:</strong> ${currentUser.specialization}</p>` : ''}
                <p><strong>Премиум:</strong> ${currentUser.is_premium ? 'Да' : 'Нет'}</p>
            `;
            
            ratingEl.textContent = currentUser.rating ? currentUser.rating.toFixed(2) : 'Нет данных';
            ratingCountEl.textContent = currentUser.rating_count || 0;
        }

        function createRequestCard(request) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <h3>${request.name} <span style="font-size: 12px; color: ${request.is_taken ? '#E76F51' : '#2A9D8F'}; margin-left: 10px;">${request.is_taken ? 'В РАБОТЕ' : 'АКТИВНА'}</span></h3>
                <p>Специализация: <strong>${request.specialization}</strong></p>
                <p>Бюджет: <strong>${request.budget} руб.</strong></p>
                <p>Адрес: ${request.address || 'Не указан'}</p>
                <div class="details">
                    <p>${request.description}</p>
                    <p style="margin-top: 5px;">Контакт: <a href="tel:${request.phone_number}">${request.phone_number}</a></p>
                    <p style="font-size: 12px; margin-top: 5px; color: #999;">Создана: ${new Date(request.created_at).toLocaleDateString()}</p>
                </div>
            `;
            return card;
        }

        function createAdCard(ad) {
            const card = document.createElement('div');
            card.className = 'card';
            
            let title, details, contact;
            
            if (ad.type === 'work_request') {
                title = `Заявка: ${ad.name}`;
                details = `
                    <p>Специализация: <strong>${ad.specialization}</strong></p>
                    <p>Бюджет: <strong>${ad.budget} руб.</strong></p>
                    <p>Статус: <span style="color: ${ad.is_taken ? '#E76F51' : '#2A9D8F'}; font-weight: 600;">${ad.is_taken ? 'В РАБОТЕ' : 'АКТИВНА'}</span></p>
                    <p>${ad.description}</p>
                `;
                contact = `<p style="margin-top: 5px;">Контакт: ${ad.phone_number}</p>`;
            } else if (ad.type === 'machinery') {
                title = `Техника: ${ad.machinery_type}`;
                details = `
                    <p>Цена: <strong>${ad.rental_price} руб/час</strong></p>
                    <p>Мин. часов: ${ad.min_hours}</p>
                    <p>${ad.description}</p>
                `;
                contact = `<p style="margin-top: 5px;">Контакт: ${ad.contact_info}</p>`;
            } else if (ad.type === 'tool') {
                title = `Инструмент: ${ad.tool_name}`;
                details = `
                    <p>Цена: <strong>${ad.rental_price} руб/день</strong></p>
                    <p>Количество: ${ad.tool_count}</p>
                    <p>${ad.description}</p>
                `;
                contact = `<p style="margin-top: 5px;">Контакт: ${ad.contact_info}</p>`;
            } else if (ad.type === 'material') {
                title = `Материал: ${ad.material_type}`;
                details = `
                    <p>Цена: <strong>${ad.price} руб.</strong></p>
                    <p>${ad.description}</p>
                `;
                contact = `<p style="margin-top: 5px;">Контакт: ${ad.contact_info}</p>`;
            }

            card.innerHTML = `
                <h3>${title}</h3>
                <div class="details">
                    ${details}
                    ${contact}
                    <p style="font-size: 12px; margin-top: 5px; color: #999;">Создана: ${new Date(ad.created_at).toLocaleDateString()}</p>
                </div>
            `;
            return card;
        }

        function populateList(elementId, items, cardCreator) {
            const listEl = document.getElementById(elementId);
            listEl.innerHTML = '';
            if (items && items.length > 0) {
                items.forEach(item => {
                    listEl.appendChild(cardCreator(item));
                });
            } else {
                listEl.innerHTML = '<p style="text-align: center; color: #888;">Нет активных объявлений в этом городе.</p>';
            }
        }

        // --- Загрузка списков ---

        async function fetchWorkRequests(cityId) {
            try {
                const requests = await apiRequest(`${API_URL}/work_requests/by_city/${cityId}`);
                populateList('workRequestsList', requests, createRequestCard);
            } catch (error) {
                console.error("Ошибка загрузки заявок:", error);
                document.getElementById('workRequestsList').innerHTML = '<p style="color: red;">Не удалось загрузить заявки.</p>';
            }
        }
        
        async function fetchMachineryRequests(cityId) {
            try {
                const ads = await apiRequest(`${API_URL}/machinery_requests/by_city/${cityId}`);
                populateList('machineryList', ads, createAdCard);
            } catch (error) {
                console.error("Ошибка загрузки техники:", error);
                document.getElementById('machineryList').innerHTML = '<p style="color: red;">Не удалось загрузить объявления.</p>';
            }
        }

        async function fetchToolRequests(cityId) {
            try {
                const ads = await apiRequest(`${API_URL}/tool_requests/by_city/${cityId}`);
                populateList('toolList', ads, createAdCard);
            } catch (error) {
                console.error("Ошибка загрузки инструмента:", error);
                document.getElementById('toolList').innerHTML = '<p style="color: red;">Не удалось загрузить объявления.</p>';
            }
        }
        
        async function fetchMaterialAds(cityId) {
            try {
                const ads = await apiRequest(`${API_URL}/material_ads/by_city/${cityId}`);
                populateList('materialList', ads, createAdCard);
            } catch (error) {
                console.error("Ошибка загрузки материалов:", error);
                document.getElementById('materialList').innerHTML = '<p style="color: red;">Не удалось загрузить объявления.</p>';
            }
        }

        async function fetchMyAds() {
            try {
                const workRequests = await apiRequest(`${API_URL}/work_requests/my`);
                const allAds = await apiRequest(`${API_URL}/my_ads`);
                
                // Добавляем тип к заявкам на работу для унификации
                const workRequestAds = workRequests.map(req => ({ ...req, type: 'work_request' }));
                
                // Объединяем все объявления и заявки
                const combinedList = [...workRequestAds, ...allAds];
                
                // Сортируем по дате создания
                combinedList.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                populateList('myAdsList', combinedList, createAdCard);

            } catch (error) {
                console.error("Ошибка загрузки моих объявлений:", error);
                document.getElementById('myAdsList').innerHTML = '<p style="color: red;">Не удалось загрузить ваши объявления.</p>';
            }
        }

        // --- Обработчики форм ---

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = new URLSearchParams();
            payload.append('username', document.getElementById('loginEmail').value);
            payload.append('password', document.getElementById('loginPassword').value);
            
            const statusEl = document.getElementById('loginStatus');
            statusEl.style.display = 'none';

            try {
                const response = await fetch(`${API_URL}/token`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: payload.toString()
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('accessToken', data.access_token);
                    accessToken = data.access_token;
                    await fetchProfile();
                    showPage('buttonContainer');
                } else {
                    statusEl.textContent = data.detail || 'Неверный логин или пароль.';
                    statusEl.classList.add('status-error');
                    statusEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Ошибка входа:', error);
                statusEl.textContent = 'Ошибка сети.';
                statusEl.classList.add('status-error');
                statusEl.style.display = 'block';
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const role = document.getElementById('regRole').value;
            const specialization = role === 'ИСПОЛНИТЕЛЬ' ? document.getElementById('regSpecialization').value : null;

            const payload = {
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                // ИСПРАВЛЕНО: 'full_name' изменено на 'first_name'
                first_name: document.getElementById('regFullName').value, 
                // ИСПРАВЛЕНО: '|| null' удалено, т.к. поле теперь обязательно
                phone_number: document.getElementById('regPhone').value, 
                // ИСПРАВЛЕНО: 'user_role' изменено на 'user_type'
                user_type: role, 
                specialization: specialization,
                city_id: parseInt(document.getElementById('regCity').value)
            };

            await handleFormSubmit('registerForm', `${API_URL}/register`, payload, 'registerStatus', () => {
                showPage('loginPage');
            });
        });

        // Логика отображения специализации
        regRoleSelect.addEventListener('change', () => {
            specializationGroup.style.display = regRoleSelect.value === 'ИСПОЛНИТЕЛЬ' ? 'block' : 'none';
        });


        document.getElementById('workRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                name: document.getElementById('requestTitle').value,
                description: document.getElementById('requestDescription').value,
                specialization: document.getElementById('requestSpecialization').value,
                budget: parseFloat(document.getElementById('requestBudget').value) || 0,
                phone_number: document.getElementById('requestContact').value,
                city_id: selectedCityId
            };
            await handleFormSubmit('workRequestForm', `${API_URL}/work_requests`, payload, 'requestStatus', () => {
                showPage('myRequestsPage');
            });
        });
        
        document.getElementById('machineryAdForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                machinery_type: document.getElementById('machineryType').value,
                description: document.getElementById('machineryDescription').value,
                rental_price: parseFloat(document.getElementById('machineryPrice').value),
                contact_info: document.getElementById('machineryContact').value,
                city_id: selectedCityId,
            };
            await handleFormSubmit('machineryAdForm', `${API_URL}/machinery_requests`, payload, 'machineryAdStatus');
        });
        
        document.getElementById('toolAdForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                tool_name: document.getElementById('toolName').value,
                description: document.getElementById('toolDescription').value,
                rental_price: parseFloat(document.getElementById('toolPrice').value),
                tool_count: parseInt(document.getElementById('toolCount').value),
                rental_start_date: new Date().toISOString().split('T')[0], // Упрощенная логика даты
                rental_end_date: new Date().toISOString().split('T')[0],   // Упрощенная логика даты
                contact_info: document.getElementById('toolContact').value,
                city_id: selectedCityId,
                has_delivery: false,
                delivery_address: null
            };
            await handleFormSubmit('toolAdForm', `${API_URL}/tool_requests`, payload, 'toolAdStatus');
        });

        document.getElementById('materialAdForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                material_type: document.getElementById('materialType').value,
                description: document.getElementById('materialDescription').value,
                price: parseFloat(document.getElementById('materialPrice').value),
                contact_info: document.getElementById('materialContact').value,
                city_id: selectedCityId 
            };
            await handleFormSubmit('materialAdForm', `${API_URL}/material_ads`, payload, 'materialAdStatus');
        });


        function checkAuthentication() {
            accessToken = localStorage.getItem('accessToken');
            if (accessToken) {
                fetchProfile().then(() => showPage('buttonContainer'));
            } else {
                showPage('loginPage');
            }
        }

        function logout() {
            localStorage.removeItem('accessToken');
            accessToken = null;
            currentUser = null;
            showPage('loginPage');
        }

        // --- Initial Load ---

        document.addEventListener('DOMContentLoaded', () => {
            // ИСПРАВЛЕНО: Теперь вызываем все функции с замыкающим слэшем внутри них
            fetchCities();
            fetchSpecializations(); // Загружает 'regSpecialization' и 'requestSpecialization'
            fetchAndPopulateSelect('machinery_types', 'machineryType'); 
            // ИСПРАВЛЕНО: tools_list переименован в tool_types в database.py/main.py
            fetchAndPopulateSelect('tool_types', 'toolName'); 
            fetchAndPopulateSelect('material_types', 'materialType'); 
            
            const selectedCity = getSelectedCity();
            if (selectedCity) {
                cityNameEl.textContent = selectedCity.name;
                selectedCityId = selectedCity.id;
                
                // Обновляем названия городов
                document.getElementById('workCityName').textContent = selectedCity.name;
                document.getElementById('machineryCityName').textContent = selectedCity.name;
                document.getElementById('toolCityName').textContent = selectedCity.name;
                document.getElementById('materialCityName').textContent = selectedCity.name;

                checkAuthentication();
            } else {
                cityModal.classList.add('active'); // Показываем модальное окно выбора города
            }
        });
    </script>
</body>
</html>