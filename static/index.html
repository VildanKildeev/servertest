<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СМЗ.РФ - Рабочие и спецтехника</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Ваши стили */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; color: white; overflow: hidden; background: black; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .background-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; }
        .selected-city { margin-top: 12px; font-size: 16px; color: #fff; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; flex-wrap: wrap; }
        .city-name { text-decoration: underline; cursor: pointer; }
        .header { width: 100%; padding: 12px 10px 0 10px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; z-index: 10; background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0)); }
        .logo { font-size: 24px; font-weight: bold; color: #fff; }
        .profile-icon { font-size: 24px; color: #fff; cursor: pointer; }
        .back-icon { font-size: 20px; color: #fff; cursor: pointer; }
        .container { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; width: 100%; height: 100vh; padding: 60px 20px 20px 20px; box-sizing: border-box; position: relative; z-index: 1; overflow-y: auto; }
        .page { display: none; width: 100%; padding-bottom: 80px; }
        .page.active { display: flex; flex-direction: column; align-items: center; }
        .title { font-size: 24px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .button-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 400px; margin-top: 20px; }
        .button { background-color: #333; color: white; padding: 15px; border-radius: 12px; text-align: center; text-decoration: none; font-size: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid #555; transition: background-color 0.3s, border-color 0.3s; }
        .button:hover { background-color: #555; border-color: #888; }
        .button-icon { font-size: 30px; margin-bottom: 8px; }
        .login-form, .register-form, .request-form { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 12px; margin-top: 20px; }
        .login-form input, .register-form input, .request-form input, .request-form select, .request-form textarea { padding: 12px; border-radius: 8px; border: none; background: rgba(255, 255, 255, 0.2); color: white; font-size: 16px; }
        .login-form input::placeholder, .register-form input::placeholder, .request-form input::placeholder, .request-form textarea::placeholder { color: rgba(255, 255, 255, 0.6); }
        .login-form button, .register-form button, .request-form button, .profile-page button { padding: 12px; border-radius: 8px; border: none; background: #007bff; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        .login-form button:hover, .register-form button:hover, .request-form button:hover, .profile-page button:hover { background-color: #0056b3; }
        .message { margin-top: 10px; padding: 10px; border-radius: 8px; text-align: center; }
        .message.success { background-color: #28a745; }
        .message.error { background-color: #dc3545; }
        .profile-page h2 { margin-top: 20px; margin-bottom: 10px; text-align: center; }
        .profile-page p { margin-bottom: 8px; text-align: center; }
        .profile-page .info-block { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 12px; margin-top: 15px; }
        .profile-page .info-block p { text-align: left; }
        .logout-button { background-color: #6c757d; }
        .logout-button:hover { background-color: #5a6268; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: #1a1a1a; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 12px; display: flex; flex-direction: column; gap: 15px; }
        .modal-content h3 { text-align: center; color: white; margin-bottom: 10px; }
        .modal-content select { width: 100%; padding: 10px; border-radius: 8px; border: none; background: rgba(255, 255, 255, 0.2); color: white; font-size: 16px; }
        .modal-content select option { background: #1a1a1a; }
        .modal-content button { padding: 10px; border-radius: 8px; border: none; background: #007bff; color: white; font-size: 16px; font-weight: bold; cursor: pointer; }
        .modal-content button:hover { background-color: #0056b3; }
        .request-list, .ad-list { width: 100%; max-width: 600px; margin-top: 20px; }
        .request-item, .ad-item { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #555; }
        .request-item h4, .ad-item h4 { margin-top: 0; margin-bottom: 5px; font-size: 18px; }
        .request-item p, .ad-item p { margin: 0; font-size: 14px; color: rgba(255, 255, 255, 0.8); }
        .request-item .contact-info, .ad-item .contact-info { font-weight: bold; color: #007bff; }
        .request-item button, .ad-item button { margin-top: 10px; padding: 8px 12px; border-radius: 8px; border: none; background: #28a745; color: white; font-size: 14px; cursor: pointer; }
        .request-item button:hover, .ad-item button:hover { background-color: #218838; }
        .request-item .taken-by, .ad-item .taken-by { color: #fff; font-weight: bold; }
        .page-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-header .back-btn { font-size: 24px; color: #fff; text-decoration: none; }
        .subscription-info { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 12px; margin-top: 15px; text-align: center; }
        .subscription-info h3 { margin-top: 0; font-size: 18px; }
        .subscription-info .status.active { color: #28a745; font-weight: bold; }
        .subscription-info .status { color: #dc3545; font-weight: bold; }
        .subscription-info button { margin-top: 10px; padding: 10px 15px; border-radius: 8px; border: none; background: #007bff; color: white; font-size: 16px; cursor: pointer; }
        .subscription-info button:disabled { background: #555; cursor: not-allowed; }
        .take-order-page .request-list button { background-color: #007bff; }
        .take-order-page .request-list button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="background-video"></div>
    <div class="header" id="mainHeader">
        <a href="#" class="back-icon" id="backButton" style="display: none;"><i class="fas fa-arrow-left"></i></a>
        <div class="logo">СМЗ.РФ</div>
        <div class="selected-city">
            <i class="fas fa-map-marker-alt"></i>
            <span class="city-name" id="cityName">Выберите город</span>
        </div>
        <div class="profile-icon" id="profileIcon"><i class="fas fa-user"></i></div>
    </div>
    
    <div class="container">
        <div id="buttonContainer" class="page active">
            <div class="button-grid">
                <a href="#" class="button" id="workRequestsBtn">
                    <i class="fas fa-hard-hat button-icon"></i>
                    Рабочие
                </a>
                <a href="#" class="button" id="machineryRequestsBtn">
                    <i class="fas fa-tractor button-icon"></i>
                    Спецтехника
                </a>
                <a href="#" class="button" id="toolRequestsBtn">
                    <i class="fas fa-tools button-icon"></i>
                    Инструмент
                </a>
                <a href="#" class="button" id="materialAdsBtn">
                    <i class="fas fa-truck-moving button-icon"></i>
                    Материалы
                </a>
                <a href="#" class="button" id="takeOrderBtn">
                    <i class="fas fa-briefcase button-icon"></i>
                    Взять заказ
                </a>
                <a href="#" class="button" id="marketplaceBtn">
                    <i class="fas fa-store button-icon"></i>
                    Маркетплейс
                </a>
            </div>
        </div>
    
        <div id="loginPage" class="page">
            <h2 class="title">Вход</h2>
            <form id="loginForm" class="login-form">
                <input type="text" id="loginUsername" placeholder="Имя пользователя" required>
                <input type="password" id="loginPassword" placeholder="Пароль" required>
                <button type="submit">Войти</button>
                <p style="text-align: center; margin-top: 10px;"><a href="#" id="showRegisterBtn" style="color: #007bff;">Создать аккаунт</a></p>
                <p id="loginStatus" class="message"></p>
            </form>
        </div>
    
        <div id="registerPage" class="page">
            <h2 class="title">Регистрация</h2>
            <form id="registerForm" class="register-form">
                <input type="text" id="registerUsername" placeholder="Имя пользователя" required>
                <input type="password" id="registerPassword" placeholder="Пароль" required>
                <input type="text" id="registerName" placeholder="Ваше имя" required>
                <select id="registerUserType" required>
                    <option value="" disabled selected>Выберите тип пользователя</option>
                    <option value="ЗАКАЗЧИК">Заказчик</option>
                    <option value="ИСПОЛНИТЕЛЬ">Исполнитель</option>
                    <option value="ВЛАДЕЛЕЦ СПЕЦТЕХНИКИ">Владелец спецтехники</option>
                </select>
                <select id="registerSpecialization" style="display:none;"></select>
                <button type="submit">Зарегистрироваться</button>
                <p style="text-align: center; margin-top: 10px;"><a href="#" id="showLoginBtn" style="color: #007bff;">Уже есть аккаунт? Войти</a></p>
                <p id="registerStatus" class="message"></p>
            </form>
        </div>

        <div id="profilePage" class="page">
            <div class="page-header">
                <a href="#" class="back-btn" id="backToMainFromProfile"><i class="fas fa-arrow-left"></i></a>
                <h2 class="title" style="margin-top: 0; margin-bottom: 0;">Профиль</h2>
                <a href="#" style="visibility: hidden;"><i class="fas fa-arrow-left"></i></a>
            </div>
            
            <div class="info-block">
                <p><strong>Имя пользователя:</strong> <span id="profileUsername"></span></p>
                <p><strong>Имя:</strong> <span id="profileName"></span></p>
                <p><strong>Тип пользователя:</strong> <span id="profileUserType"></span></p>
                <p><strong>Город:</strong> <span id="profileCity"></span></p>
                <p id="profileSpecializationP" style="display:none;"><strong>Специализация:</strong> <span id="profileSpecialization"></span></p>
            </div>
            
            <div class="subscription-info">
                <h3>Подписка</h3>
                <p>Статус: <span id="subscriptionStatus">Не активна</span></p>
                <p>Действительна: <span id="subscriptionExpiry">-</span></p>
                <button id="subscriptionButton">Оформить подписку</button>
            </div>
            
            <button id="logoutButton" class="logout-button" style="margin-top: 20px;">Выйти</button>
            <button id="changePasswordButton" class="logout-button" style="margin-top: 10px;">Сменить пароль</button>

            <div id="passwordModal" class="modal">
                <div class="modal-content">
                    <h3>Смена пароля</h3>
                    <input type="password" id="oldPassword" placeholder="Старый пароль">
                    <input type="password" id="newPassword" placeholder="Новый пароль">
                    <input type="password" id="confirmNewPassword" placeholder="Подтвердите новый пароль">
                    <button id="saveNewPasswordButton">Сохранить</button>
                    <p id="passwordChangeStatus" class="message"></p>
                    <button onclick="document.getElementById('passwordModal').classList.remove('active');">Отмена</button>
                </div>
            </div>
            
        </div>
    
        <div id="workRequestsPage" class="page">
            <h2 class="title">Создать заявку на работу</h2>
            <form id="workRequestForm" class="request-form">
                <input type="text" id="workRequestTitle" placeholder="Заголовок" required>
                <select id="workRequestSpecialization" required></select>
                <textarea id="workRequestDescription" placeholder="Описание" rows="4" required></textarea>
                <input type="number" id="workRequestBudget" placeholder="Бюджет (необязательно)">
                <input type="text" id="workRequestContact" placeholder="Контактная информация" required>
                <button type="submit">Опубликовать</button>
                <p id="workRequestStatus" class="message"></p>
            </form>
        </div>

        <div id="machineryRequestsPage" class="page">
            <h2 class="title">Создать заявку на спецтехнику</h2>
            <form id="machineryRequestForm" class="request-form">
                <select id="machineryRequestType" required></select>
                <textarea id="machineryRequestDescription" placeholder="Описание (необязательно)" rows="4"></textarea>
                <input type="number" id="machineryRequestRate" placeholder="Цена за час (необязательно)">
                <input type="text" id="machineryRequestContact" placeholder="Контактная информация" required>
                <button type="submit">Опубликовать</button>
                <p id="machineryRequestStatus" class="message"></p>
            </form>
        </div>

        <div id="toolRequestsPage" class="page">
            <h2 class="title">Создать заявку на инструмент</h2>
            <form id="toolRequestForm" class="request-form">
                <select id="toolRequestType" required></select>
                <textarea id="toolRequestDescription" placeholder="Описание (необязательно)" rows="4"></textarea>
                <input type="number" id="toolRequestRentalPrice" placeholder="Стоимость аренды (необязательно)">
                <input type="text" id="toolRequestContact" placeholder="Контактная информация" required>
                <button type="submit">Опубликовать</button>
                <p id="toolRequestStatus" class="message"></p>
            </form>
        </div>
        
        <div id="materialAdsPage" class="page">
            <h2 class="title">Создать объявление о материалах</h2>
            <form id="materialAdForm" class="request-form">
                <select id="materialAdType" required></select>
                <textarea id="materialAdDescription" placeholder="Описание (необязательно)" rows="4"></textarea>
                <input type="number" id="materialAdPrice" placeholder="Цена (необязательно)">
                <input type="text" id="materialAdContact" placeholder="Контактная информация" required>
                <button type="submit">Опубликовать</button>
                <p id="materialAdStatus" class="message"></p>
            </form>
        </div>

        <div id="takeOrderPage" class="page take-order-page">
            <div class="page-header">
                <a href="#" class="back-btn" id="backToMainFromTakeOrder"><i class="fas fa-arrow-left"></i></a>
                <h2 class="title" style="margin-top: 0; margin-bottom: 0;">Взять заказ</h2>
                <a href="#" style="visibility: hidden;"><i class="fas fa-arrow-left"></i></a>
            </div>
            <p id="takeOrderStatus" class="message"></p>
            <div class="request-list" id="takeOrderList"></div>
        </div>

        <div id="marketplacePage" class="page">
            <div class="page-header">
                <a href="#" class="back-btn" id="backToMainFromMarketplace"><i class="fas fa-arrow-left"></i></a>
                <h2 class="title" style="margin-top: 0; margin-bottom: 0;">Маркетплейс</h2>
                <a href="#" style="visibility: hidden;"><i class="fas fa-arrow-left"></i></a>
            </div>
            <div class="ad-list" id="marketplaceList"></div>
        </div>
    </div>

    <div id="cityModal" class="modal">
        <div class="modal-content">
            <h3>Выберите свой город</h3>
            <select id="citySelect"></select>
            <button id="saveCityBtn">Сохранить</button>
        </div>
    </div>
    
    <script>
        const API_URL = window.location.origin + "/api";
        let accessToken = null;
        let selectedCityId = null;
        let lastSelectedRequestId = null;
        let profileData = null;
        let citiesData = [];
        let specializationsData = [];
        let machineryTypesData = [];
        let toolTypesData = [];
        let materialTypesData = [];
        
        const pages = document.querySelectorAll('.page');
        const cityModal = document.getElementById('cityModal');
        const cityNameEl = document.getElementById('cityName');
        const backButton = document.getElementById('backButton');
        const mainHeader = document.getElementById('mainHeader');

        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0, 0); // Прокрутка к началу страницы при переключении
            
            // Скрыть или показать кнопку "Назад"
            if (pageId === 'buttonContainer') {
                backButton.style.display = 'none';
            } else {
                backButton.style.display = 'block';
            }
        }
        
        function getSelectedCity() {
            const city = localStorage.getItem('selectedCity');
            return city ? JSON.parse(city) : null;
        }

        async function fetchCities() {
            try {
                const response = await fetch(`${API_URL}/cities`);
                if (!response.ok) throw new Error('Failed to fetch cities');
                citiesData = await response.json();
                const selectEl = document.getElementById('citySelect');
                selectEl.innerHTML = '';
                citiesData.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = city.name;
                    selectEl.appendChild(option);
                });
            } catch (error) {
                console.error(error);
            }
        }
        
        async function fetchSpecializations() {
            try {
                const response = await fetch(`${API_URL}/specializations`);
                if (!response.ok) throw new Error('Failed to fetch specializations');
                specializationsData = await response.json();
                const selectEl = document.getElementById('registerSpecialization');
                selectEl.innerHTML = '<option value="" disabled selected>Выберите специализацию</option>';
                specializationsData.forEach(spec => {
                    const option = document.createElement('option');
                    option.value = spec;
                    option.textContent = spec;
                    selectEl.appendChild(option);
                });
                const workRequestSelect = document.getElementById('workRequestSpecialization');
                workRequestSelect.innerHTML = '<option value="" disabled selected>Выберите специализацию</option>';
                specializationsData.forEach(spec => {
                    const option = document.createElement('option');
                    option.value = spec;
                    option.textContent = spec;
                    workRequestSelect.appendChild(option);
                });
            } catch (error) {
                console.error(error);
            }
        }
        
        async function fetchMachineryTypes() {
            try {
                const response = await fetch(`${API_URL}/machinery-types`);
                if (!response.ok) throw new Error('Failed to fetch machinery types');
                machineryTypesData = await response.json();
                const selectEl = document.getElementById('machineryRequestType');
                selectEl.innerHTML = '<option value="" disabled selected>Выберите тип техники</option>';
                machineryTypesData.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    selectEl.appendChild(option);
                });
            } catch (error) {
                console.error(error);
            }
        }
        
        async function fetchToolsList() {
            try {
                const response = await fetch(`${API_URL}/tool-types`);
                if (!response.ok) throw new Error('Failed to fetch tool types');
                toolTypesData = await response.json();
                const selectEl = document.getElementById('toolRequestType');
                selectEl.innerHTML = '<option value="" disabled selected>Выберите инструмент</option>';
                toolTypesData.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    selectEl.appendChild(option);
                });
            } catch (error) {
                console.error(error);
            }
        }
        
        async function fetchMaterialTypes() {
            try {
                const response = await fetch(`${API_URL}/material-types`);
                if (!response.ok) throw new Error('Failed to fetch material types');
                materialTypesData = await response.json();
                const selectEl = document.getElementById('materialAdType');
                selectEl.innerHTML = '<option value="" disabled selected>Выберите материал</option>';
                materialTypesData.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    selectEl.appendChild(option);
                });
            } catch (error) {
                console.error(error);
            }
        }

        async function login(username, password) {
            const response = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, user_name: '', user_type: '' })
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.detail || 'Ошибка входа');
            }
            return data;
        }

        async function register(user_data) {
            const response = await fetch(`${API_URL}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(user_data)
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.detail || 'Ошибка регистрации');
            }
            return data;
        }

        async function fetchProfile() {
            try {
                const response = await fetch(`${API_URL}/me`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!response.ok) throw new Error('Failed to fetch profile');
                profileData = await response.json();
                document.getElementById('profileUsername').textContent = profileData.username;
                document.getElementById('profileName').textContent = profileData.user_name;
                document.getElementById('profileUserType').textContent = profileData.user_type;
                
                const city = citiesData.find(c => c.id === profileData.city_id);
                document.getElementById('profileCity').textContent = city ? city.name : 'Не указан';
                
                if (profileData.specialization) {
                    document.getElementById('profileSpecializationP').style.display = 'block';
                    document.getElementById('profileSpecialization').textContent = profileData.specialization;
                } else {
                    document.getElementById('profileSpecializationP').style.display = 'none';
                }
                
                updateSubscriptionInfo();
                
            } catch (error) {
                console.error(error);
                localStorage.removeItem('accessToken');
                showPage('loginPage');
            }
        }
        
        async function showTakeOrderPage() {
            showPage('takeOrderPage');
            const takeOrderList = document.getElementById('takeOrderList');
            takeOrderList.innerHTML = '';
            
            try {
                const selectedCity = getSelectedCity();
                if (!selectedCity) {
                    throw new Error("Город не выбран.");
                }

                let url = `${API_URL}/work-requests?city_id=${selectedCity.id}`;
                if (profileData && profileData.user_type === "ИСПОЛНИТЕЛЬ" && profileData.specialization) {
                    url += `&specialization=${encodeURIComponent(profileData.specialization)}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch work requests');
                const requests = await response.json();
                
                if (requests.length === 0) {
                    takeOrderList.innerHTML = '<p style="text-align: center;">Нет доступных заказов в вашем городе.</p>';
                    return;
                }
                
                requests.forEach(request => {
                    const item = document.createElement('div');
                    item.className = 'request-item';
                    item.innerHTML = `
                        <h4>${request.title}</h4>
                        <p><strong>Специализация:</strong> ${request.specialization}</p>
                        <p><strong>Бюджет:</strong> ${request.budget || 'Не указан'}</p>
                        <p><strong>Описание:</strong> ${request.description}</p>
                        <p><strong>Город:</strong> ${citiesData.find(c => c.id === request.city_id)?.name || 'Неизвестен'}</p>
                        <p><strong>Контакты:</strong> <span class="contact-info">${request.contact_info}</span></p>
                        ${request.executor_id ? `<p class="taken-by">Принято исполнителем</p>` : `<button data-id="${request.id}">Взять заказ</button>`}
                    `;
                    takeOrderList.appendChild(item);
                });
                
                // Добавление обработчика событий для кнопок "Взять заказ"
                takeOrderList.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const requestId = e.target.dataset.id;
                        lastSelectedRequestId = requestId;
                        try {
                            const response = await fetch(`${API_URL}/work-requests/${requestId}/take`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${accessToken}` }
                            });
                            const data = await response.json();
                            if (response.ok) {
                                e.target.textContent = 'Заказ принят';
                                e.target.disabled = true;
                                const takenByP = document.createElement('p');
                                takenByP.className = 'taken-by';
                                takenByP.textContent = 'Принято вами';
                                e.target.parentNode.insertBefore(takenByP, e.target);
                            } else {
                                alert(`Ошибка: ${data.detail}`);
                            }
                        } catch (error) {
                            console.error(error);
                            alert('Произошла ошибка при попытке взять заказ.');
                        }
                    });
                });
                
            } catch (error) {
                console.error(error);
                document.getElementById('takeOrderStatus').textContent = `Ошибка: ${error.message}`;
                document.getElementById('takeOrderStatus').className = 'message error';
            }
        }
        
        async function showMarketplacePage() {
            showPage('marketplacePage');
            const marketplaceList = document.getElementById('marketplaceList');
            marketplaceList.innerHTML = '';
            
            try {
                const selectedCity = getSelectedCity();
                if (!selectedCity) {
                    throw new Error("Город не выбран.");
                }
                
                let url = `${API_URL}/material-ads?city_id=${selectedCity.id}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch material ads');
                const ads = await response.json();
                
                if (ads.length === 0) {
                    marketplaceList.innerHTML = '<p style="text-align: center;">Нет доступных объявлений о материалах в вашем городе.</p>';
                    return;
                }
                
                ads.forEach(ad => {
                    const item = document.createElement('div');
                    item.className = 'ad-item';
                    item.innerHTML = `
                        <h4>${ad.material_type}</h4>
                        <p><strong>Цена:</strong> ${ad.price || 'Не указана'}</p>
                        <p><strong>Описание:</strong> ${ad.description || 'Нет описания'}</p>
                        <p><strong>Город:</strong> ${citiesData.find(c => c.id === ad.city_id)?.name || 'Неизвестен'}</p>
                        <p><strong>Контакты:</strong> <span class="contact-info">${ad.contact_info}</span></p>
                    `;
                    marketplaceList.appendChild(item);
                });
                
            } catch (error) {
                console.error(error);
                marketplaceList.innerHTML = `<p style="text-align: center; color: red;">Ошибка: ${error.message}</p>`;
            }
        }

        document.getElementById('workRequestsBtn').addEventListener('click', () => {
            if (profileData.user_type !== 'ЗАКАЗЧИК' && profileData.user_type !== 'ИСПОЛНИТЕЛЬ') {
                alert('Только Заказчик или Исполнитель могут создавать заявки на работы.');
                return;
            }
            showPage('workRequestsPage');
            document.getElementById('workRequestStatus').textContent = '';
        });
        
        document.getElementById('machineryRequestsBtn').addEventListener('click', () => {
            if (profileData.user_type !== 'ЗАКАЗЧИК' && profileData.user_type !== 'ВЛАДЕЛЕЦ СПЕЦТЕХНИКИ') {
                alert('Только Заказчик или Владелец спецтехники могут создавать заявки на спецтехнику.');
                return;
            }
            showPage('machineryRequestsPage');
            document.getElementById('machineryRequestStatus').textContent = '';
        });
        
        document.getElementById('toolRequestsBtn').addEventListener('click', () => {
            if (profileData.user_type !== 'ЗАКАЗЧИК') {
                alert('Только Заказчик может создавать заявки на инструменты.');
                return;
            }
            showPage('toolRequestsPage');
            document.getElementById('toolRequestStatus').textContent = '';
        });
        
        document.getElementById('materialAdsBtn').addEventListener('click', () => {
            if (profileData.user_type !== 'ЗАКАЗЧИК' && profileData.user_type !== 'ИСПОЛНИТЕЛЬ') {
                alert('Только Заказчик или Исполнитель могут создавать объявления о материалах.');
                return;
            }
            showPage('materialAdsPage');
            document.getElementById('materialAdStatus').textContent = '';
        });
        
        document.getElementById('takeOrderBtn').addEventListener('click', () => {
            if (profileData.user_type !== 'ИСПОЛНИТЕЛЬ') {
                alert('Только Исполнитель может брать заказы.');
                return;
            }
            showTakeOrderPage();
        });
        
        document.getElementById('marketplaceBtn').addEventListener('click', showMarketplacePage);
        
        document.getElementById('profileIcon').addEventListener('click', () => {
            if (accessToken) {
                showPage('profilePage');
            } else {
                showPage('loginPage');
            }
        });
        
        document.getElementById('cityName').addEventListener('click', () => {
            cityModal.classList.add('active');
        });
        
        document.getElementById('saveCityBtn').addEventListener('click', () => {
            const selectEl = document.getElementById('citySelect');
            selectedCityId = selectEl.value;
            const selectedCityName = selectEl.options[selectEl.selectedIndex].textContent;
            
            localStorage.setItem('selectedCity', JSON.stringify({ id: selectedCityId, name: selectedCityName }));
            cityNameEl.textContent = selectedCityName;
            cityModal.classList.remove('active');
            
            checkAuthentication();
        });

        document.getElementById('showRegisterBtn').addEventListener('click', (e) => {
            e.preventDefault();
            showPage('registerPage');
            document.getElementById('registerStatus').textContent = '';
        });

        document.getElementById('showLoginBtn').addEventListener('click', (e) => {
            e.preventDefault();
            showPage('loginPage');
            document.getElementById('loginStatus').textContent = '';
        });
        
        document.getElementById('registerUserType').addEventListener('change', (e) => {
            const specializationSelect = document.getElementById('registerSpecialization');
            if (e.target.value === 'ИСПОЛНИТЕЛЬ') {
                specializationSelect.style.display = 'block';
            } else {
                specializationSelect.style.display = 'none';
            }
        });
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const statusEl = document.getElementById('loginStatus');
            try {
                const data = await login(username, password);
                accessToken = data.access_token;
                localStorage.setItem('accessToken', accessToken);
                statusEl.textContent = 'Вход выполнен!';
                statusEl.className = 'message success';
                await fetchProfile();
            } catch (error) {
                statusEl.textContent = error.message;
                statusEl.className = 'message error';
            }
        });
        
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const user_name = document.getElementById('registerName').value;
            const user_type = document.getElementById('registerUserType').value;
            const specialization = document.getElementById('registerSpecialization').value;
            const statusEl = document.getElementById('registerStatus');
            
            const selectedCity = getSelectedCity();
            if (!selectedCity) {
                statusEl.textContent = 'Пожалуйста, выберите город перед регистрацией.';
                statusEl.className = 'message error';
                return;
            }
            
            const userData = {
                username,
                password,
                user_name,
                user_type,
                city_id: selectedCity.id,
                specialization: user_type === 'ИСПОЛНИТЕЛЬ' ? specialization : null
            };
            
            try {
                await register(userData);
                statusEl.textContent = 'Регистрация прошла успешно!';
                statusEl.className = 'message success';
                setTimeout(() => showPage('loginPage'), 2000);
            } catch (error) {
                statusEl.textContent = error.message;
                statusEl.className = 'message error';
            }
        });

        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('selectedCity');
            accessToken = null;
            selectedCityId = null;
            profileData = null;
            cityNameEl.textContent = 'Выберите город';
            showPage('loginPage');
        });
        
        document.getElementById('workRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('workRequestTitle').value;
            const specialization = document.getElementById('workRequestSpecialization').value;
            const description = document.getElementById('workRequestDescription').value;
            const budget = document.getElementById('workRequestBudget').value;
            const contact_info = document.getElementById('workRequestContact').value;
            const statusEl = document.getElementById('workRequestStatus');
            const selectedCity = getSelectedCity();
            
            try {
                const response = await fetch(`${API_URL}/work-requests`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ 
                        title, 
                        specialization,
                        description,
                        budget: budget ? parseFloat(budget) : null,
                        contact_info,
                        city_id: selectedCity.id
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    statusEl.textContent = 'Заявка на работу успешно опубликована!';
                    statusEl.className = 'message success';
                    document.getElementById('workRequestForm').reset();
                } else {
                    statusEl.textContent = `Ошибка: ${data.detail}`;
                    statusEl.className = 'message error';
                }
            } catch (error) {
                statusEl.textContent = 'Произошла ошибка при отправке заявки.';
                statusEl.className = 'message error';
            }
        });
        
        document.getElementById('machineryRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const machinery_type = document.getElementById('machineryRequestType').value;
            const description = document.getElementById('machineryRequestDescription').value;
            const hourly_rate = document.getElementById('machineryRequestRate').value;
            const contact_info = document.getElementById('machineryRequestContact').value;
            const statusEl = document.getElementById('machineryRequestStatus');
            const selectedCity = getSelectedCity();
            
            try {
                const response = await fetch(`${API_URL}/machinery-requests`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ 
                        machinery_type, 
                        description,
                        hourly_rate: hourly_rate ? parseFloat(hourly_rate) : null,
                        contact_info,
                        city_id: selectedCity.id
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    statusEl.textContent = 'Заявка на спецтехнику успешно опубликована!';
                    statusEl.className = 'message success';
                    document.getElementById('machineryRequestForm').reset();
                } else {
                    statusEl.textContent = `Ошибка: ${data.detail}`;
                    statusEl.className = 'message error';
                }
            } catch (error) {
                statusEl.textContent = 'Произошла ошибка при отправке заявки.';
                statusEl.className = 'message error';
            }
        });
        
        document.getElementById('toolRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const tool_name = document.getElementById('toolRequestType').value;
            const description = document.getElementById('toolRequestDescription').value;
            const rental_price = document.getElementById('toolRequestRentalPrice').value;
            const contact_info = document.getElementById('toolRequestContact').value;
            const statusEl = document.getElementById('toolRequestStatus');
            const selectedCity = getSelectedCity();
            
            try {
                const response = await fetch(`${API_URL}/tool-requests`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ 
                        tool_name, 
                        description,
                        rental_price: rental_price ? parseFloat(rental_price) : null,
                        contact_info,
                        city_id: selectedCity.id
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    statusEl.textContent = 'Заявка на инструмент успешно опубликована!';
                    statusEl.className = 'message success';
                    document.getElementById('toolRequestForm').reset();
                } else {
                    statusEl.textContent = `Ошибка: ${data.detail}`;
                    statusEl.className = 'message error';
                }
            } catch (error) {
                statusEl.textContent = 'Произошла ошибка при отправке заявки.';
                statusEl.className = 'message error';
            }
        });
        
        document.getElementById('materialAdForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const material_type = document.getElementById('materialAdType').value;
            const description = document.getElementById('materialAdDescription').value;
            const price = document.getElementById('materialAdPrice').value;
            const contact_info = document.getElementById('materialAdContact').value;
            const statusEl = document.getElementById('materialAdStatus');
            const selectedCity = getSelectedCity();
            
            try {
                const response = await fetch(`${API_URL}/material-ads`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ 
                        material_type, 
                        description,
                        price: price ? parseFloat(price) : null,
                        contact_info,
                        city_id: selectedCity.id
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    statusEl.textContent = 'Объявление о материалах успешно опубликовано!';
                    statusEl.className = 'message success';
                    document.getElementById('materialAdForm').reset();
                } else {
                    statusEl.textContent = `Ошибка: ${data.detail}`;
                    statusEl.className = 'message error';
                }
            } catch (error) {
                statusEl.textContent = 'Произошла ошибка при отправке объявления.';
                statusEl.className = 'message error';
            }
        });
        
        document.getElementById('changePasswordButton').addEventListener('click', () => {
            document.getElementById('passwordModal').classList.add('active');
            document.getElementById('passwordChangeStatus').textContent = '';
        });
        
        document.getElementById('saveNewPasswordButton').addEventListener('click', async () => {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const statusEl = document.getElementById('passwordChangeStatus');
            
            if (newPassword !== confirmNewPassword) {
                statusEl.textContent = 'Новые пароли не совпадают.';
                statusEl.className = 'message error';
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/change-password`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    statusEl.textContent = 'Пароль успешно изменен!';
                    statusEl.className = 'message success';
                    // Сброс полей
                    document.getElementById('oldPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                } else {
                    statusEl.textContent = `Ошибка: ${data.detail}`;
                    statusEl.className = 'message error';
                }
            } catch (error) {
                statusEl.textContent = 'Произошла ошибка при смене пароля.';
                statusEl.className = 'message error';
            }
        });

        function checkAuthentication() {
            accessToken = localStorage.getItem('accessToken');
            if (accessToken) {
                fetchProfile();
                showPage('buttonContainer');
            } else {
                showPage('loginPage');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('backToMainFromRequest').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
            document.getElementById('backToMainFromMachinery').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
            document.getElementById('backToMainFromTools').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
            document.getElementById('backToMainFromMaterials').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
            document.getElementById('backToMainFromTakeOrder').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
            document.getElementById('backToMainFromMarketplace').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
            document.getElementById('backToProfileFromRequests').addEventListener('click', (e) => { e.preventDefault(); showPage('profilePage'); });
            document.getElementById('backToMain').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
            
            fetchCities();
            fetchSpecializations();
            fetchMachineryTypes();
            fetchToolsList();
            fetchMaterialTypes();
            
            if (getSelectedCity()) {
                cityNameEl.textContent = getSelectedCity().name;
                checkAuthentication();
            } else {
                cityModal.classList.add('active');
            }
        });   
    </script>
</body>
</html>