<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СМЗ.РФ - Рабочие и спецтехника</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Новая палитра: Бежево-оранжевая тема */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; color: #4A4A4A; overflow-x: hidden; background: #F5F2EA; -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 100vh; /* Убедимся, что футер будет внизу */ }
        .background-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; filter: brightness(0.8); }
        .selected-city { margin-top: 12px; font-size: 16px; color: #4A4A4A; display: flex; align-items: center; cursor: pointer; }
        .selected-city i { margin-right: 5px; color: #E76F51; }
        header { width: 100%; max-width: 600px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; background: #F5F2EA; z-index: 10; border-bottom: 1px solid #E0DBCF; }
        .logo { font-size: 24px; font-weight: 700; color: #E76F51; text-transform: uppercase; letter-spacing: 1px; }
        
        .main-content { padding: 20px; width: 100%; max-width: 600px; flex-grow: 1; /* Позволяет контенту занимать все доступное место */ }
        .page { display: none; padding-top: 20px; }
        .page.active { display: block; }
        
        /* Кнопки и формы */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; }
        .grid-item { display: flex; flex-direction: column; gap: 15px; }
        .btn-container-single { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
        
        button { padding: 15px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.1s; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #E76F51; color: white; }
        .btn-primary:hover { background-color: #E68A6E; transform: translateY(-1px); }
        .btn-secondary { background-color: #FFFFFF; color: #E76F51; border: 1px solid #E76F51; }
        .btn-secondary:hover { background-color: #F5F2EA; transform: translateY(-1px); }

        form { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; gap: 15px; }
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="datetime-local"], select, textarea { 
            padding: 12px; border: 1px solid #E0DBCF; border-radius: 6px; font-size: 16px; width: 100%; 
        }
        input:focus, select:focus, textarea:focus { border-color: #E76F51; outline: none; box-shadow: 0 0 0 2px rgba(231, 111, 81, 0.2); }
        label { font-weight: 500; color: #4A4A4A; }
        .form-group { width: 100%; }

        /* Сообщения о статусе */
        .status-message { padding: 10px; border-radius: 6px; margin-top: 15px; font-weight: 600; text-align: center; display: none; }
        .status-success { background-color: #D4EDDA; color: #155724; }
        .status-error { background-color: #F8D7DA; color: #721C24; }
        
        /* Карточки объявлений */
        .card-list { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); border-left: 5px solid #E76F51; }
        .card h3 { color: #E76F51; margin-bottom: 5px; font-size: 18px; }
        .card p { font-size: 14px; color: #666; margin-bottom: 3px; }
        .card .details { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #E0DBCF; }
        .card .contact-button { margin-top: 10px; background-color: #2A9D8F; color: white; padding: 8px 12px; font-size: 14px; border-radius: 6px; display: inline-block; border: none; }
        
        /* Модальное окно города */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0;
            pointer-events: none; transition: opacity 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%; text-align: center; position: relative; }
        .city-select-container { margin-top: 20px; }
        .city-select-container select { padding: 12px; border-color: #E76F51; }

        /* Футер */
        footer { width: 100%; background: #F5F2EA; border-top: 1px solid #E0DBCF; margin-top: auto; }
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: #ffffff; /* Белый фон для контраста */
    display: flex;
    justify-content: space-around; /* Равномерно распределить элементы */
    box-shadow: 0 -2px 5px rgba(0,0,0,0.08); /* Легкая тень сверху */
    z-index: 100;
    border-top: 1px solid #E0DBCF;
    padding: 5px 0;
}
.bottom-nav a {
    color: #4A4A4A;
    padding: 8px 12px;
    font-size: 12px;
    text-decoration: none; /* Убрать подчеркивание у ссылок */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px; /* Расстояние между иконкой и текстом */
    flex-grow: 1;
    transition: background-color 0.2s;
}
.bottom-nav a:hover {
    background-color: #F5F2EA; /* Легкий фон при наведении */
}
.bottom-nav a i {
    font-size: 22px;
    /* Используем другой цвет из палитры для контактов */
    color: #2A9D8F; 
}

/* ВАЖНО: Добавьте этот отступ для тега body, 
чтобы нижнее меню не перекрывало контент страницы.
*/
body {
    padding-bottom: 75px; /* Высота меню + небольшой запас */
}

    </style>
</head>
<body>
    
    <header>
        <div class="logo">СМЗ.РФ</div>
        <div class="selected-city" id="citySelector">
            <i class="fas fa-map-marker-alt"></i>
            <span id="cityName">Выбрать город</span>
        </div>
        <button id="logoutButton" class="btn-secondary" style="display: none; padding: 10px 15px; font-size: 14px;" onclick="logout()">Выход</button>
    </header>

    <div class="main-content">
        
        <div id="cityModal" class="modal">
            <div class="modal-content">
                <h2>Выберите ваш город</h2>
                <p>Это необходимо для отображения релевантных заявок и объявлений.</p>
                <div class="city-select-container">
                    <select id="citySelect"></select>
                    <button class="btn-primary" style="margin-top: 15px;" onclick="selectCity()">Подтвердить</button>
                </div>
            </div>
        </div>

        <div id="buttonContainer" class="page">
            <h2>Добро пожаловать, <span id="userFullName"></span>!</h2>
            
            <div class="grid-container">
                <div class="grid-item">
                    <button class="btn-primary" onclick="showPage('createRequestPage')"><i class="fas fa-file-invoice"></i> Создать заявку</button>
                    <button class="btn-primary" onclick="showPage('createMachineryAdPage')"><i class="fas fa-truck-monster"></i> Сдать спецтехнику</button>
                    <button class="btn-primary" onclick="showPage('createToolAdPage')"><i class="fas fa-tools"></i> Сдать инструмент</button>
                    <button class="btn-primary" onclick="showPage('createMaterialAdPage')"><i class="fas fa-box-open"></i> Продать материалы</button>
                </div>
                <div class="grid-item">
                    <button class="btn-primary" onclick="showPage('findWorkPage')"><i class="fas fa-search-dollar"></i> Искать заявки</button>
                    <button class="btn-primary" onclick="showPage('machineryPage')"><i class="fas fa-search"></i> Найти спецтехнику</button>
                    <button class="btn-primary" onclick="showPage('toolsPage')"><i class="fas fa-search"></i> Найти инструмент</button>
                    <button class="btn-primary" onclick="showPage('materialsPage')"><i class="fas fa-search"></i> Найти материалы</button>
                </div>
            </div>
            
            <div class="btn-container-single">
                <button class="btn-primary" style="background-color: #F4A261;" onclick="showPage('premiumPage')"><i class="fas fa-star"></i> PREMIUM ПОДПИСКА</button>
                <hr style="width: 100%; margin: 10px 0; border: none; border-top: 1px solid #E0DBCF;">
                <button class="btn-secondary" onclick="showPage('myRequestsPage')"><i class="fas fa-list-alt"></i> Мои заявки/объявления</button>
                <button class="btn-secondary" onclick="showPage('profilePage')"><i class="fas fa-user-circle"></i> Мой профиль</button>
            </div>
        </div>
        
        <div id="loginPage" class="page active">
            <h2>Вход</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Пароль:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn-primary">Войти</button>
                <div id="loginStatus" class="status-message status-error"></div>
            </form>
            <p style="margin-top: 15px; text-align: center;">
                Нет аккаунта? <a href="#" onclick="showPage('registerPage')">Зарегистрироваться</a>
            </p>
        </div>
        
        <div id="registerPage" class="page">
            <h2>Регистрация</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="regEmail">Email:</label>
                    <input type="email" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">Пароль:</label>
                    <input type="password" id="regPassword" required>
                </div>
                <div class="form-group">
                    <label for="regFirstName">Имя / Название компании (для профиля):</label>
                    <input type="text" id="regFirstName" required>
                </div>
                <div class="form-group">
                    <label for="regPhone">Телефон:</label>
                    <input type="text" id="regPhone" required>
                </div>
                <div class="form-group">
                    <label for="regRole">Роль:</label>
                    <select id="regRole" required>
                        <option value="worker">Исполнитель</option>
                        <option value="customer">Заказчик</option>
                    </select>
                </div>
                <div class="form-group specialization-group" style="display: none;">
                    <label for="regSpecialization">Специализация:</label>
                    <select id="regSpecialization"></select>
                </div>
                <div class="form-group">
                    <label for="regCity">Город:</label>
                    <select id="regCity"></select>
                </div>
                <button type="submit" class="btn-primary">Зарегистрироваться</button>
                <div id="registerStatus" class="status-message status-error"></div>
            </form>
            <p style="margin-top: 15px; text-align: center;">
                Уже есть аккаунт? <a href="#" onclick="showPage('loginPage')">Войти</a>
            </p>
        </div>
        
        <div id="premiumPage" class="page">
            <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>PREMIUM ПОДПИСКА ⭐</h2>
            <p style="margin-top: 10px;">Получите доступ к лучшим функциям и будьте первыми в результатах поиска!</p>
            <h3 style="margin-top: 20px;">Преимущества:</h3>
            <ul style="margin-left: 20px; margin-top: 10px; font-size: 14px;">
                <li>Ваши заявки всегда сверху (Work Requests, Ads)</li>
                <li>Значок Premium в профиле</li>
                <li>Ранний доступ к новым функциям</li>
            </ul>
            <div style="margin-top: 25px;">
                <button class="btn-primary" style="background-color: #F4A261;">Подключить Premium (999 руб/мес)</button>
            </div>
        </div>
        
        <div id="findWorkPage" class="page">
            <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Заявки на работу в <span id="workCityName"></span></h2>
            <div class="card-list" id="workRequestsList">
                <p>Загрузка заявок...</p>
            </div>
        </div>

        <div id="createRequestPage" class="page">
            <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Создать заявку на работу</h2>
            <form id="workRequestForm">
                <div class="form-group">
                    <label for="requestName">Заголовок (например, "Нужен электрик в новой квартире"):</label>
                    <input type="text" id="requestName" required>
                </div>
                <div class="form-group">
                    <label for="requestDescription">Подробное описание задачи:</label>
                    <textarea id="requestDescription" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label for="requestSpecialization">Специализация:</label>
                    <select id="requestSpecialization" required></select>
                </div>
                <div class="form-group">
                    <label for="requestBudget">Бюджет (руб., не обязательно):</label>
                    <input type="number" id="requestBudget">
                </div>
                <div class="form-group">
                    <label for="requestContact">Контактный телефон (для связи с вами):</label>
                    <input type="text" id="requestContact" required>
                </div>
                <div class="form-group">
                    <label for="requestAddress">Адрес объекта (полный адрес):</label>
                    <input type="text" id="requestAddress">
                </div>
                <div class="form-group">
                    <label for="requestVisitDate">Желаемая дата и время встречи (или начала работ):</label>
                    <input type="datetime-local" id="requestVisitDate">
                </div>
                
                <button type="submit" class="btn-primary">Разместить заявку</button>
                <div id="requestStatus" class="status-message status-error"></div>
            </form>
        </div>

        <div id="myRequestsPage" class="page">
            <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Мои заявки и объявления</h2>
            
            <h3 style="margin-top: 30px; color: #E76F51;">Мои заявки на работу (Заказчик/Исполнитель)</h3>
            <div class="card-list" id="myWorkRequestsList">
                <p>Загрузка...</p>
            </div>
            
            <h3 style="margin-top: 30px; color: #2A9D8F;">Мои объявления (Аренда/Продажа)</h3>
            <div class="card-list" id="myAdsList">
                <p>Загрузка...</p>
            </div>
        </div>

        <div 
<div id="machineryPage" class="page">
    <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
    <h2>Аренда спецтехники в <span id="machineryCityName"></span></h2>
    <button class="btn-primary" style="margin-bottom: 20px;" onclick="showPage('createMachineryAdPage')">Разместить объявление</button>
    <div class="card-list" id="machineryList">
        <p>Загрузка объявлений...</p>
    </div>
</div>
id="createMachineryAdPage" class="page">
    <button class="btn-secondary" onclick="showPage('machineryPage')"><i class="fas fa-arrow-left"></i> Назад</button>
    <h2>Объявление о спецтехнике</h2>
    <form id="machineryAdForm">
        <div class="form-group">
            <label for="machineryType">Тип техники:</label>
            <select id="machineryType" required></select>
        </div>
        <div class="form-group">
            <label for="machineryDescription">Описание:</label>
            <textarea id="machineryDescription" rows="3"></textarea>
        </div>
        <div class="form-group">
            <label for="machineryPrice">Цена аренды (в сутки):</label>
            <input type="number" id="machineryPrice" required>
        </div>
        
        <div class="form-group">
            <label for="machineryRentalDate">Дата начала аренды:</label>
            <input type="date" id="machineryRentalDate" required>
        </div>
        
        <div class="form-group">
            <label for="machineryHoursCount">Количество часов аренды:</label>
            <input type="number" id="machineryHoursCount" min="1" required>
        </div>

        <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="machineryMinHours" style="width: auto; margin: 0; transform: scale(1.4);">
            <label for="machineryMinHours" style="margin: 0; font-weight: normal;">Опционально: Минимальный заказ - 4 часа</label>
        </div>

        <div class="form-group">
            <label for="machineryDeliveryDate">Желаемая дата доставки (необязательно):</label>
            <input type="date" id="machineryDeliveryDate">
        </div>
        <div class="form-group">
            <label for="machineryContact">Контакт:</label>
            <input type="text" id="machineryContact" required>
        </div>
        <button type="submit" class="btn-primary">Разместить объявление</button>
        <div id="machineryAdStatus" class="status-message status-error"></div>
    </form>
</div>

        <div id="toolsPage" class="page">
            <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Аренда инструмента в <span id="toolCityName"></span></h2>
            <button class="btn-primary" style="margin-bottom: 20px;" onclick="showPage('createToolAdPage')">Разместить объявление</button>
            <div class="card-list" id="toolList">
                <p>Загрузка объявлений...</p>
            </div>
        </div>

        <div id="createToolAdPage" class="page">
            <button class="btn-secondary" onclick="showPage('toolsPage')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Объявление об инструменте</h2>
            <form id="toolAdForm">
                <div class="form-group">
                    <label for="toolName">Название инструмента:</label>
                    <select id="toolName" required></select>
                </div>
                <div class="form-group">
                    <label for="toolDescription">Описание:</label>
                    <textarea id="toolDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="toolCount">Количество:</label>
                    <input type="number" id="toolCount" value="1" min="1" required>
                </div>
                <div class="form-group">
                    <label for="toolPrice">Цена аренды (в сутки):</label>
                    <input type="number" id="toolPrice" required>
                </div>
                <div class="form-group">
                    <label for="toolContact">Контакт:</label>
                    <input type="text" id="toolContact" required>
                </div>
                <button type="submit" class="btn-primary">Разместить объявление</button>
                <div id="toolAdStatus" class="status-message status-error"></div>
            </form>
        </div>

        <div id="materialsPage" class="page">
            <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Продажа материалов в <span id="materialCityName"></span></h2>
            <button class="btn-primary" style="margin-bottom: 20px;" onclick="showPage('createMaterialAdPage')">Разместить объявление</button>
            <div class="card-list" id="materialList">
                <p>Загрузка объявлений...</p>
            </div>
        </div>

        <div id="createMaterialAdPage" class="page">
            <button class="btn-secondary" onclick="showPage('materialsPage')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Объявление о материалах</h2>
            <form id="materialAdForm">
                <div class="form-group">
                    <label for="materialType">Тип материала:</label>
                    <select id="materialType" required></select>
                </div>
                <div class="form-group">
                    <label for="materialDescription">Описание:</label>
                    <textarea id="materialDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="materialPrice">Цена:</label>
                    <input type="number" id="materialPrice" required>
                </div>
                <div class="form-group">
                    <label for="materialContact">Контакт:</label>
                    <input type="text" id="materialContact" required>
                </div>
                <button type="submit" class="btn-primary">Разместить объявление</button>
                <div id="materialAdStatus" class="status-message status-error"></div>
            </form>
        </div>

        <div id="profilePage" class="page">
            <button class="btn-secondary" onclick="showPage('buttonContainer')"><i class="fas fa-arrow-left"></i> Назад</button>
            <h2>Мой профиль</h2>
            <p>Email: <span id="profileEmail"></span></p>
            <p>Имя: <span id="profileFirstName"></span></p>
            <p>Телефон: <span id="profilePhone"></span></p>
            <p>Роль: <span id="profileRole"></span></p>
            <p>Специализация: <span id="profileSpecialization"></span></p>
            <p>Рейтинг: <span id="profileRating"></span> (<span id="profileReviewCount"></span> отзывов)</p>
            
            <h3 style="margin-top: 30px;">Обновить данные</h3>
            <form id="profileUpdateForm">
                <div class="form-group">
                    <label for="updateFirstName">Имя / Компания:</label>
                    <input type="text" id="updateFirstName" required>
                </div>
                <div class="form-group">
                    <label for="updatePhone">Телефон:</label>
                    <input type="text" id="updatePhone">
                </div>
                <div class="form-group">
                    <label for="updateSpecialization">Специализация:</label>
                    <select id="updateSpecialization"></select>
                </div>
                <button type="submit" class="btn-primary">Обновить профиль</button>
                <div id="profileStatus" class="status-message status-error"></div>
            </form>
        </div>
        
    </div>
    
    <footer>
        <div class="bottom-nav">
    <a href="https://t.me/your_telegram_contact" target="_blank">
        <i class="fab fa-telegram-plane"></i>
        <span>Telegram</span>
    </a>
    <a href="https://wa.me/your_whatsapp_number" target="_blank">
        <i class="fab fa-whatsapp"></i>
        <span>WhatsApp</span>
    </a>
    <a href="http://your-forum-url.com" target="_blank">
        <i class="fas fa-comments"></i>
        <span>Форум</span>
    </a>
</div>
    </footer>

    <script>
        const API_URL = '/api';
        let accessToken = null;
        let currentUser = null;
        let selectedCityId = null;
        const cityNameEl = document.getElementById('cityName');
        const cityModal = document.getElementById('cityModal');
        const citySelect = document.getElementById('citySelect');

        // --- Core Functions ---

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            
            // Скрыть/показать кнопку выхода
            document.getElementById('logoutButton').style.display = accessToken ? 'inline-block' : 'none';

            // Автоматическая загрузка данных для определенных страниц
            if (pageId === 'findWorkPage') fetchWorkRequests();
            if (pageId === 'myRequestsPage') fetchMyRequests();
            if (pageId === 'machineryPage') fetchMachineryAds(); 
            if (pageId === 'toolsPage') fetchToolAds(); 
            if (pageId === 'materialsPage') fetchMaterialAds(); 
            if (pageId === 'profilePage') populateProfileForm();
        }

        // --- City Selection Logic ---

        function getSelectedCity() {
            try {
                return JSON.parse(localStorage.getItem('selectedCity'));
            } catch (e) {
                return null;
            }
        }
        
        async function fetchCities() {
            try {
                const response = await fetch(`${API_URL}/cities/`);
                const cities = await response.json();
                citySelect.innerHTML = '<option value="">Выберите город</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = city.name;
                    citySelect.appendChild(option);
                });
                
                const selectedCity = getSelectedCity();
                if (selectedCity) {
                    citySelect.value = selectedCity.id;
                }

                // Добавляем города в формы регистрации/объявлений
                const citySelects = document.querySelectorAll('select[id$="City"]');
                citySelects.forEach(selectEl => {
                    selectEl.innerHTML = citySelect.innerHTML;
                    if (selectedCity) {
                        selectEl.value = selectedCity.id;
                    }
                });


            } catch (error) {
                console.error("Ошибка загрузки городов:", error);
            }
        }

        function selectCity() {
            const selectedOption = citySelect.options[citySelect.selectedIndex];
            if (selectedOption.value) {
                const city = {
                    id: parseInt(selectedOption.value),
                    name: selectedOption.textContent
                };
                localStorage.setItem('selectedCity', JSON.stringify(city));
                selectedCityId = city.id;
                cityNameEl.textContent = city.name;
                cityModal.classList.remove('active');
                
                // Обновляем названия городов на страницах
                document.getElementById('workCityName').textContent = city.name;
                document.getElementById('machineryCityName').textContent = city.name;
                document.getElementById('toolCityName').textContent = city.name;
                document.getElementById('materialCityName').textContent = city.name;
                
                checkAuthentication(); // Запускаем проверку аутентификации после выбора города
            } else {
                alert('Пожалуйста, выберите город.');
            }
        }

        document.getElementById('citySelector').addEventListener('click', () => {
            cityModal.classList.add('active');
        });

        // --- Utility Functions ---

        async function fetchAndPopulateSelect(endpoint, selectId) {
            try {
                const response = await fetch(`${API_URL}/${endpoint}/`);
                const data = await response.json();
                const selectEl = document.getElementById(selectId);
                selectEl.innerHTML = '<option value="">Выберите...</option>';
                data.forEach(item => {
                    // Используем item.name, как предполагается в структуре справочников
                    const option = document.createElement('option');
                    option.value = item.name;
                    option.textContent = item.name;
                    selectEl.appendChild(option);
                });
            } catch (error) {
                console.error(`Ошибка загрузки ${endpoint}:`, error);
            }
        }
        
        function displayStatus(elementId, message, isError = true) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        async function apiRequest(url, method = 'GET', payload = null) {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }

            const config = {
                method: method,
                headers: headers
            };

            if (payload && method !== 'GET') {
                config.body = JSON.stringify(payload);
            }

            const response = await fetch(url, config);
            const data = await response.json().catch(() => ({}));

            if (!response.ok) {
                const errorDetail = data.detail || `Ошибка: ${response.status}`;
                throw new Error(errorDetail);
            }

            return data;
        }

        async function handleFormSubmit(formId, url, payload, statusId, successCallback = null) {
            try {
                const result = await apiRequest(url, 'POST', payload);
                displayStatus(statusId, 'Успешно!', false);
                document.getElementById(formId).reset();
                if (successCallback) {
                    successCallback(result);
                }
            } catch (error) {
                displayStatus(statusId, error.message || 'Произошла ошибка.');
            }
        }

        // --- Authentication Logic ---

        function checkAuthentication() {
            accessToken = localStorage.getItem('accessToken');
            if (accessToken && selectedCityId) {
                fetchProfile().then(() => showPage('buttonContainer'));
            } else if (selectedCityId) {
                showPage('loginPage');
            }
        }

        async function fetchProfile() {
            try {
                currentUser = await apiRequest(`${API_URL}/users/me`); 
                // Используем first_name, как в схеме бэкенда
                document.getElementById('userFullName').textContent = currentUser.first_name || 'Пользователь';
            } catch (error) {
                console.error("Ошибка получения профиля, перенаправление на вход:", error);
                logout();
            }
        }

        function logout() {
            localStorage.removeItem('accessToken');
            accessToken = null;
            currentUser = null;
            showPage('loginPage');
        }

        // --- Event Listeners and Form Submission Handlers ---

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const formData = new URLSearchParams();
            formData.append('username', email);
            formData.append('password', password);

            try {
                const response = await fetch(`${API_URL}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Ошибка входа');
                }

                localStorage.setItem('accessToken', data.access_token);
                accessToken = data.access_token;
                displayStatus('loginStatus', 'Успешный вход!', false);
                await fetchProfile();
                showPage('buttonContainer');

            } catch (error) {
                displayStatus('loginStatus', error.message || 'Произошла ошибка входа.');
            }
        });
        
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const role = document.getElementById('regRole').value;
            const specialization = role === 'worker' ? document.getElementById('regSpecialization').value : null;

            const payload = {
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                first_name: document.getElementById('regFirstName').value, // Имя/Название компании
                phone_number: document.getElementById('regPhone').value || null,
                user_type: role === 'worker' ? 'ИСПОЛНИТЕЛЬ' : 'ЗАКАЗЧИК', // Преобразование в формат бэкенда
                specialization: specialization,
                city_id: parseInt(document.getElementById('regCity').value)
            };
            
            // Проверка обязательности телефона
            if (!payload.phone_number) {
                 displayStatus('registerStatus', 'Поле "Телефон" обязательно для заполнения.');
                 return;
            }

            await handleFormSubmit('registerForm', `${API_URL}/register`, payload, 'registerStatus', () => {
                showPage('loginPage');
            });
        });

        document.getElementById('regRole').addEventListener('change', (e) => {
            const group = document.querySelector('.specialization-group');
            if (e.target.value === 'worker') {
                group.style.display = 'block';
            } else {
                group.style.display = 'none';
            }
        });

        // --- Work Requests Logic ---

        async function fetchWorkRequests() {
            const listEl = document.getElementById('workRequestsList');
            if (!selectedCityId) {
                listEl.innerHTML = '<p>Пожалуйста, выберите город.</p>';
                return;
            }
            try {
                const requests = await apiRequest(`${API_URL}/work_requests/by_city/${selectedCityId}`);
                listEl.innerHTML = '';
                if (requests.length === 0) {
                    listEl.innerHTML = '<p>В этом городе пока нет открытых заявок.</p>';
                }
                
                requests.forEach(req => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    // Используем req.name, req.phone_number и т.д.
                    card.innerHTML = `
                        <h3>${req.name} <span style="float:right; font-size:12px; color:#999;">${new Date(req.created_at).toLocaleDateString()}</span></h3>
                        <p><strong>Специализация:</strong> ${req.specialization}</p>
                        <p><strong>Бюджет:</strong> ${req.budget ? req.budget + ' руб.' : 'Не указан'}</p>
                        <div class="details">
                            <p>Описание: ${req.description.substring(0, 100)}...</p>
                            <button class="contact-button" onclick="alert('Контакт: ${req.phone_number}')">Смотреть детали / Откликнуться</button>
                        </div>
                    `;
                    listEl.appendChild(card);
                });

            } catch (error) {
                listEl.innerHTML = `<p class="status-error">${error.message || 'Ошибка загрузки заявок.'}</p>`;
            }
        }
        
        document.getElementById('workRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // ОБНОВЛЕННЫЙ PAYLOAD с учетом новых полей и правильных имен
            const payload = {
                name: document.getElementById('requestName').value,
                description: document.getElementById('requestDescription').value,
                specialization: document.getElementById('requestSpecialization').value,
                budget: parseFloat(document.getElementById('requestBudget').value) || null,
                phone_number: document.getElementById('requestContact').value,
                city_id: selectedCityId,
                address: document.getElementById('requestAddress').value || null,
                visit_date: document.getElementById('requestVisitDate').value || null,
            };
            
            if (!payload.phone_number) {
                 displayStatus('requestStatus', 'Поле "Контактный телефон" обязательно.');
                 return;
            }
            
            await handleFormSubmit('workRequestForm', `${API_URL}/work_requests`, payload, 'requestStatus', () => {
                showPage('myRequestsPage');
            });
        });

        // --- My Requests/Ads Logic ---

        async function fetchMyRequests() {
            const workListEl = document.getElementById('myWorkRequestsList');
            const adsListEl = document.getElementById('myAdsList');
            workListEl.innerHTML = '<p>Загрузка...</p>';
            adsListEl.innerHTML = '<p>Загрузка...</p>';

            try {
                // 1. Мои заявки (как заказчик/исполнитель)
                const requests = await apiRequest(`${API_URL}/work_requests/my`);
                workListEl.innerHTML = '';
                if (requests.length === 0) {
                    workListEl.innerHTML = '<p>У вас нет созданных или выполняемых заявок.</p>';
                }
                requests.forEach(req => {
                    const statusText = req.is_taken ? 
                        (req.executor_id === currentUser.id ? 'В работе (Вы Исполнитель)' : 'Взята в работу') : 
                        'Открыта';
                    const isCompleted = req.status === 'completed'; // Предполагаем, что бэкенд может вернуть статус 'completed'
                    const isOwner = req.user_id === currentUser.id;
                    const canRate = isOwner && req.is_taken && !req.is_rated; // Логика кнопки рейтинга

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>${req.name} (${statusText})</h3>
                        <p>Специализация: ${req.specialization}</p>
                        <p>Бюджет: ${req.budget} руб.</p>
                        <div class="details">
                            <button class="contact-button" onclick="alert('Просмотр деталей для ${req.id}')">Детали</button>
                            ${canRate ? `<button class="btn-primary" style="margin-left: 10px; background-color: #F4A261;" onclick="showRatingModal(${req.id})">Оценить Исполнителя</button>` : ''}
                        </div>
                    `;
                    workListEl.appendChild(card);
                });
                
                // 2. Мои объявления (аренда/продажа)
                const myAds = await apiRequest(`${API_URL}/my_ads`); // Используем универсальный эндпоинт
                adsListEl.innerHTML = '';
                if (myAds.length === 0) {
                    adsListEl.innerHTML = '<p>У вас нет активных объявлений.</p>';
                } else {
                    myAds.forEach(ad => {
                         const type = ad.type === 'machinery' ? 'Спецтехника' : (ad.type === 'tool' ? 'Инструмент' : 'Материалы');
                         const title = ad.machinery_type || ad.tool_name || ad.material_type || ad.name;
                         const price = ad.rental_price || ad.price;
                         
                         const card = document.createElement('div');
                         card.className = 'card';
                         card.innerHTML = `
                             <h3>[${type}] ${title}</h3>
                             <p>Цена: ${price} руб.</p>
                             <div class="details">
                                 <p>Контакт: ${ad.contact_info}</p>
                             </div>
                         `;
                         adsListEl.appendChild(card);
                    });
                }


            } catch (error) {
                workListEl.innerHTML = adsListEl.innerHTML = `<p class="status-error">${error.message || 'Ошибка загрузки.'}</p>`;
            }
        }
        
        // ЛОГИКА ОЦЕНКИ
        function showRatingModal(requestId) {
             const rating = prompt(`Оцените исполнителя по заявке #${requestId} (от 1 до 5):`);
             const ratingValue = parseInt(rating);
             
             if (ratingValue >= 1 && ratingValue <= 5) {
                rateExecutor(requestId, ratingValue);
             } else if (rating !== null) {
                alert('Пожалуйста, введите число от 1 до 5.');
             }
        }

        async function rateExecutor(requestId, rating) {
            try {
                // Бэкенд ожидает rating_value, а не просто rating
                await apiRequest(`${API_URL}/work_requests/${requestId}/rate`, 'POST', { rating_value: rating }); 
                alert('Рейтинг успешно выставлен!');
                fetchMyRequests(); // Обновить список
            } catch (error) {
                alert(`Ошибка оценки: ${error.message}`);
            }
        }
        
        // --- Profile Logic ---
        
        function populateProfileForm() {
            if (!currentUser) return;
            
            // Используем first_name, как в схеме бэкенда
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileFirstName').textContent = currentUser.first_name; 
            document.getElementById('profilePhone').textContent = currentUser.phone_number || 'Не указан';
            document.getElementById('profileRole').textContent = currentUser.user_type; // user_type вместо user_role
            document.getElementById('profileSpecialization').textContent = currentUser.specialization || 'Не указана';
            document.getElementById('profileRating').textContent = currentUser.rating ? currentUser.rating.toFixed(2) : 'Нет';
            document.getElementById('profileReviewCount').textContent = currentUser.rating_count || 0; // rating_count вместо review_count
            
            // Форма обновления
            document.getElementById('updateFirstName').value = currentUser.first_name;
            document.getElementById('updatePhone').value = currentUser.phone_number || '';
            
            // Заполнить список специализаций и выбрать текущую
            fetchAndPopulateSelect('specializations', 'updateSpecialization').then(() => {
                if (currentUser.specialization) {
                    document.getElementById('updateSpecialization').value = currentUser.specialization;
                }
            });
        }
        
        document.getElementById('profileUpdateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                first_name: document.getElementById('updateFirstName').value,
                phone_number: document.getElementById('updatePhone').value || null,
                specialization: document.getElementById('updateSpecialization').value || null
            };
            
            // NOTE: Предполагаем, что бэкенд имеет PUT/PATCH /users/me endpoint
            try {
                await apiRequest(`${API_URL}/users/me`, 'PUT', payload); 
                await fetchProfile(); // Обновить данные в currentUser
                displayStatus('profileStatus', 'Профиль успешно обновлен!', false);
                populateProfileForm(); // Обновить отображение
            } catch (error) {
                displayStatus('profileStatus', error.message || 'Ошибка обновления профиля.');
            }
        });

        // --- Ads Pages Logic (Machinery, Tools, Materials) ---
        async function fetchMachineryAds() { 
            const listEl = document.getElementById('machineryList');
            // ... Реализация загрузки объявлений спецтехники ...
            listEl.innerHTML = '<p>Реализация загрузки спецтехники...</p>';
        }
        async function fetchToolAds() { 
            const listEl = document.getElementById('toolList');
            // ... Реализация загрузки объявлений инструмента ...
            listEl.innerHTML = '<p>Реализация загрузки инструмента...</p>';
        }
        async function fetchMaterialAds() { 
            const listEl = document.getElementById('materialList');
            // ... Реализация загрузки объявлений материалов ...
            listEl.innerHTML = '<p>Реализация загрузки материалов...</p>';
        }


        document.getElementById('machineryAdForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                machinery_type: document.getElementById('machineryType').value,
                description: document.getElementById('machineryDescription').value,
                rental_price: parseFloat(document.getElementById('machineryPrice').value),
                contact_info: document.getElementById('machineryContact').value,
                city_id: selectedCityId,
                // Новые поля
                rental_date: document.getElementById('machineryRentalDate').value,
                min_hours_4: document.getElementById('machineryMinHours').checked,
                hours_count: parseInt(document.getElementById('machineryHoursCount').value)
            };
            await handleFormSubmit('machineryAdForm', `${API_URL}/machinery_requests/`, payload, 'machineryAdStatus', () => {
                showPage('machineryPage');
            });
        });
        
        document.getElementById('toolAdForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                tool_name: document.getElementById('toolName').value,
                description: document.getElementById('toolDescription').value,
                rental_price: parseFloat(document.getElementById('toolPrice').value),
                contact_info: document.getElementById('toolContact').value,
                city_id: selectedCityId,
                // Новые поля
                rental_start_date: document.getElementById('toolRentalStartDate').value,
                rental_end_date: document.getElementById('toolRentalEndDate').value,
                has_delivery: document.getElementById('toolHasDelivery').checked,
                delivery_address: document.getElementById('toolDeliveryAddress').value || null
            };
            await handleFormSubmit('toolAdForm', `${API_URL}/tool_requests/`, payload, 'toolAdStatus', () => {
                showPage('toolsPage');
            });
        });
        
document.getElementById('toolHasDelivery').addEventListener('change', function() {
            const addressGroup = document.getElementById('toolDeliveryAddressGroup');
            if (this.checked) {
                addressGroup.style.display = 'block';
            } else {
                addressGroup.style.display = 'none';
            }
        });
        document.getElementById('materialAdForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                material_type: document.getElementById('materialType').value,
                description: document.getElementById('materialDescription').value,
                price: parseFloat(document.getElementById('materialPrice').value),
                contact_info: document.getElementById('materialContact').value,
                city_id: selectedCityId
            };
            await handleFormSubmit('materialAdForm', `${API_URL}/material_ads`, payload, 'materialAdStatus', () => {
                showPage('materialsPage');
            });
        });


        // --- Initial Load ---

        document.addEventListener('DOMContentLoaded', () => {
            fetchCities();
            // ОБНОВЛЕННЫЕ ЭНДПОИНТЫ СПРАВОЧНИКОВ:
            fetchAndPopulateSelect('specializations', 'regSpecialization');
            fetchAndPopulateSelect('specializations', 'requestSpecialization');
            fetchAndPopulateSelect('machinery_types', 'machineryType');
            fetchAndPopulateSelect('tool_types', 'toolName'); // tool_types вместо tools_list
            fetchAndPopulateSelect('material_types', 'materialType');
            
            const selectedCity = getSelectedCity();
            if (selectedCity) {
                cityNameEl.textContent = selectedCity.name;
                selectedCityId = selectedCity.id;
                
                document.getElementById('workCityName').textContent = selectedCity.name;
                document.getElementById('machineryCityName').textContent = selectedCity.name;
                document.getElementById('toolCityName').textContent = selectedCity.name;
                document.getElementById('materialCityName').textContent = selectedCity.name;

                checkAuthentication();
            } else {
                cityModal.classList.add('active'); // Показываем модальное окно выбора города
            }
        });
    </script>
</body>
</html>