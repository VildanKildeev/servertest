<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СМЗ.РФ - Рабочие и спецтехника</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Ваши стили */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; color: white; overflow: hidden; background: black; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .background-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; }
        .selected-city { margin-top: 12px; font-size: 16px; color: #fff; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; flex-wrap: wrap; }
        #changeCityButton { background: none; border: none; color: white; font-weight: bold; text-decoration: underline; cursor: pointer; font-size: 14px; padding: 6px 10px; border-radius: 6px; }
        .grid-container { margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 12px; width: 90%; max-width: 400px; z-index: 10; }
        .grid-row { display: flex; width: 100%; gap: 12px; }
        .tile-btn { flex: 1; color: #333; background: #e0d6c8; border: 2px solid #c0b0a0; padding: 16px 8px; font-size: 15px; font-weight: bold; border-radius: 16px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); text-align: center; position: relative; overflow: hidden; min-height: 80px; display: flex; flex-direction: column; justify-content: center; text-shadow: none; }
        .tile-btn::after { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.1); border-radius: 16px; z-index: 0; pointer-events: none; }
        .tile-btn span { position: relative; z-index: 1; display: block; }
        .tile-btn small { font-size: 12px; opacity: 0.9; margin-top: 4px; }
        .tile-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4); }
        .navigation { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(216, 201, 183, 0.95); display: flex; justify-content: space-around; padding: 12px 0; z-index: 50; backdrop-filter: blur(10px); border-top: 1px solid #c0b0a0; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; background: none; border: none; cursor: pointer; padding: 8px 16px; border-radius: 12px; transition: all 0.2s ease; background: #f5f0e6; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); }
        .nav-btn span { font-size: 13px; color: #5a4a3a; }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); background: #e8dccf; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: none; justify-content: center; align-items: center; z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal.active { display: flex; opacity: 1; pointer-events: all; }
        .modal-content { background: #d8c9b7; border: 2px solid #c0b0a0; border-radius: 16px; padding: 20px; width: 90%; max-width: 420px; text-align: center; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; align-items: center; position: relative; overflow: hidden; transform: scale(0.9); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: #333; max-height: 90vh; overflow-y: auto; }
        .modal.active .modal-content { transform: scale(1); opacity: 1; }
        .modal-title { font-size: 20px; margin-bottom: 16px; color: #5a4a3a; text-align: center; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
        .search-container { width: 90%; position: relative; margin-bottom: 12px; }
        .search-container input { width: 100%; padding: 10px 10px 10px 36px; border: 1px solid #c0b0a0; border-radius: 8px; font-size: 15px; background: #e8dccf; color: #333; outline: none; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #7d6b59; font-size: 16px; pointer-events: none; }
        .modal-buttons { display: flex; flex-direction: column; gap: 12px; width: 100%; align-items: center; margin-top: 10px; }
        .modal-button { color: #5a4a3a; border: 2px solid #5a4a3a; padding: 14px; font-size: 16px; font-weight: bold; border-radius: 10px; cursor: pointer; background: #f5f0e6; width: 90%; max-width: 300px; margin: 8px 0; transition: all 0.3s ease; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
        .modal-button:hover { background: #e0d6c8; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4); }
        .close-modal { position: absolute; top: 12px; right: 12px; font-size: 24px; color: #5a4a3a; cursor: pointer; background: none; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); }
        #authModal, #registerModal, #profilePage, #requestFormPage, #takeOrderPage, #myRequestsPage, #machineryFormPage, #toolsFormPage, #chatPage, #marketplacePage, #materialsFormPage { display: none; flex-direction: column; align-items: center; width: 100%; height: 100vh; background: #d8c9b7; position: fixed; top: 0; left: 0; z-index: 200; padding: 20px 16px; overflow-y: auto; color: #333; }
        #buttonContainer { display: none; }
        .auth-header { font-size: 24px; color: #5a4a3a; text-align: center; margin-bottom: 20px; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); }
        .form-container { background: #e8dccf; border: 1px solid #c0b0a0; border-radius: 12px; padding: 20px; width: 90%; max-width: 500px; margin: 0 auto; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .form-group { width: 100%; margin-bottom: 16px; text-align: left; }
        .form-group label { display: block; margin-bottom: 6px; color: #7d6b59; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #c0b0a0; border-radius: 8px; background: #e8dccf; color: #333; font-size: 16px; }
        .auth-button { background: #4caf50; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; margin-top: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .profile-header { font-size: 20px; color: #5a4a3a; text-align: center; margin-bottom: 20px; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); }
        .profile-card { background: #e8dccf; border: 1px solid #c0b0a0; border-radius: 12px; padding: 16px; width: 90%; max-width: 400px; margin-bottom: 16px; color: #333; text-align: left; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .profile-card strong { color: #7d6b59; }
        .profile-button { background: #4caf50; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 90%; max-width: 400px; margin-top: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .logout-button { background: #f44336; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 90%; max-width: 400px; margin-top: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .subscription-info { background: #e8dccf; border: 1px solid #c0b0a0; border-radius: 12px; padding: 16px; width: 90%; max-width: 400px; margin-bottom: 16px; color: #333; text-align: left; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .subscription-info h3 { color: #5a4a3a; margin-bottom: 12px; text-align: center; }
        .subscription-status { font-weight: bold; color: #d4380d; }
        .subscription-status.active { color: #4caf50; }
        .subscription-button { background: #4caf50; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; margin-top: 10px; transition: background-color 0.3s; }
        .subscription-button:disabled { background-color: #a5d6a7; cursor: not-allowed; }
        .form-title { text-align: center; color: #5a4a3a; margin-bottom: 20px; font-size: 20px; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .checkbox-group input[type="checkbox"] { width: auto; }
        .submit-button { background: #4caf50; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; margin-top: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .back-button { margin-top: 20px; color: #7d6b59; font-size: 15px; text-decoration: underline; cursor: pointer; display: block; text-align: center; }
        .orders-header, .requests-header, .marketplace-header { text-align: center; color: #5a4a3a; margin-bottom: 20px; font-size: 20px; }
        .orders-list { width: 90%; max-width: 500px; margin: 0 auto; }
        .order-card, .request-card, .post-card { background: #e8dccf; border: 1px solid #c0b0a0; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: #333; }
        .order-card strong, .request-card strong, .post-card strong { color: #5a4a3a; display: block; margin-bottom: 8px; font-size: 16px; }
        .order-card div, .request-card div, .post-card div { margin-bottom: 4px; font-size: 14px; color: #333; word-wrap: break-word; }
        .order-card div small, .request-card div small, .post-card div small { color: #7d6b59; }
        .order-card .subscription-notice { margin-top: 8px; padding: 8px; background-color: #f5e4cc; border-radius: 6px; font-size: 13px; color: #8c6c46; border: 1px dashed #c0b0a0; }
        .take-order-btn { background: #4caf50; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; width: 100%; margin-top: 10px; }
        .no-orders { text-align: center; color: #7d6b59; padding: 20px; }
        .post-card .post-date { font-size: 12px; color: #7d6b59; text-align: right; margin-top: 10px; border-top: 1px solid #c0b0a0; padding-top: 8px; }
        .tool-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #e8dccf; border: 1px solid #c0b0a0; border-radius: 8px; margin-bottom: 10px; }
        .tool-item button { background: #d4380d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <video autoplay muted loop class="background-video">
        <source src="https://telegram.org/file/8111409990/10b37f3868/240978" type="video/mp4">
        Ваш браузер не поддерживает видео.
    </video>
    <div class="selected-city">
        <span>Город: <span id="cityName">Не выбран</span></span>
        <button id="changeCityButton">Изменить</button>
    </div>
    <div class="grid-container" id="buttonContainer">
        <div class="grid-row">
            <button type="button" class="tile-btn" id="masterButton"><span>НАЙТИ МАСТЕРА</span><small>создать заявку</small></button>
            <button type="button" class="tile-btn" id="machineryButton"><span>АРЕНДА ТЕХНИКИ</span><small>создать заявку</small></button>
        </div>
        <div class="grid-row">
            <button type="button" class="tile-btn" id="toolsButton"><span>АРЕНДА ИНСТРУМЕНТА</span><small>создать заявку</small></button>
            <button type="button" class="tile-btn" id="sellMaterialsButton"><span>ПРОДАТЬ МАТЕРИАЛЫ</span><small>разместить объявление</small></button>
        </div>
        <div class="grid-row">
            <button type="button" class="tile-btn" id="marketplaceButton"><span>ДОСКА ОБЪЯВЛЕНИЙ</span><small>купить/продать</small></button>
            <button type="button" class="tile-btn" id="profileButton"><span>ЛИЧНЫЙ КАБИНЕТ</span><small>профиль и заявки</small></button>
        </div>
    </div>
    <div class="navigation">
        <button class="nav-btn" id="navMaster"><i class="fas fa-hammer"></i><span>Заказы</span></button>
        <button class="nav-btn" id="navCreate"><i class="fas fa-plus-circle"></i><span>Создать</span></button>
        <button class="nav-btn" id="navProfile"><i class="fas fa-user"></i><span>Профиль</span></button>
        <button class="nav-btn" id="navSubscription"><i class="fas fa-crown"></i><span>Подписка</span></button>
    </div>
    
    <div class="modal" id="cityModal"><div class="modal-content"><button class="close-modal">&times;</button><h2 class="modal-title">Выберите ваш город</h2><div class="search-container"><i class="fas fa-search search-icon"></i><input type="text" id="citySearch" placeholder="Поиск..."></div><div class="modal-buttons" id="cityButtons"></div></div></div>

    <div id="authModal"><h2 class="auth-header">Вход в аккаунт</h2><form id="authForm" class="form-container"><div class="form-group"><label for="userPhone">Номер телефона:</label><input type="tel" id="userPhone" placeholder="+7 (999) 999-99-99" required></div><div class="form-group"><label for="userPassword">Пароль:</label><input type="password" id="userPassword" placeholder="Введите пароль" required></div><button type="submit" class="auth-button">ВОЙТИ</button><a href="#" id="switchToRegister" class="back-button">У меня нет аккаунта (Регистрация)</a></form></div>
    
    <div id="registerModal" style="display: none;"><h2 class="auth-header">Регистрация</h2><form id="registerForm" class="form-container">
        <div class="form-group"><label for="regUserType">Я...</label><select id="regUserType" required><option value="">Выберите тип пользователя...</option><option value="ЗАКАЗЧИК">Заказчик</option><option value="ИСПОЛНИТЕЛЬ">Исполнитель</option><option value="ВЛАДЕЛЕЦ СПЕЦТЕХНИКИ">Владелец спецтехники</option></select></div>
        <div class="form-group"><label for="regUserName">Мое имя:</label><input type="text" id="regUserName" placeholder="Введите ваше имя" required></div>
        <div class="form-group"><label for="regUserCity">Мой город:</label><select id="regUserCity" required></select></div>
        <div class="form-group"><label for="regUserPhone">Мой номер телефона:</label><input type="tel" id="regUserPhone" placeholder="+7 (999) 999-99-99" required></div>
        <div class="form-group"><label for="regUserPassword">Придумайте пароль:</label><input type="password" id="regUserPassword" placeholder="Надежный пароль" required></div>
        <div class="form-group" id="regSpecializationGroup" style="display: none;"><label for="regSpecializationSelect">Моя основная специализация:</label><select id="regSpecializationSelect"></select></div>
        <button type="submit" class="auth-button">ЗАРЕГИСТРИРОВАТЬСЯ</button>
        <a href="#" id="switchToLogin" class="back-button">У меня уже есть аккаунт (Войти)</a></form>
    </div>

    <div id="profilePage">
        <h2 class="profile-header">Ваш профиль</h2>
        <div class="profile-card">
            <div><strong>Тип:</strong> <span id="profileType"></span></div>
            <div><strong>Имя:</strong> <span id="profileName"></span></div>
            <div><strong>Телефон:</strong> <span id="profilePhone"></span></div>
            <div><strong>Город:</strong> <span id="profileCity"></span></div>
            <div id="profileSpecializationDisplay" style="margin-top: 10px; display: none;"><strong>Специализация:</strong> <span id="profileSpecialization"></span></div>
        </div>
        <div class="form-container" id="specializationGroup" style="display: none; padding: 15px; margin-top: 0; max-width: 400px;">
            <div class="form-group" style="width: 100%; margin:0;">
                <label for="profileSpecializationSelect">Изменить специализацию:</label>
                <select id="profileSpecializationSelect" style="width: 100%; padding: 10px;"></select>
                <button type="button" id="saveSpecialization" class="auth-button" style="margin-top: 10px; width: 100%;">Сохранить</button>
            </div>
        </div>
        <div class="subscription-info">
            <h3>Подписка "Профи"</h3>
            <div>Статус: <span id="subscriptionStatus" class="subscription-status">Не активна</span></div>
            <div>Срок действия: <span id="subscriptionExpiry">-</span></div>
            <button class="subscription-button" id="subscriptionButton">Оформить подписку</button>
        </div>
        <button class="profile-button" id="myRequestsButton">Мои заявки</button>
        <button class="logout-button" id="logoutButton">ВЫЙТИ</button>
        <a href="#" class="back-button" id="backToMain">← Назад</a>
    </div>

    <div id="requestFormPage">
         <div class="form-container">
            <h2 class="form-title">Создать заявку на работы</h2>
            <form id="requestForm">
                <div class="form-group"><label for="workType">Тип работ:</label><select id="workType" required></select></div>
                <div class="checkbox-group"><input type="checkbox" id="visitCheckbox"><label for="visitCheckbox">Нужен выезд мастера на адрес</label></div>
                <div class="form-group" id="addressField" style="display: none;"><label for="workAddress">Адрес выполнения работ:</label><input type="text" id="workAddress" placeholder="Укажите адрес"></div>
                <div class="form-group"><label for="requestDescription">Подробное описание задачи:</label><textarea id="requestDescription" placeholder="Опишите детали заказа..." required></textarea></div>
                <div class="form-group"><label for="requestPhotos">Фотографии (необязательно):</label><input type="file" id="requestPhotos" accept="image/*" multiple></div>
                <button type="submit" class="submit-button">ОТПРАВИТЬ ЗАЯВКУ</button>
                <a href="#" class="back-button" id="backToMainFromRequest">← Назад</a>
            </form>
        </div>
    </div>

    <div id="machineryFormPage">
        <div class="form-container">
            <h2 class="form-title">Заявка на аренду спецтехники</h2>
            <form id="machineryForm">
                <div class="form-group"><label for="machineryType">Тип спецтехники:</label><select id="machineryType" required></select></div>
                <div class="form-group"><label for="machineryAddress">Адрес подачи техники:</label><input type="text" id="machineryAddress" placeholder="Укажите адрес" required></div>
                <div class="checkbox-group"><input type="checkbox" id="minOrderCheckbox"><label for="minOrderCheckbox">Минимальный заказ (4 часа)</label></div>
                <div class="checkbox-group"><input type="checkbox" id="preorderCheckbox"><label for="preorderCheckbox">Предварительный заказ</label></div>
                <div id="preorderFields" style="display: none;">
                    <div class="form-group"><label for="preorderDate">Дата и время:</label><input type="datetime-local" id="preorderDate"></div>
                </div>
                <div class="form-group"><label for="machineryDescription">Описание задачи:</label><textarea id="machineryDescription" placeholder="Опишите детали заказа..." required></textarea></div>
                <button type="submit" class="submit-button">ОТПРАВИТЬ ЗАЯВКУ</button>
                <a href="#" class="back-button" id="backToMainFromMachinery">← Назад</a>
            </form>
        </div>
    </div>

    <div id="toolsFormPage">
         <div class="form-container">
            <h2 class="form-title">Заявка на аренду инструмента</h2>
            <form id="toolsForm">
                <div class="form-group"><label for="toolType">Тип инструмента:</label><input type="text" id="toolType" placeholder="Например: Перфоратор, дрель" required></div>
                <div class="form-group"><label for="toolAddress">Адрес получения:</label><input type="text" id="toolAddress" placeholder="Укажите адрес" required></div>
                <div class="checkbox-group"><input type="checkbox" id="toolPreorderCheckbox"><label for="toolPreorderCheckbox">Предварительный заказ</label></div>
                <div id="toolPreorderFields" style="display: none;">
                    <div class="form-group"><label for="toolPreorderDate">Дата и время:</label><input type="datetime-local" id="toolPreorderDate"></div>
                </div>
                <div class="form-group"><label for="toolDescription">Описание задачи:</label><textarea id="toolDescription" placeholder="Опишите детали заказа..." required></textarea></div>
                <button type="submit" class="submit-button">ОТПРАВИТЬ ЗАЯВКУ</button>
                <a href="#" class="back-button" id="backToMainFromTools">← Назад</a>
            </form>
        </div>
    </div>

    <div id="materialsFormPage">
         <div class="form-container">
            <h2 class="form-title">Разместить объявление о продаже материалов</h2>
            <form id="materialsForm">
                <div class="form-group"><label for="materialType">Тип материалов:</label><input type="text" id="materialType" placeholder="Например: Кирпич, песок" required></div>
                <div class="form-group"><label for="materialPrice">Цена за единицу (руб):</label><input type="number" id="materialPrice" step="0.01" required></div>
                <div class="form-group"><label for="materialDescription">Описание:</label><textarea id="materialDescription" placeholder="Укажите количество, состояние и другие детали..." required></textarea></div>
                <div class="form-group"><label for="materialContact">Контактная информация:</label><input type="text" id="materialContact" placeholder="Телефон или Telegram" required></div>
                <button type="submit" class="submit-button">РАЗМЕСТИТЬ</button>
                <a href="#" class="back-button" id="backToMainFromMaterials">← Назад</a>
            </form>
        </div>
    </div>

    <div id="takeOrderPage">
        <h2 class="orders-header">Актуальные заказы</h2>
        <div class="orders-list" id="ordersList">
            <p class="no-orders">Заказы в вашем городе не найдены.</p>
        </div>
        <a href="#" class="back-button" id="backToMainFromTakeOrder">← Назад</a>
    </div>

    <div id="myRequestsPage">
        <h2 class="requests-header">Мои заявки</h2>
        <div class="orders-list" id="myRequestsList">
            <p class="no-orders">Вы пока не создали ни одной заявки.</p>
        </div>
        <a href="#" class="back-button" id="backToProfileFromRequests">← Назад</a>
    </div>

    <div id="marketplacePage">
        <h2 class="marketplace-header">Доска объявлений</h2>
        <div class="orders-list" id="marketplaceList">
            <p class="no-orders">На доске объявлений пока нет материалов.</p>
        </div>
        <a href="#" class="back-button" id="backToMainFromMarketplace">← Назад</a>
    </div>
    
    <div id="chatPage" style="display: none;">
        <div class="form-container">
            <h2 class="form-title">Чат с исполнителем</h2>
            <div id="chatMessages" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"></div>
            <form id="chatForm">
                <div class="form-group">
                    <input type="text" id="chatMessageInput" placeholder="Введите сообщение..." required>
                </div>
                <button type="submit" class="submit-button">Отправить</button>
            </form>
        </div>
    </div>


<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const baseUrl = 'https://smzrf.onrender.com/api';
        const cityModal = document.getElementById('cityModal');
        const cityButtonsContainer = document.getElementById('cityButtons');
        const citySearchInput = document.getElementById('citySearch');
        const closeCityModalButton = cityModal.querySelector('.close-modal');
        const cityNameEl = document.getElementById('cityName');
        const buttonContainer = document.getElementById('buttonContainer');
        const navMaster = document.getElementById('navMaster');
        const navCreate = document.getElementById('navCreate');
        const navProfile = document.getElementById('navProfile');
        const navSubscription = document.getElementById('navSubscription');

        // Функции для работы с локальным хранилищем
        const saveSelectedCity = (city) => localStorage.setItem('selectedCity', JSON.stringify(city));
        const getSelectedCity = () => {
            const city = localStorage.getItem('selectedCity');
            return city ? JSON.parse(city) : null;
        };

        // Функции для работы с навигацией
        const pages = ['authModal', 'registerModal', 'profilePage', 'requestFormPage', 'takeOrderPage', 'myRequestsPage', 'machineryFormPage', 'toolsFormPage', 'chatPage', 'marketplacePage', 'materialsFormPage'];

        const showPage = (pageId) => {
            pages.forEach(id => {
                const page = document.getElementById(id);
                if (page) {
                    page.style.display = (id === pageId) ? 'flex' : 'none';
                }
            });
            if (pageId === 'buttonContainer') {
                buttonContainer.style.display = 'flex';
                const mainPageLinks = document.querySelectorAll('#backToMain, #backToMainFromRequest, #backToMainFromMachinery, #backToMainFromTools, #backToMainFromMaterials, #backToMainFromTakeOrder, #backToMainFromMarketplace');
                mainPageLinks.forEach(link => link.style.display = 'none');
            } else {
                 buttonContainer.style.display = 'none';
            }
        };

        const setActiveNav = (navId) => {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.style.backgroundColor = '#f5f0e6');
            if (navId) {
                document.getElementById(navId).style.backgroundColor = '#e8dccf';
            }
        };

        // Функции API
        const fetchCities = async () => {
            try {
                const response = await fetch(`${baseUrl}/cities`);
                const cities = await response.json();
                renderCities(cities);
            } catch (error) {
                console.error("Ошибка при получении списка городов:", error);
            }
        };

        const fetchSpecializations = async () => {
            try {
                const response = await fetch(`${baseUrl}/specializations`);
                const specializations = await response.json();
                renderSpecializations(specializations);
            } catch (error) {
                console.error("Ошибка при получении списка специализаций:", error);
            }
        };

        const fetchMachineryTypes = async () => {
            try {
                const response = await fetch(`${baseUrl}/machinery-types`);
                const machineryTypes = await response.json();
                renderMachineryTypes(machineryTypes);
            } catch (error) {
                console.error("Ошибка при получении списка спецтехники:", error);
            }
        };

        const fetchOrders = async (cityId) => {
            try {
                const response = await fetch(`${baseUrl}/work-requests/?city_id=${cityId}`);
                const orders = await response.json();
                renderOrders(orders);
            } catch (error) {
                console.error("Ошибка при получении списка заказов:", error);
            }
        };

        const fetchMyRequests = async (userId) => {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    return;
                }
                const response = await fetch(`${baseUrl}/my-requests`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const requests = await response.json();
                renderMyRequests(requests);
            } catch (error) {
                console.error("Ошибка при получении моих заявок:", error);
            }
        };
        
        const fetchMarketplaceAds = async (cityId) => {
            try {
                const response = await fetch(`${baseUrl}/marketplace/?city_id=${cityId}`);
                const ads = await response.json();
                renderMarketplaceAds(ads);
            } catch (error) {
                console.error("Ошибка при получении объявлений на доске:", error);
            }
        };

        // Функции рендеринга
        const renderCities = (cities) => {
            cityButtonsContainer.innerHTML = '';
            cities.forEach(city => {
                const button = document.createElement('button');
                button.className = 'modal-button';
                button.textContent = city.name;
                button.onclick = () => {
                    saveSelectedCity(city);
                    cityNameEl.textContent = city.name;
                    cityModal.classList.remove('active');
                    checkAuthentication();
                };
                cityButtonsContainer.appendChild(button);
            });
        };

        const renderSpecializations = (specializations) => {
            const regSpecializationSelect = document.getElementById('regSpecializationSelect');
            const profileSpecializationSelect = document.getElementById('profileSpecializationSelect');
            const workTypeSelect = document.getElementById('workType');
            [regSpecializationSelect, profileSpecializationSelect, workTypeSelect].forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Выберите...</option>';
                    specializations.forEach(spec => {
                        const option = document.createElement('option');
                        option.value = spec;
                        option.textContent = spec;
                        select.appendChild(option);
                    });
                }
            });
        };

        const renderMachineryTypes = (machineryTypes) => {
            const machineryTypeSelect = document.getElementById('machineryType');
            if (machineryTypeSelect) {
                machineryTypeSelect.innerHTML = '<option value="">Выберите...</option>';
                machineryTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    machineryTypeSelect.appendChild(option);
                });
            }
        };

        const renderOrders = (orders) => {
            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = '';
            if (orders.length === 0) {
                ordersList.innerHTML = '<p class="no-orders">Заказы в вашем городе не найдены.</p>';
                return;
            }
            orders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                orderCard.innerHTML = `
                    <div><strong>Тип:</strong> ${order.work_type}</div>
                    <div><strong>Описание:</strong> ${order.description}</div>
                    <div><strong>Город:</strong> ${getSelectedCity().name}</div>
                    <div><small>Дата размещения: ${new Date(order.created_at).toLocaleDateString()}</small></div>
                    <button class="take-order-btn" data-order-id="${order.id}">Взять заказ</button>
                `;
                ordersList.appendChild(orderCard);
            });
        };

        const renderMyRequests = (requests) => {
            const myRequestsList = document.getElementById('myRequestsList');
            myRequestsList.innerHTML = '';
            if (requests.length === 0) {
                myRequestsList.innerHTML = '<p class="no-orders">Вы пока не создали ни одной заявки.</p>';
                return;
            }
            requests.forEach(request => {
                const requestCard = document.createElement('div');
                requestCard.className = 'request-card';
                requestCard.innerHTML = `
                    <div><strong>Тип:</strong> ${request.work_type || request.machinery_type || request.tool_name || request.material_type}</div>
                    <div><strong>Описание:</strong> ${request.description}</div>
                    <div><small>Дата размещения: ${new Date(request.created_at).toLocaleDateString()}</small></div>
                `;
                myRequestsList.appendChild(requestCard);
            });
        };
        
        const renderMarketplaceAds = (ads) => {
            const marketplaceList = document.getElementById('marketplaceList');
            marketplaceList.innerHTML = '';
            if (ads.length === 0) {
                marketplaceList.innerHTML = '<p class="no-orders">На доске объявлений пока нет материалов.</p>';
                return;
            }
            ads.forEach(ad => {
                const adCard = document.createElement('div');
                adCard.className = 'post-card';
                adCard.innerHTML = `
                    <div><strong>Тип:</strong> ${ad.material_type}</div>
                    <div><strong>Цена:</strong> ${ad.price} руб.</div>
                    <div><strong>Описание:</strong> ${ad.description}</div>
                    <div><strong>Контакт:</strong> ${ad.contact_info}</div>
                    <div class="post-date">Размещено: ${new Date(ad.created_at).toLocaleDateString()}</div>
                `;
                marketplaceList.appendChild(adCard);
            });
        };

        // Обработка событий
        document.getElementById('changeCityButton').addEventListener('click', () => {
            cityModal.classList.add('active');
        });

        closeCityModalButton.addEventListener('click', () => {
            cityModal.classList.remove('active');
        });

        document.getElementById('masterButton').addEventListener('click', () => showPage('requestFormPage'));
        document.getElementById('machineryButton').addEventListener('click', () => {
            showPage('machineryFormPage');
            fetchMachineryTypes();
        });
        document.getElementById('toolsButton').addEventListener('click', () => showPage('toolsFormPage'));
        document.getElementById('sellMaterialsButton').addEventListener('click', () => showPage('materialsFormPage'));
        document.getElementById('marketplaceButton').addEventListener('click', () => {
            const city = getSelectedCity();
            if (city) {
                showPage('marketplacePage');
                fetchMarketplaceAds(city.id);
            }
        });
        document.getElementById('profileButton').addEventListener('click', () => showPage('profilePage'));
        
        navMaster.addEventListener('click', () => {
            setActiveNav('navMaster');
            const city = getSelectedCity();
            if (city) {
                showPage('takeOrderPage');
                fetchOrders(city.id);
            }
        });

        navCreate.addEventListener('click', () => {
            setActiveNav('navCreate');
            showPage('buttonContainer');
        });

        navProfile.addEventListener('click', () => {
            setActiveNav('navProfile');
            showPage('profilePage');
        });
        
        navSubscription.addEventListener('click', () => {
            setActiveNav('navSubscription');
            // Здесь должна быть логика для страницы подписки
            // Пока просто показываем профиль
            showPage('profilePage');
        });

        document.getElementById('switchBackToMain').addEventListener('click', (e) => {
            e.preventDefault();
            showPage('buttonContainer');
        });

        document.getElementById('switchToRegister').addEventListener('click', (e) => {
            e.preventDefault();
            showPage('registerModal');
        });

        document.getElementById('switchToLogin').addEventListener('click', (e) => {
            e.preventDefault();
            showPage('authModal');
        });

        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('token');
            showPage('authModal');
        });

        document.getElementById('myRequestsButton').addEventListener('click', () => {
            const user = getSelectedUser();
            if (user) {
                showPage('myRequestsPage');
                fetchMyRequests(user.id);
            }
        });

        document.getElementById('saveSpecialization').addEventListener('click', async () => {
            const token = localStorage.getItem('token');
            const selectedSpecialization = document.getElementById('profileSpecializationSelect').value;
            if (!token || !selectedSpecialization) return;
            try {
                const response = await fetch(`${baseUrl}/update-specialization`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ specialization: selectedSpecialization })
                });
                if (response.ok) {
                    alert('Специализация успешно обновлена!');
                    const user = getSelectedUser();
                    user.specialization = selectedSpecialization;
                    localStorage.setItem('user', JSON.stringify(user));
                    checkAuthentication();
                } else {
                    alert('Ошибка при обновлении специализации.');
                }
            } catch (error) {
                console.error("Ошибка при обновлении специализации:", error);
                alert('Ошибка при обновлении специализации.');
            }
        });
        
        const getSelectedUser = () => {
            const user = localStorage.getItem('user');
            return user ? JSON.parse(user) : null;
        };

        const checkAuthentication = () => {
            const token = localStorage.getItem('token');
            if (token) {
                // Если есть токен, проверяем пользователя
                fetch(`${baseUrl}/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Недействительный токен');
                    }
                })
                .then(user => {
                    localStorage.setItem('user', JSON.stringify(user));
                    updateProfilePage(user);
                    showPage('buttonContainer');
                    setActiveNav('navCreate');
                })
                .catch(error => {
                    console.error("Ошибка аутентификации:", error);
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    showPage('authModal');
                });
            } else {
                showPage('authModal');
            }
        };
        
        const updateProfilePage = (user) => {
            document.getElementById('profileType').textContent = user.user_type;
            document.getElementById('profileName').textContent = user.user_name;
            document.getElementById('profilePhone').textContent = user.username;
            document.getElementById('profileCity').textContent = getSelectedCity().name;
            
            if (user.user_type === "ИСПОЛНИТЕЛЬ" || user.user_type === "ВЛАДЕЛЕЦ СПЕЦТЕХНИКИ") {
                document.getElementById('profileSpecializationDisplay').style.display = 'block';
                document.getElementById('specializationGroup').style.display = 'block';
                document.getElementById('profileSpecialization').textContent = user.specialization || 'Не указана';
                const profileSpecializationSelect = document.getElementById('profileSpecializationSelect');
                if (profileSpecializationSelect) {
                    profileSpecializationSelect.value = user.specialization;
                }
            } else {
                document.getElementById('profileSpecializationDisplay').style.display = 'none';
                document.getElementById('specializationGroup').style.display = 'none';
            }
            
            const subscriptionInfo = document.querySelector('.subscription-info');
            if (user.is_pro_member) {
                document.getElementById('subscriptionStatus').textContent = 'Активна';
                document.getElementById('subscriptionStatus').classList.add('active');
                document.getElementById('subscriptionStatus').classList.remove('inactive');
                document.getElementById('subscriptionExpiry').textContent = new Date(user.pro_expiry_date).toLocaleDateString();
                document.getElementById('subscriptionButton').textContent = 'Продлить подписку';
                document.getElementById('subscriptionButton').disabled = false;
            } else {
                 document.getElementById('subscriptionStatus').textContent = 'Не активна';
                 document.getElementById('subscriptionStatus').classList.remove('active');
                 document.getElementById('subscriptionStatus').classList.add('inactive');
                 document.getElementById('subscriptionExpiry').textContent = '-';
                 document.getElementById('subscriptionButton').textContent = 'Оформить подписку';
                 document.getElementById('subscriptionButton').disabled = false;
            }
            if (user.user_type === "ЗАКАЗЧИК") {
                subscriptionInfo.style.display = 'none';
            } else {
                subscriptionInfo.style.display = 'block';
            }
        };

        const sendRequest = async (url, method, data, token = null) => {
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            const response = await fetch(url, {
                method: method,
                headers: headers,
                body: JSON.stringify(data)
            });
            return response;
        };

        // Обработчики форм
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('userPhone').value;
            const password = document.getElementById('userPassword').value;
            try {
                const response = await sendRequest(`${baseUrl}/token`, 'POST', { username: phone, password: password });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('token', data.access_token);
                    checkAuthentication();
                } else {
                    alert('Ошибка входа: ' + data.detail);
                }
            } catch (error) {
                alert('Произошла ошибка. Пожалуйста, попробуйте снова.');
            }
        });
        
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userType = document.getElementById('regUserType').value;
            const userName = document.getElementById('regUserName').value;
            const userCity = document.getElementById('regUserCity').value;
            const userPhone = document.getElementById('regUserPhone').value;
            const userPassword = document.getElementById('regUserPassword').value;
            const specialization = document.getElementById('regSpecializationSelect').value;
            
            try {
                const response = await sendRequest(`${baseUrl}/register`, 'POST', {
                    username: userPhone,
                    password: userPassword,
                    user_name: userName,
                    user_type: userType,
                    city_id: parseInt(userCity),
                    specialization: specialization || null
                });
                const data = await response.json();
                if (response.ok) {
                    alert('Регистрация успешна! Теперь войдите в систему.');
                    showPage('authModal');
                } else {
                    alert('Ошибка регистрации: ' + data.detail);
                }
            } catch (error) {
                alert('Произошла ошибка. Пожалуйста, попробуйте снова.');
            }
        });

        document.getElementById('requestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const workType = document.getElementById('workType').value;
            const description = document.getElementById('requestDescription').value;
            const address = document.getElementById('visitCheckbox').checked ? document.getElementById('workAddress').value : null;
            const city = getSelectedCity();
            const token = localStorage.getItem('token');

            if (!city) {
                alert('Пожалуйста, сначала выберите город.');
                return;
            }

            try {
                const response = await sendRequest(`${baseUrl}/work-requests/`, 'POST', {
                    work_type: workType,
                    description: description,
                    address: address,
                    city_id: city.id
                }, token);
                const data = await response.json();
                if (response.ok) {
                    alert('Заявка на работы успешно создана!');
                    e.target.reset();
                    showPage('buttonContainer');
                } else {
                    alert('Ошибка создания заявки: ' + (data.detail || 'Неизвестная ошибка'));
                }
            } catch (error) {
                alert('Произошла ошибка. Пожалуйста, попробуйте снова.');
            }
        });

        document.getElementById('machineryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const machineryType = document.getElementById('machineryType').value;
            const address = document.getElementById('machineryAddress').value;
            const description = document.getElementById('machineryDescription').value;
            const isPreorder = document.getElementById('preorderCheckbox').checked;
            const preorderDate = isPreorder ? document.getElementById('preorderDate').value : null;
            const city = getSelectedCity();
            const token = localStorage.getItem('token');

            if (!city) {
                alert('Пожалуйста, сначала выберите город.');
                return;
            }

            try {
                const response = await sendRequest(`${baseUrl}/machinery-requests/`, 'POST', {
                    machinery_type: machineryType,
                    address: address,
                    description: description,
                    is_preorder: isPreorder,
                    preorder_date: preorderDate,
                    city_id: city.id
                }, token);
                const data = await response.json();
                if (response.ok) {
                    alert('Заявка на спецтехнику успешно создана!');
                    e.target.reset();
                    showPage('buttonContainer');
                } else {
                    alert('Ошибка создания заявки: ' + (data.detail || 'Неизвестная ошибка'));
                }
            } catch (error) {
                alert('Произошла ошибка. Пожалуйста, попробуйте снова.');
            }
        });
        
        document.getElementById('toolsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const toolType = document.getElementById('toolType').value;
            const description = document.getElementById('toolDescription').value;
            const rentalPrice = 0; // Добавлено, так как поле было удалено из HTML, но осталось в модели
            const contactInfo = getSelectedUser().username; // Добавлено, так как поле было удалено из HTML, но осталось в модели
            const isPreorder = document.getElementById('toolPreorderCheckbox').checked;
            const preorderDate = isPreorder ? document.getElementById('toolPreorderDate').value : null;
            const city = getSelectedCity();
            const token = localStorage.getItem('token');
        
            if (!city) {
                alert('Пожалуйста, сначала выберите город.');
                return;
            }
        
            try {
                const response = await sendRequest(`${baseUrl}/tool-requests/`, 'POST', {
                    tool_name: toolType,
                    description: description,
                    rental_price: rentalPrice,
                    contact_info: contactInfo,
                    is_preorder: isPreorder,
                    preorder_date: preorderDate,
                    city_id: city.id
                }, token);
                const data = await response.json();
                if (response.ok) {
                    alert('Заявка на инструмент успешно создана!');
                    e.target.reset();
                    showPage('buttonContainer');
                } else {
                    alert('Ошибка создания заявки: ' + (data.detail || 'Неизвестная ошибка'));
                }
            } catch (error) {
                alert('Произошла ошибка. Пожалуйста, попробуйте снова.');
            }
        });
        
        document.getElementById('materialsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const materialType = document.getElementById('materialType').value;
            const price = parseFloat(document.getElementById('materialPrice').value);
            const description = document.getElementById('materialDescription').value;
            const contactInfo = document.getElementById('materialContact').value;
            const city = getSelectedCity();
            const token = localStorage.getItem('token');
        
            if (!city) {
                alert('Пожалуйста, сначала выберите город.');
                return;
            }
        
            try {
                const response = await sendRequest(`${baseUrl}/material-ads/`, 'POST', {
                    material_type: materialType,
                    description: description,
                    price: price,
                    contact_info: contactInfo,
                    city_id: city.id
                }, token);
                const data = await response.json();
                if (response.ok) {
                    alert('Объявление успешно размещено!');
                    e.target.reset();
                    showPage('buttonContainer');
                } else {
                    alert('Ошибка размещения объявления: ' + (data.detail || 'Неизвестная ошибка'));
                }
            } catch (error) {
                alert('Произошла ошибка. Пожалуйста, попробуйте снова.');
            }
        });


        // Инициализация
        fetchCities();
        fetchSpecializations();
        fetchMachineryTypes();

        const selectedCity = getSelectedCity();
        if (selectedCity) {
            cityNameEl.textContent = selectedCity.name;
            checkAuthentication();
        } else {
            cityModal.classList.add('active');
        }

        // Обновленные обработчики для всех кнопок "Назад"
        document.getElementById('backToMainFromRequest').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); setActiveNav('navCreate'); });
        document.getElementById('backToMainFromMachinery').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); setActiveNav('navCreate'); });
        document.getElementById('backToMainFromTools').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); setActiveNav('navCreate'); });
        document.getElementById('backToMainFromMaterials').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); setActiveNav('navCreate'); });
        document.getElementById('backToMainFromTakeOrder').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); setActiveNav('navCreate'); });
        document.getElementById('backToMainFromMarketplace').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); setActiveNav('navCreate'); });
        document.getElementById('backToProfileFromRequests').addEventListener('click', (e) => { e.preventDefault(); showPage('profilePage'); setActiveNav('navProfile'); });
        document.getElementById('backToMain').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); setActiveNav('navCreate'); });
    });
</script>
</body>
</html>