<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СМЗ.РФ - Рабочие и спецтехника</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Ваши стили */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; color: white; overflow: hidden; background: black; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .background-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; }
        .selected-city { margin-top: 12px; font-size: 16px; color: #fff; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; flex-wrap: wrap; }
        .city-name { font-weight: bold; }
        .container { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; width: 100%; max-width: 450px; padding: 20px; box-sizing: border-box; }
        .content-page { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 20px 0; overflow-y: auto; box-sizing: border-box; height: 100vh; }
        .auth-container { display: none; }
        .button-container { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .app-btn, .action-btn, .auth-btn, .back-btn { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 15px 25px; margin: 10px 0; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, background 0.2s; width: 100%; max-width: 300px; text-align: center; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .app-btn:hover, .action-btn:hover, .auth-btn:hover { transform: translateY(-3px); }
        .login-register-btn { background: #007aff; }
        .logout-btn { background: #ff3b30; }
        .profile-btn { background: #34c759; }
        h1 { margin-top: 100px; font-size: 28px; font-weight: 700; text-align: center; }
        .logo-placeholder { width: 150px; height: 150px; background-color: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; }
        .logo-placeholder i { font-size: 60px; color: white; }
        .logo-text { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #1c1c1e; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; display: flex; flex-direction: column; align-items: center; color: white; }
        .modal-content h3 { margin-bottom: 20px; }
        .modal-content select, .modal-content input, .modal-content button { width: 100%; padding: 10px; margin: 8px 0; border: none; border-radius: 8px; font-size: 16px; }
        .modal-content select { background: #333; color: white; }
        .modal-content input { background: #333; color: white; }
        .modal-content button { background: #007aff; color: white; cursor: pointer; font-weight: 600; }
        .modal-content button:hover { opacity: 0.8; }
        #auth-modal .modal-content { padding: 30px; }
        .modal-content input:focus { outline: none; border: 1px solid #007aff; }
        #auth-modal .modal-content h3 { font-size: 20px; }
        .tabs { display: flex; width: 100%; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; background: #333; border: none; color: white; cursor: pointer; font-size: 16px; }
        .tab-btn.active { background: #007aff; }
        .tab-content { display: none; width: 100%; }
        .tab-content.active { display: block; }
        #auth-modal .input-group { margin-bottom: 15px; }
        #auth-modal label { display: block; margin-bottom: 5px; color: #aaa; font-size: 14px; }
        #auth-modal input { width: 100%; padding: 12px; border: 1px solid #555; background: #2c2c2e; color: white; border-radius: 8px; box-sizing: border-box; }
        #auth-modal button { margin-top: 15px; }
        #auth-modal select { background: #2c2c2e; border: 1px solid #555; color: white; }
        #profilePage h2, #requestsPage h2, #marketplacePage h2 { margin-bottom: 20px; }
        #profilePage .profile-info { width: 100%; max-width: 300px; text-align: left; }
        #profilePage .profile-info p { margin: 10px 0; font-size: 16px; }
        .back-btn { position: absolute; top: 20px; left: 20px; width: 50px; height: 50px; padding: 0; font-size: 24px; }
        form { width: 100%; max-width: 400px; margin-top: 20px; }
        form input, form select, form textarea, form button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #555; background: #2c2c2e; color: white; border-radius: 8px; box-sizing: border-box; }
        form button { background: #007aff; border: none; cursor: pointer; font-weight: bold; }
        .checkbox-container { display: flex; align-items: center; margin: 10px 0; }
        .checkbox-container input { width: auto; margin-right: 10px; }
        form textarea { height: 100px; resize: vertical; }
        .filter-container { width: 100%; max-width: 400px; margin-bottom: 20px; display: flex; gap: 10px; }
        #requestsList, #materialsList { width: 100%; max-width: 400px; }
        .request-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 15px; margin: 10px 0; border-radius: 12px; display: flex; flex-direction: column; text-align: left; }
        .request-card h4 { margin-bottom: 5px; }
        .request-card p { font-size: 14px; color: #ccc; }
        .request-card button { margin-top: 10px; }
        .header { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 20px; }
        .header .user-info { display: flex; align-items: center; gap: 10px; }
        .header .user-info .username { font-weight: bold; }
        .header .user-info .user-type { font-size: 14px; color: #ccc; }
        .header .profile-btn { padding: 10px 15px; }
        .search-container { width: 100%; max-width: 400px; margin-top: 20px; }
        .search-container input { width: 100%; padding: 12px; border: 1px solid #555; background: #2c2c2e; color: white; border-radius: 8px; box-sizing: border-box; }
        #myRequestsList, #myAdsList { width: 100%; max-width: 400px; margin-top: 20px; }
        .request-card .request-type { font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 5px; }
    </style>
</head>
<body>
    <video class="background-video" autoplay muted loop>
        <source src="https://assets.mixkit.co/videos/preview/mixkit-construction-site-in-a-rural-area-6571-large.mp4" type="video/mp4">
    </video>
    <div id="cityModal" class="modal">
        <div class="modal-content">
            <h3>Выберите свой город</h3>
            <select id="citySelectModal">
                <option value="" disabled selected>Выберите город</option>
            </select>
            <button id="saveCityBtn">Сохранить</button>
        </div>
    </div>
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <div class="tabs">
                <button class="tab-btn active" data-tab="loginTab">Вход</button>
                <button class="tab-btn" data-tab="registerTab">Регистрация</button>
            </div>
            <div id="loginTab" class="tab-content active">
                <h3>Вход</h3>
                <div class="input-group">
                    <label for="loginUsername">Имя пользователя:</label>
                    <input type="text" id="loginUsername">
                </div>
                <div class="input-group">
                    <label for="loginPassword">Пароль:</label>
                    <input type="password" id="loginPassword">
                </div>
                <button id="loginBtn" class="auth-btn">Войти</button>
            </div>
            <div id="registerTab" class="tab-content">
                <h3>Регистрация</h3>
                <div class="input-group">
                    <label for="registerUsername">Имя пользователя:</label>
                    <input type="text" id="registerUsername">
                </div>
                <div class="input-group">
                    <label for="registerPassword">Пароль:</label>
                    <input type="password" id="registerPassword">
                </div>
                <div class="input-group">
                    <label for="registerName">Имя:</label>
                    <input type="text" id="registerName">
                </div>
                <div class="input-group">
                    <label for="userType">Тип пользователя:</label>
                    <select id="userType">
                        <option value="ЗАКАЗЧИК">Заказчик</option>
                        <option value="ИСПОЛНИТЕЛЬ">Исполнитель</option>
                        <option value="ВЛАДЕЛЕЦ СПЕЦТЕХНИКИ">Владелец спецтехники</option>
                    </select>
                </div>
                <div class="input-group" id="specializationGroup" style="display:none;">
                    <label for="specializationSelect">Специализация:</label>
                    <select id="specializationSelect"></select>
                </div>
                <button id="registerBtn" class="auth-btn">Зарегистрироваться</button>
            </div>
        </div>
    </div>
    <div class="selected-city">
        Ваш город: <span id="cityName" class="city-name">Не выбран</span>
        <i class="fas fa-edit" id="changeCityBtn" style="cursor:pointer;"></i>
    </div>
    <div id="mainPage" class="content-page" style="display:flex;">
        <div class="header">
            <span id="authStatus" style="font-weight: bold;"></span>
            <div id="userProfile" class="user-info" style="display: none;">
                <span class="username"></span>
                <span class="user-type"></span>
                <button id="profileBtn" class="profile-btn"><i class="fas fa-user-circle"></i></button>
            </div>
        </div>
        <div class="button-container">
            <h1>СМЗ.РФ</h1>
            <a href="#" class="app-btn" id="workRequestBtn"><i class="fas fa-hammer"></i>Найти мастера</a>
            <a href="#" class="app-btn" id="machineryRequestBtn"><i class="fas fa-truck-moving"></i>Аренда техники</a>
            <a href="#" class="app-btn" id="toolRequestBtn"><i class="fas fa-tools"></i>Аренда инструмента</a>
            <a href="#" class="app-btn" id="materialAdBtn"><i class="fas fa-warehouse"></i>Объявления о материалах</a>
            <a href="#" class="app-btn" id="marketplaceBtn"><i class="fas fa-store"></i>Все заявки и объявления</a>
        </div>
    </div>
    <div id="requestPage" class="content-page" style="display:none;">
        <button id="backToMainFromRequest" class="back-btn"><i class="fas fa-arrow-left"></i></button>
        <h2>Создать заявку на работы</h2>
        <form id="requestForm">
            <select id="workType" required>
                <option value="" disabled selected>Выберите тип работ</option>
                <option value="Отделочные работы">Отделочные работы</option>
                <option value="Сантехника">Сантехника</option>
                <option value="Электрика">Электрика</option>
                <option value="Мастер по мебели">Мастер по мебели</option>
                <option value="Мастер на час">Мастер на час</option>
                <option value="Уборка">Уборка</option>
                <option value="Проектирование">Проектирование</option>
            </select>
            <div class="checkbox-container">
                <input type="checkbox" id="visitCheckbox">
                <label for="visitCheckbox">Требуется выезд мастера</label>
            </div>
            <input type="text" id="workAddress" placeholder="Адрес (необязательно)" style="display:none;">
            <select id="citySelect" required>
                <option value="" disabled selected>Выберите город</option>
            </select>
            <textarea id="requestDescription" placeholder="Опишите задачу" required></textarea>
            <button type="submit">Отправить заявку</button>
        </form>
    </div>
    <div id="machineryPage" class="content-page" style="display:none;">
        <button id="backToMainFromMachinery" class="back-btn"><i class="fas fa-arrow-left"></i></button>
        <h2>Аренда техники</h2>
        <form id="machineryForm">
            <select id="machineryType" required>
                <option value="" disabled selected>Выберите тип техники</option>
            </select>
            <input type="text" id="machineryAddress" placeholder="Адрес объекта" required>
            <div class="checkbox-container">
                <input type="checkbox" id="minOrderCheckbox">
                <label for="minOrderCheckbox">Минимальный заказ</label>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="preorderCheckbox">
                <label for="preorderCheckbox">Предзаказ</label>
            </div>
            <input type="date" id="preorderDate" style="display:none;">
            <textarea id="machineryDescription" placeholder="Описание задачи" required></textarea>
            <button type="submit">Отправить заявку</button>
        </form>
    </div>
    <div id="toolsPage" class="content-page" style="display:none;">
        <button id="backToMainFromTools" class="back-btn"><i class="fas fa-arrow-left"></i></button>
        <h2>Аренда инструмента</h2>
        <form id="toolsForm">
            <div class="tool-list-container">
                <label>Выберите инструмент:</label>
                <div id="toolsCheckboxes" class="checkbox-group"></div>
            </div>
            <label for="toolsStartDate">Дата начала аренды:</label>
            <input type="date" id="toolsStartDate" required>
            <label for="toolsEndDate">Дата окончания аренды:</label>
            <input type="date" id="toolsEndDate" required>
            <div class="checkbox-container">
                <input type="checkbox" id="deliveryCheckbox">
                <label for="deliveryCheckbox">Требуется доставка</label>
            </div>
            <input type="text" id="deliveryAddress" placeholder="Адрес доставки (необязательно)" style="display:none;">
            <textarea id="toolsDescription" placeholder="Описание"></textarea>
            <button type="submit">Отправить заявку</button>
        </form>
    </div>
    <div id="materialsPage" class="content-page" style="display:none;">
        <button id="backToMainFromMaterials" class="back-btn"><i class="fas fa-arrow-left"></i></button>
        <h2>Объявления о материалах</h2>
        <form id="materialForm">
            <input type="text" id="materialType" placeholder="Тип материала" required>
            <textarea id="materialDescription" placeholder="Описание" required></textarea>
            <input type="number" id="materialPrice" placeholder="Цена" required>
            <button type="submit">Разместить объявление</button>
        </form>
    </div>
    <div id="marketplacePage" class="content-page" style="display:none;">
        <button id="backToMainFromMarketplace" class="back-btn"><i class="fas fa-arrow-left"></i></button>
        <h2>Все заявки и объявления</h2>
        <div class="filter-container">
            <select id="filterCity">
                <option value="">Все города</option>
            </select>
        </div>
        <div id="requestsList"></div>
    </div>
    <div id="takeOrderPage" class="content-page" style="display:none;">
        <button id="backToMainFromTakeOrder" class="back-btn"><i class="fas fa-arrow-left"></i></button>
        <h2>Детали заявки</h2>
        <div id="orderDetails"></div>
        <button id="takeOrderBtn" class="action-btn" style="display: none;">Принять заявку</button>
        <button id="markAsCompletedBtn" class="action-btn" style="display: none;">Отметить как выполненную</button>
    </div>
    <div id="profilePage" class="content-page" style="display:none;">
        <button id="backToMain" class="back-btn"><i class="fas fa-arrow-left"></i></button>
        <h2>Мой профиль</h2>
        <div class="profile-info">
            <p><strong>Имя пользователя:</strong> <span id="profileUsername"></span></p>
            <p><strong>Имя:</strong> <span id="profileName"></span></p>
            <p><strong>Тип:</strong> <span id="profileType"></span></p>
            <p><strong>Город:</strong> <span id="profileCity"></span></p>
            <p><strong>Специализация:</strong> <span id="profileSpecialization"></span></p>
        </div>
        <div class="profile-actions">
            <button id="myRequestsBtn" class="action-btn">Мои заявки и объявления</button>
            <button id="logoutBtn" class="logout-btn">Выйти</button>
        </div>
    </div>
    <div id="myRequestsPage" class="content-page" style="display:none;">
        <button id="backToProfileFromRequests" class="back-btn"><i class="fas fa-arrow-left"></i></button>
        <h2>Мои заявки</h2>
        <div id="myRequestsList"></div>
    </div>
    <script>
    const API_URL = 'https://servertest2-0.onrender.com/api';
    const cityModal = document.getElementById('cityModal');
    const citySelectModal = document.getElementById('citySelectModal');
    const saveCityBtn = document.getElementById('saveCityBtn');
    const cityNameEl = document.getElementById('cityName');
    const authModal = document.getElementById('auth-modal');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const loginForm = document.getElementById('loginTab');
    const registerForm = document.getElementById('registerTab');
    const authStatusEl = document.getElementById('authStatus');
    const userProfileEl = document.getElementById('userProfile');
    const workRequestBtn = document.getElementById('workRequestBtn');
    const machineryRequestBtn = document.getElementById('machineryRequestBtn');
    const toolRequestBtn = document.getElementById('toolRequestBtn');
    const materialAdBtn = document.getElementById('materialAdBtn');
    const marketplaceBtn = document.getElementById('marketplaceBtn');
    const profileBtn = document.getElementById('profileBtn');
    const myRequestsBtn = document.getElementById('myRequestsBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userTypeSelect = document.getElementById('userType');
    const specializationGroup = document.getElementById('specializationGroup');
    const specializationSelect = document.getElementById('specializationSelect');
    const machineryTypeSelect = document.getElementById('machineryType');
    const toolsCheckboxesDiv = document.getElementById('toolsCheckboxes');
    const marketplaceFilterCity = document.getElementById('filterCity');
    const allRequestsList = document.getElementById('requestsList');
    const myRequestsList = document.getElementById('myRequestsList');
    const orderDetailsEl = document.getElementById('orderDetails');
    const takeOrderBtn = document.getElementById('takeOrderBtn');

    function showPage(pageId) {
        document.querySelectorAll('.content-page').forEach(page => page.style.display = 'none');
        document.getElementById(pageId).style.display = 'flex';
        if (pageId === 'mainPage') {
            checkAuthentication();
        }
    }

    function getSelectedCity() {
        const city = localStorage.getItem('selectedCity');
        return city ? JSON.parse(city) : null;
    }

    async function fetchCities() {
        try {
            const response = await fetch(`${API_URL}/cities`);
            const cities = await response.json();
            const selectElements = [citySelectModal, marketplaceFilterCity];
            
            // ✅ ИСПРАВЛЕНО: Добавлен новый select для формы "Создать заявку на работы"
            const citySelectForm = document.getElementById('citySelect');
            if (citySelectForm) selectElements.push(citySelectForm);

            selectElements.forEach(selectEl => {
                if (selectEl) {
                    selectEl.innerHTML = selectEl.id === 'filterCity' ? '<option value="">Все города</option>' : '<option value="" disabled selected>Выберите город</option>';
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.id;
                        option.textContent = city.name;
                        selectEl.appendChild(option);
                    });
                }
            });

        } catch (error) {
            console.error('Error fetching cities:', error);
        }
    }

    async function fetchSpecializations() {
        try {
            const response = await fetch(`${API_URL}/specializations`);
            const specializations = await response.json();
            specializationSelect.innerHTML = '';
            specializations.forEach(spec => {
                const option = document.createElement('option');
                option.value = spec;
                option.textContent = spec;
                specializationSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching specializations:', error);
        }
    }

    async function fetchMachineryTypes() {
        try {
            const response = await fetch(`${API_URL}/machinery-types`);
            const machineryTypes = await response.json();
            machineryTypeSelect.innerHTML = '<option value="" disabled selected>Выберите тип техники</option>';
            machineryTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                machineryTypeSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching machinery types:', error);
        }
    }

    async function fetchToolsList() {
        try {
            const response = await fetch(`${API_URL}/tools-list`);
            const tools = await response.json();
            toolsCheckboxesDiv.innerHTML = '';
            tools.forEach(tool => {
                const checkboxContainer = document.createElement('div');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `tool-${tool}`;
                checkbox.value = tool;
                const label = document.createElement('label');
                label.htmlFor = `tool-${tool}`;
                label.textContent = tool;
                checkboxContainer.appendChild(checkbox);
                checkboxContainer.appendChild(label);
                toolsCheckboxesDiv.appendChild(checkboxContainer);
            });
        } catch (error) {
            console.error('Error fetching tools list:', error);
        }
    }

    async function submitAuthForm(type) {
        const usernameInput = document.getElementById(`${type}Username`).value;
        const passwordInput = document.getElementById(`${type}Password`).value;
        const userType = type === 'register' ? document.getElementById('userType').value : null;
        const specialization = userType === 'ИСПОЛНИТЕЛЬ' || userType === 'ВЛАДЕЛЕЦ СПЕЦТЕХНИКИ' ? specializationSelect.value : null;
        const city = getSelectedCity();

        if (!city) {
            alert('Пожалуйста, выберите город перед регистрацией.');
            return;
        }

        const data = {
            username: usernameInput,
            password: passwordInput,
            user_name: usernameInput,
            user_type: userType,
            city_id: city.id,
            specialization: specialization
        };

        const url = `${API_URL}/users/`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.status === 400) {
                alert('Имя пользователя уже зарегистрировано.');
                return;
            }

            if (!response.ok) {
                throw new Error('Failed to register');
            }

            const result = await response.json();
            console.log('User registered successfully:', result);
            alert('Регистрация прошла успешно! Теперь вы можете войти.');
            showPage('mainPage');
            authModal.classList.remove('active');
        } catch (error) {
            console.error('Registration error:', error);
            alert('Ошибка при регистрации. Пожалуйста, попробуйте еще раз.');
        }
    }

    async function login() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        const formData = new URLSearchParams();
        formData.append('username', username);
        formData.append('password', password);

        try {
            const response = await fetch(`${API_URL}/token`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error('Incorrect username or password');
            }

            const result = await response.json();
            localStorage.setItem('accessToken', result.access_token);
            checkAuthentication();
            authModal.classList.remove('active');
            showPage('mainPage');
        } catch (error) {
            alert('Ошибка входа: ' + error.message);
            console.error('Login error:', error);
        }
    }

    async function getProfile() {
        const token = localStorage.getItem('accessToken');
        if (!token) return null;

        try {
            const response = await fetch(`${API_URL}/users/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.status === 401) {
                localStorage.removeItem('accessToken');
                return null;
            }

            if (!response.ok) {
                throw new Error('Failed to fetch profile');
            }

            const profile = await response.json();
            return profile;
        } catch (error) {
            console.error('Profile fetch error:', error);
            return null;
        }
    }

    async function checkAuthentication() {
        const user = await getProfile();
        if (user) {
            authStatusEl.style.display = 'none';
            userProfileEl.style.display = 'flex';
            document.querySelector('.username').textContent = user.user_name;
            document.querySelector('.user-type').textContent = user.user_type;
            document.getElementById('profileUsername').textContent = user.username;
            document.getElementById('profileName').textContent = user.user_name;
            document.getElementById('profileType').textContent = user.user_type;
            document.getElementById('profileCity').textContent = getSelectedCity() ? getSelectedCity().name : 'Не выбран';
            document.getElementById('profileSpecialization').textContent = user.specialization || 'Нет';
            
            const profilePage = document.getElementById('profilePage');
            if (user.user_type !== 'ИСПОЛНИТЕЛЬ' && user.user_type !== 'ВЛАДЕЛЕЦ СПЕЦТЕХНИКИ') {
                document.getElementById('profileSpecialization').parentElement.style.display = 'none';
            } else {
                document.getElementById('profileSpecialization').parentElement.style.display = 'block';
            }

        } else {
            authStatusEl.style.display = 'block';
            authStatusEl.textContent = 'Вы не авторизованы';
            userProfileEl.style.display = 'none';
        }
    }

    async function fetchAllRequests(city_id = null) {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            allRequestsList.innerHTML = '<p>Пожалуйста, войдите, чтобы просматривать заявки.</p>';
            return;
        }

        let url = `${API_URL}/work-requests`;
        if (city_id) {
            url += `?city_id=${city_id}`;
        }
        
        try {
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                throw new Error('Failed to fetch requests');
            }
            const requests = await response.json();
            allRequestsList.innerHTML = '';
            if (requests.length === 0) {
                allRequestsList.innerHTML = '<p>Нет доступных заявок в этом городе.</p>';
            } else {
                requests.forEach(req => {
                    const card = document.createElement('div');
                    card.className = 'request-card';
                    card.innerHTML = `
                        <h4>${req.work_type}</h4>
                        <p>${req.description}</p>
                        <p><strong>Город:</strong> ${getSelectedCity().name}</p>
                        <button class="action-btn">Подробнее</button>
                    `;
                    allRequestsList.appendChild(card);
                });
            }
        } catch (error) {
            console.error('Error fetching requests:', error);
            allRequestsList.innerHTML = '<p>Ошибка при загрузке заявок.</p>';
        }
    }

    async function fetchMyRequests() {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            myRequestsList.innerHTML = '<p>Пожалуйста, войдите, чтобы просматривать свои заявки.</p>';
            return;
        }

        try {
            const response = await fetch(`${API_URL}/users/my-requests`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                throw new Error('Failed to fetch my requests');
            }
            const requests = await response.json();
            myRequestsList.innerHTML = '';
            if (requests.length === 0) {
                myRequestsList.innerHTML = '<p>У вас пока нет заявок.</p>';
            } else {
                requests.forEach(req => {
                    const card = document.createElement('div');
                    card.className = 'request-card';
                    card.innerHTML = `
                        <div class="request-type">${req.request_type}</div>
                        <h4>${req.work_type || req.machinery_type || req.material_type || req.tools.join(', ')}</h4>
                        <p>${req.description}</p>
                        <p><strong>Город:</strong> ${getSelectedCity().name}</p>
                    `;
                    myRequestsList.appendChild(card);
                });
            }
        } catch (error) {
            console.error('Error fetching my requests:', error);
            myRequestsList.innerHTML = '<p>Ошибка при загрузке ваших заявок.</p>';
        }
    }

    async function submitWorkRequest(data) {
        const token = localStorage.getItem('accessToken');
        const url = `${API_URL}/work-requests`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error('Failed to submit work request');
            }

            const result = await response.json();
            console.log('Work request submitted successfully:', result);
            showPage('myRequestsPage');
            fetchMyRequests();
            alert('Заявка на работы успешно отправлена!');
        } catch (error) {
            console.error('Error submitting work request:', error);
            alert('Ошибка при отправке заявки на работы. Попробуйте еще раз.');
        }
    }

    async function submitMachineryRequest(data) {
        const token = localStorage.getItem('accessToken');
        const url = `${API_URL}/machinery-requests`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error('Failed to submit machinery request');
            }

            const result = await response.json();
            console.log('Machinery request submitted successfully:', result);
            showPage('myRequestsPage');
            fetchMyRequests();
            alert('Заявка на технику успешно отправлена!');
        } catch (error) {
            console.error('Error submitting machinery request:', error);
            alert('Ошибка при отправке заявки на технику. Попробуйте еще раз.');
        }
    }

    async function submitToolRequest(data) {
        const token = localStorage.getItem('accessToken');
        const url = `${API_URL}/tool-requests`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error('Failed to submit tool request');
            }

            const result = await response.json();
            console.log('Tool request submitted successfully:', result);
            showPage('myRequestsPage');
            fetchMyRequests();
            alert('Заявка на инструмент успешно отправлена!');
        } catch (error) {
            console.error('Error submitting tool request:', error);
            alert('Ошибка при отправке заявки на инструмент. Попробуйте еще раз.');
        }
    }

    async function submitMaterialAd(data) {
        const token = localStorage.getItem('accessToken');
        const url = `${API_URL}/material-ads`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error('Failed to submit material ad');
            }

            const result = await response.json();
            console.log('Material ad submitted successfully:', result);
            showPage('myRequestsPage');
            fetchMyRequests();
            alert('Объявление о материалах успешно отправлено!');
        } catch (error) {
            console.error('Error submitting material ad:', error);
            alert('Ошибка при отправке объявления. Попробуйте еще раз.');
        }
    }

    // Event Listeners
    saveCityBtn.addEventListener('click', () => {
        const selectedCity = citySelectModal.options[citySelectModal.selectedIndex];
        if (selectedCity && selectedCity.value !== '') {
            const city = {
                id: parseInt(selectedCity.value, 10),
                name: selectedCity.textContent
            };
            localStorage.setItem('selectedCity', JSON.stringify(city));
            cityNameEl.textContent = city.name;
            cityModal.classList.remove('active');
            checkAuthentication();
            showPage('mainPage');
        } else {
            alert('Пожалуйста, выберите город.');
        }
    });

    changeCityBtn.addEventListener('click', () => {
        cityModal.classList.add('active');
        fetchCities();
    });

    loginBtn.addEventListener('click', () => {
        login();
    });

    registerBtn.addEventListener('click', () => {
        submitAuthForm('register');
    });

    logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('accessToken');
        showPage('mainPage');
    });

    profileBtn.addEventListener('click', () => {
        showPage('profilePage');
    });

    myRequestsBtn.addEventListener('click', () => {
        showPage('myRequestsPage');
        fetchMyRequests();
    });

    const workRequestForm = document.getElementById('requestForm');
    workRequestBtn.addEventListener('click', () => {
        showPage('requestPage');
        // ✅ ИСПРАВЛЕНО: Города для формы "Найти мастера" загружаются при переходе
        fetchCities();
    });

    const machineryRequestForm = document.getElementById('machineryForm');
    machineryRequestBtn.addEventListener('click', () => {
        showPage('machineryPage');
        fetchMachineryTypes();
    });

    const toolRequestForm = document.getElementById('toolsForm');
    toolRequestBtn.addEventListener('click', () => {
        showPage('toolsPage');
        fetchToolsList();
    });

    const materialAdForm = document.getElementById('materialForm');
    materialAdBtn.addEventListener('click', () => {
        showPage('materialsPage');
    });

    marketplaceBtn.addEventListener('click', () => {
        showPage('marketplacePage');
        const selectedCity = getSelectedCity();
        const cityId = selectedCity ? selectedCity.id : null;
        if (cityId) {
            fetchAllRequests(cityId);
        } else {
            alert('Пожалуйста, выберите город, чтобы просмотреть все заявки.');
            showPage('mainPage');
        }
    });

    // ✅ ИСПРАВЛЕНО: Города для фильтра на странице "Все заявки" загружаются здесь
    document.getElementById('marketplaceBtn').addEventListener('click', () => {
        showPage('marketplacePage');
        fetchCities();
        const selectedCity = getSelectedCity();
        const cityId = selectedCity ? selectedCity.id : null;
        if (cityId) {
            fetchAllRequests(cityId);
        } else {
            alert('Пожалуйста, выберите город, чтобы просмотреть все заявки.');
            showPage('mainPage');
        }
    });

    marketplaceFilterCity.addEventListener('change', (e) => {
        const cityId = e.target.value ? parseInt(e.target.value, 10) : null;
        fetchAllRequests(cityId);
    });

    const visitCheckbox = document.getElementById('visitCheckbox');
    const workAddressInput = document.getElementById('workAddress');
    visitCheckbox.addEventListener('change', () => {
        workAddressInput.style.display = visitCheckbox.checked ? 'block' : 'none';
        workAddressInput.required = visitCheckbox.checked;
    });

    const preorderCheckbox = document.getElementById('preorderCheckbox');
    const preorderDateInput = document.getElementById('preorderDate');
    preorderCheckbox.addEventListener('change', () => {
        preorderDateInput.style.display = preorderCheckbox.checked ? 'block' : 'none';
        preorderDateInput.required = preorderCheckbox.checked;
    });

    const deliveryCheckbox = document.getElementById('deliveryCheckbox');
    const deliveryAddressInput = document.getElementById('deliveryAddress');
    deliveryCheckbox.addEventListener('change', () => {
        deliveryAddressInput.style.display = deliveryCheckbox.checked ? 'block' : 'none';
        deliveryAddressInput.required = deliveryCheckbox.checked;
    });

    document.getElementById('registerTab').querySelector('select').addEventListener('change', function() {
        if (this.value === 'ИСПОЛНИТЕЛЬ' || this.value === 'ВЛАДЕЛЕЦ СПЕЦТЕХНИКИ') {
            specializationGroup.style.display = 'block';
        } else {
            specializationGroup.style.display = 'none';
        }
    });

    // ✅ ИСПРАВЛЕНО: Теперь city_id берется из формы
    document.getElementById('requestForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const workType = document.getElementById('workType').value;
        const needsVisit = document.getElementById('visitCheckbox').checked;
        const address = document.getElementById('workAddress').value;
        const description = document.getElementById('requestDescription').value;
        const city_id = parseInt(document.getElementById('citySelect').value, 10);

        if (!city_id) {
            alert('Пожалуйста, выберите город перед отправкой заявки.');
            return;
        }

        const requestData = {
            work_type: workType,
            needs_visit: needsVisit,
            description: description,
            city_id: city_id
        };

        if (needsVisit) {
            if (!address) {
                alert('Пожалуйста, укажите адрес для выезда.');
                return;
            }
            requestData.address = address;
        }

        try {
            await submitWorkRequest(requestData);
        } catch (error) {
            console.error('Error submitting work request:', error);
            alert('Error submitting work request: ' + error.message);
        }
    });

    document.getElementById('machineryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const machineryType = document.getElementById('machineryType').value;
        const machineryAddress = document.getElementById('machineryAddress').value;
        const isMinOrder = document.getElementById('minOrderCheckbox').checked;
        const isPreorder = document.getElementById('preorderCheckbox').checked;
        const preorderDate = document.getElementById('preorderDate').value;
        const machineryDescription = document.getElementById('machineryDescription').value;
        const city = getSelectedCity();

        if (!city) {
            alert('Пожалуйста, выберите город.');
            return;
        }

        const requestData = {
            machinery_type: machineryType,
            address: machineryAddress,
            is_min_order: isMinOrder,
            is_preorder: isPreorder,
            preorder_date: isPreorder ? preorderDate : null,
            description: machineryDescription,
            city_id: city.id
        };

        await submitMachineryRequest(requestData);
    });

    document.getElementById('toolsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const selectedTools = Array.from(toolsCheckboxesDiv.querySelectorAll('input:checked')).map(cb => cb.value);
        const startDate = document.getElementById('toolsStartDate').value;
        const endDate = document.getElementById('toolsEndDate').value;
        const needsDelivery = document.getElementById('deliveryCheckbox').checked;
        const deliveryAddress = document.getElementById('deliveryAddress').value;
        const description = document.getElementById('toolsDescription').value;
        const city = getSelectedCity();

        if (!city) {
            alert('Пожалуйста, выберите город.');
            return;
        }

        const requestData = {
            tools: selectedTools,
            start_date: startDate,
            end_date: endDate,
            needs_delivery: needsDelivery,
            delivery_address: needsDelivery ? deliveryAddress : null,
            description: description,
            city_id: city.id
        };
        await submitToolRequest(requestData);
    });

    document.getElementById('materialForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const materialType = document.getElementById('materialType').value;
        const materialDescription = document.getElementById('materialDescription').value;
        const materialPrice = parseFloat(document.getElementById('materialPrice').value);
        const city = getSelectedCity();

        if (!city) {
            alert('Пожалуйста, выберите город.');
            return;
        }
        
        const requestData = {
            material_type: materialType,
            description: materialDescription,
            price: materialPrice,
            city_id: city.id
        };

        await submitMaterialAd(requestData);
    });

    document.getElementById('backToMainFromRequest').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
    document.getElementById('backToMainFromMachinery').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
    document.getElementById('backToMainFromTools').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
    document.getElementById('backToMainFromMaterials').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
    document.getElementById('backToMainFromTakeOrder').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
    document.getElementById('backToMainFromMarketplace').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
    document.getElementById('backToProfileFromRequests').addEventListener('click', (e) => { e.preventDefault(); showPage('profilePage'); });
    document.getElementById('backToMain').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
    
    // Initial setup
    fetchCities();
    fetchSpecializations();
    fetchMachineryTypes();
    fetchToolsList();
    if (getSelectedCity()) {
        cityNameEl.textContent = getSelectedCity().name;
        checkAuthentication();
    } else {
        cityModal.classList.add('active');
    }
</script>
</body>
</html>