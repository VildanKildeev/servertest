<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СМЗ.РФ - Рабочие и спецтехника</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #2B2117; /* Темно-коричневый */
            --card-color: #F7EFE3; /* Светло-бежевый */
            --text-color: #F7EFE3; /* Светло-бежевый для текста на темном фоне */
            --ink-color: #2B2117; /* Темно-коричневый для текста на светлом фоне */
            --accent-color: #3C7A5D; /* Насыщенный зеленый */
            --accent-hover: #2F644A; /* Более темный зеленый */
            --yellow-accent: #BFA17E; /* Желтый/золотой акцент */
            --red-accent: #D64545; /* Красный для ошибок */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 1.5rem;
            background-color: var(--card-color);
            color: var(--ink-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        h1, h2, h3 {
            color: var(--ink-color);
            margin-bottom: 1rem;
            text-align: center;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--yellow-accent);
            border-radius: 8px;
            background-color: var(--text-color);
            color: var(--ink-color);
            font-size: 1rem;
        }

        button {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            margin-top: 0.5rem;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: var(--text-color);
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
            transform: translateY(-2px);
        }
        
        .btn-logout {
            background-color: var(--red-accent);
            color: white;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--ink-color);
            border: 1px solid var(--ink-color);
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
        }

        .toggle-btn {
            background-color: var(--yellow-accent);
            color: var(--ink-color);
        }

        .toggle-btn.active {
            background-color: var(--accent-color);
            color: var(--text-color);
        }
        
        .toggle-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .info-card, .listing-card {
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .info-card h4 {
            color: var(--text-color);
        }

        .listing-card h4 {
            color: var(--yellow-accent);
            margin-bottom: 0.5rem;
        }
        
        .listing-card p {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-color);
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-buttons button {
            margin-top: 1rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        #cityName {
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
        }

        #logoutBtn {
            background-color: var(--red-accent);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .message {
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .message.success {
            color: var(--accent-color);
        }
        
        .message.error {
            color: var(--red-accent);
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div id="cityModal" class="modal">
            <div class="modal-content">
                <h2>Выберите ваш город</h2>
                <div class="form-group">
                    <select id="citySelect"></select>
                </div>
                <button id="saveCityBtn" class="btn-primary">Сохранить</button>
            </div>
        </div>

        <div id="loginPage" class="page active">
            <h2>Вход</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">Имя пользователя</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Пароль</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn-primary">Войти</button>
            </form>
            <button id="showRegisterBtn" class="btn-secondary">Зарегистрироваться</button>
        </div>
        
        <div id="registerPage" class="page">
            <h2>Регистрация</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="regUsername">Имя пользователя (ник)</label>
                    <input type="text" id="regUsername" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">Пароль</label>
                    <input type="password" id="regPassword" required>
                </div>
                <div class="form-group">
                    <label for="regName">Ваше имя</label>
                    <input type="text" id="regName" required>
                </div>
                <div class="form-group">
                    <label for="regCitySelect">Город</label>
                    <select id="regCitySelect" required></select>
                </div>
                <div class="form-group">
                    <label>Тип пользователя</label>
                    <div class="toggle-group">
                        <button type="button" id="toggleCustomer" class="toggle-btn active" data-type="customer">Заказчик</button>
                        <button type="button" id="toggleExecutor" class="toggle-btn" data-type="executor">Исполнитель</button>
                    </div>
                </div>
                <div class="form-group" id="specializationGroup" style="display: none;">
                    <label for="regSpecialization">Специализация</label>
                    <select id="regSpecialization"></select>
                </div>
                <button type="submit" class="btn-primary">Зарегистрироваться</button>
            </form>
            <button id="showLoginBtn" class="btn-secondary">Уже есть аккаунт?</button>
        </div>
        
        <div id="buttonContainer" class="page">
            <div class="header">
                <h2 id="cityName"></h2>
                <button id="logoutBtn" class="btn-logout">Выйти</button>
            </div>
            <h2>СМЗ.РФ</h2>
            <div id="userProfile" class="info-card"></div>
            <button id="createWorkBtn" class="btn-primary">Разместить заявку на работу</button>
            <button id="findWorkBtn" class="btn-secondary">Найти работу</button>
            <button id="machineryBtn" class="btn-primary">Спецтехника</button>
            <button id="toolsBtn" class="btn-secondary">Инструменты</button>
            <button id="materialsBtn" class="btn-primary">Материалы</button>
        </div>

        <div id="createWorkPage" class="page">
            <div class="header">
                <button id="backToMainFromCreateWork" class="btn-secondary"><i class="fas fa-arrow-left"></i> Назад</button>
                <h2>Новая заявка</h2>
            </div>
            <form id="createWorkForm">
                <div class="form-group">
                    <label for="workTitle">Заголовок</label>
                    <input type="text" id="workTitle" required>
                </div>
                <div class="form-group">
                    <label for="workDescription">Описание</label>
                    <textarea id="workDescription"></textarea>
                </div>
                <div class="form-group">
                    <label for="workSpecialization">Специализация</label>
                    <select id="workSpecialization" required></select>
                </div>
                <div class="form-group">
                    <label for="workContact">Контакты</label>
                    <input type="text" id="workContact" required>
                </div>
                <button type="submit" class="btn-primary">Разместить</button>
            </form>
        </div>

        <div id="findWorkPage" class="page">
            <div class="header">
                <button id="backToMainFromFindWork" class="btn-secondary"><i class="fas fa-arrow-left"></i> Назад</button>
                <h2>Найти работу</h2>
            </div>
            <div id="workRequestsList"></div>
        </div>

        <div id="machineryPage" class="page">
            <div class="header">
                <button id="backToMainFromMachinery" class="btn-secondary"><i class="fas fa-arrow-left"></i> Назад</button>
                <h2>Спецтехника</h2>
            </div>
            <button id="createMachineryBtn" class="btn-primary">Разместить объявление</button>
            <div id="machineryRequestsList"></div>
        </div>
        
        <div id="createMachineryPage" class="page">
            <div class="header">
                <button id="backToMainFromCreateMachinery" class="btn-secondary"><i class="fas fa-arrow-left"></i> Назад</button>
                <h2>Новое объявление</h2>
            </div>
            <form id="createMachineryForm">
                <div class="form-group">
                    <label for="machineryType">Тип техники</label>
                    <select id="machineryType" required></select>
                </div>
                <div class="form-group">
                    <label for="machineryDesc">Описание</label>
                    <textarea id="machineryDesc"></textarea>
                </div>
                <div class="form-group">
                    <label for="machineryPrice">Цена за аренду</label>
                    <input type="number" id="machineryPrice" step="0.01">
                </div>
                <div class="form-group">
                    <label for="machineryContact">Контакты</label>
                    <input type="text" id="machineryContact" required>
                </div>
                <button type="submit" class="btn-primary">Разместить</button>
            </form>
        </div>

        <div id="toolsPage" class="page">
            <div class="header">
                <button id="backToMainFromTools" class="btn-secondary"><i class="fas fa-arrow-left"></i> Назад</button>
                <h2>Инструменты</h2>
            </div>
            <button id="createToolBtn" class="btn-primary">Разместить объявление</button>
            <div id="toolRequestsList"></div>
        </div>
        
        <div id="createToolPage" class="page">
            <div class="header">
                <button id="backToMainFromCreateTool" class="btn-secondary"><i class="fas fa-arrow-left"></i> Назад</button>
                <h2>Новое объявление</h2>
            </div>
            <form id="createToolForm">
                <div class="form-group">
                    <label for="toolType">Тип инструмента</label>
                    <select id="toolType" required></select>
                </div>
                <div class="form-group">
                    <label for="toolDesc">Описание</label>
                    <textarea id="toolDesc"></textarea>
                </div>
                <div class="form-group">
                    <label for="toolPrice">Цена за аренду</label>
                    <input type="number" id="toolPrice" step="0.01">
                </div>
                <div class="form-group">
                    <label for="toolContact">Контакты</label>
                    <input type="text" id="toolContact" required>
                </div>
                <button type="submit" class="btn-primary">Разместить</button>
            </form>
        </div>
        
        <div id="materialsPage" class="page">
            <div class="header">
                <button id="backToMainFromMaterials" class="btn-secondary"><i class="fas fa-arrow-left"></i> Назад</button>
                <h2>Материалы</h2>
            </div>
            <button id="createMaterialBtn" class="btn-primary">Разместить объявление</button>
            <div id="materialAdsList"></div>
        </div>
        
        <div id="createMaterialPage" class="page">
            <div class="header">
                <button id="backToMainFromCreateMaterial" class="btn-secondary"><i class="fas fa-arrow-left"></i> Назад</button>
                <h2>Новое объявление</h2>
            </div>
            <form id="createMaterialForm">
                <div class="form-group">
                    <label for="materialType">Тип материала</label>
                    <select id="materialType" required></select>
                </div>
                <div class="form-group">
                    <label for="materialDesc">Описание</label>
                    <textarea id="materialDesc"></textarea>
                </div>
                <div class="form-group">
                    <label for="materialPrice">Цена</label>
                    <input type="number" id="materialPrice" step="0.01">
                </div>
                <div class="form-group">
                    <label for="materialContact">Контакты</label>
                    <input type="text" id="materialContact" required>
                </div>
                <button type="submit" class="btn-primary">Разместить</button>
            </form>
        </div>
    </div>
<script>
    // --- ПЕРЕМЕННЫЕ И ХРАНИЛИЩА ---
    let accessToken = null;
    let userData = {};
    const state = {
        cities: [],
        specializations: [],
        machineryTypes: [],
        toolTypes: [],
        materialTypes: [],
    };
    const messageBox = document.createElement('div');
    messageBox.className = 'message';
    document.body.prepend(messageBox);

    // --- УТИЛИТЫ ---
    const el = (id) => document.getElementById(id);
    const showMessage = (text, type = 'success') => {
        messageBox.textContent = text;
        messageBox.className = `message ${type}`;
        clearTimeout(messageBox.timer);
        messageBox.timer = setTimeout(() => {
            messageBox.textContent = '';
            messageBox.className = 'message';
        }, 5000);
    };

    const showPage = (pageId) => {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        el(pageId).classList.add('active');
    };

    // --- УНИВЕРСАЛЬНАЯ ФУНКЦИЯ ДЛЯ FETCH ---
    const apiFetch = async (url, method = 'GET', body = null, auth = true) => {
        const headers = { 'Content-Type': 'application/json' };
        if (auth && accessToken) {
            headers['Authorization'] = `Bearer ${accessToken}`;
        }

        const options = { method, headers };
        if (body) {
            options.body = JSON.stringify(body);
        }

        const response = await fetch(url, options);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Произошла ошибка');
        }
        return response.json();
    };

    // --- УНИВЕРСАЛЬНЫЕ ФУНКЦИИ ДЛЯ РЕНДЕРИНГА И СБОРА ДАННЫХ ---
    const populateSelect = (selectId, data) => {
        const select = el(selectId);
        select.innerHTML = '';
        if (!data) return;
        data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.name;
            select.appendChild(option);
        });
    };

    const getSelectedCity = () => {
        const city = localStorage.getItem('selectedCity');
        return city ? JSON.parse(city) : null;
    };

    const updateCityDisplay = () => {
        const city = getSelectedCity();
        if (city) {
            el('cityName').textContent = city.name;
        }
    };

    const fetchProfile = async () => {
        try {
            const profile = await apiFetch('/api/profile');
            userData = profile;
            const profileCard = el('userProfile');
            const specialization = state.specializations.find(s => s.id === userData.specialization_id);
            profileCard.innerHTML = `
                <h4>Привет, ${profile.user_name}!</h4>
                <p><strong>Тип:</strong> ${profile.user_type === 'executor' ? 'Исполнитель' : 'Заказчик'}</p>
                ${specialization ? `<p><strong>Специализация:</strong> ${specialization.name}</p>` : ''}
            `;
        } catch (error) {
            showMessage(`Ошибка получения профиля: ${error.message}`, 'error');
            logout();
        }
    };

    const fetchCities = async () => {
        try {
            state.cities = await apiFetch('/api/cities', 'GET', null, false);
            populateSelect('citySelect', state.cities);
            populateSelect('regCitySelect', state.cities);
        } catch (error) {
            showMessage('Ошибка загрузки городов: ' + error.message, 'error');
        }
    };

    const fetchSpecializations = async () => {
        try {
            state.specializations = await apiFetch('/api/specializations', 'GET', null, false);
            populateSelect('regSpecialization', state.specializations);
            if (userData.specialization_id) {
                const specialization = state.specializations.find(s => s.id === userData.specialization_id);
                if (specialization) {
                    el('userProfile').innerHTML += `<p><strong>Специализация:</strong> ${specialization.name}</p>`;
                }
            }
        } catch (error) {
            showMessage('Ошибка загрузки специализаций: ' + error.message, 'error');
        }
    };

    const fetchMachineryTypes = async () => {
        try {
            state.machineryTypes = await apiFetch('/api/machinery-types', 'GET', null, false);
            populateSelect('machineryType', state.machineryTypes);
        } catch (error) {
            showMessage('Ошибка загрузки типов техники: ' + error.message, 'error');
        }
    };

    const fetchToolTypes = async () => {
        try {
            state.toolTypes = await apiFetch('/api/tool-types', 'GET', null, false);
            populateSelect('toolType', state.toolTypes);
        } catch (error) {
            showMessage('Ошибка загрузки типов инструментов: ' + error.message, 'error');
        }
    };

    const fetchMaterialTypes = async () => {
        try {
            state.materialTypes = await apiFetch('/api/material-types', 'GET', null, false);
            populateSelect('materialType', state.materialTypes);
        } catch (error) {
            showMessage('Ошибка загрузки типов материалов: ' + error.message, 'error');
        }
    };

    const createListing = async (endpoint, formData, formId, renderFunction) => {
        try {
            await apiFetch(endpoint, 'POST', formData);
            showMessage('Объявление успешно размещено!');
            document.getElementById(formId).reset();
            showPage('buttonContainer');
            if (renderFunction) {
                renderFunction();
            }
        } catch (error) {
            showMessage(`Ошибка: ${error.message}`, 'error');
        }
    };

    const createWorkRequest = (e) => {
        e.preventDefault();
        const city = getSelectedCity();
        if (!city) {
            showMessage('Пожалуйста, выберите город.', 'error');
            return;
        }
        const requestData = {
            title: el('workTitle').value,
            description: el('workDescription').value,
            contact_info: el('workContact').value,
            city_id: city.id,
            specialization_id: parseInt(el('workSpecialization').value),
            is_public: true,
        };
        createListing('/api/work-requests', requestData, 'createWorkForm', fetchWorkRequests);
    };

    const createMachineryAd = (e) => {
        e.preventDefault();
        const city = getSelectedCity();
        if (!city) {
            showMessage('Пожалуйста, выберите город.', 'error');
            return;
        }
        const requestData = {
            machinery_type_id: parseInt(el('machineryType').value),
            description: el('machineryDesc').value,
            rental_price: parseFloat(el('machineryPrice').value),
            contact_info: el('machineryContact').value,
            city_id: city.id,
        };
        createListing('/api/machinery-requests', requestData, 'createMachineryForm', fetchMachineryRequests);
    };

    const createToolAd = (e) => {
        e.preventDefault();
        const city = getSelectedCity();
        if (!city) {
            showMessage('Пожалуйста, выберите город.', 'error');
            return;
        }
        const requestData = {
            tool_type_id: parseInt(el('toolType').value),
            description: el('toolDesc').value,
            rental_price: parseFloat(el('toolPrice').value),
            contact_info: el('toolContact').value,
            city_id: city.id,
        };
        createListing('/api/tool-requests', requestData, 'createToolForm', fetchToolsRequests);
    };

    const createMaterialAd = (e) => {
        e.preventDefault();
        const city = getSelectedCity();
        if (!city) {
            showMessage('Пожалуйста, выберите город.', 'error');
            return;
        }
        const requestData = {
            material_type_id: parseInt(el('materialType').value),
            description: el('materialDesc').value,
            price: parseFloat(el('materialPrice').value),
            contact_info: el('materialContact').value,
            city_id: city.id,
        };
        createListing('/api/material-ads', requestData, 'createMaterialForm', fetchMaterialAds);
    };

    const renderListings = (listElementId, data, type) => {
        const list = el(listElementId);
        list.innerHTML = '';
        if (data.length === 0) {
            list.innerHTML = '<p>Объявлений пока нет.</p>';
            return;
        }

        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'listing-card';

            let content = '';
            switch (type) {
                case 'work':
                    content = `
                        <h4>${item.title}</h4>
                        <p><strong>Специализация:</strong> ${item.specialization}</p>
                        <p><strong>Город:</strong> ${item.city}</p>
                        <p><strong>Описание:</strong> ${item.description || 'Не указано'}</p>
                        <p><strong>Контакты:</strong> ${item.contact_info}</p>
                        <p><strong>Опубликовано:</strong> ${item.user_name}</p>
                        ${item.is_taken ?
                            `<p style="color:var(--red-accent);"><strong>Заявка принята. Исполнитель: ${item.executor_name || 'Не указано'}</strong></p>` :
                            (userData.user_type === 'executor' ? `<button class="btn-primary take-request-btn" data-id="${item.id}">Взять работу</button>` : '')
                        }
                    `;
                    break;
                case 'machinery':
                    const machineryType = state.machineryTypes.find(t => t.id === item.machinery_type_id)?.name;
                    content = `
                        <h4>${machineryType}</h4>
                        <p><strong>Описание:</strong> ${item.description || 'Не указано'}</p>
                        <p><strong>Цена:</strong> ${item.rental_price ? `${item.rental_price} ₽` : 'Не указана'}</p>
                        <p><strong>Контакты:</strong> ${item.contact_info}</p>
                    `;
                    break;
                case 'tool':
                    const toolType = state.toolTypes.find(t => t.id === item.tool_type_id)?.name;
                    content = `
                        <h4>${toolType}</h4>
                        <p><strong>Описание:</strong> ${item.description || 'Не указано'}</p>
                        <p><strong>Цена:</strong> ${item.rental_price ? `${item.rental_price} ₽` : 'Не указана'}</p>
                        <p><strong>Контакты:</strong> ${item.contact_info}</p>
                    `;
                    break;
                case 'material':
                    const materialType = state.materialTypes.find(t => t.id === item.material_type_id)?.name;
                    content = `
                        <h4>${materialType}</h4>
                        <p><strong>Описание:</strong> ${item.description || 'Не указано'}</p>
                        <p><strong>Цена:</strong> ${item.price ? `${item.price} ₽` : 'Не указана'}</p>
                        <p><strong>Контакты:</strong> ${item.contact_info}</p>
                    `;
                    break;
            }
            card.innerHTML = content;
            list.appendChild(card);
        });

        if (type === 'work') {
            document.querySelectorAll('.take-request-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const requestId = e.target.getAttribute('data-id');
                    try {
                        await apiFetch(`/api/work-requests/${requestId}/take`, 'POST');
                        showMessage('Заявка успешно принята!', 'success');
                        await fetchWorkRequests();
                    } catch (error) {
                        showMessage(`Ошибка: ${error.message}`, 'error');
                    }
                });
            });
        }
    };

    const fetchWorkRequests = async () => {
        const city = getSelectedCity();
        const endpoint = city ? `/api/work-requests?city_id=${city.id}` : '/api/work-requests';
        try {
            const data = await apiFetch(endpoint);
            renderListings('workRequestsList', data, 'work');
        } catch (error) {
            showMessage(`Ошибка загрузки заявок: ${error.message}`, 'error');
        }
    };

    const fetchMachineryRequests = async () => {
        const city = getSelectedCity();
        const endpoint = city ? `/api/machinery-requests?city_id=${city.id}` : '/api/machinery-requests';
        try {
            const data = await apiFetch(endpoint);
            renderListings('machineryRequestsList', data, 'machinery');
        } catch (error) {
            showMessage(`Ошибка загрузки спецтехники: ${error.message}`, 'error');
        }
    };

    const fetchToolsRequests = async () => {
        const city = getSelectedCity();
        const endpoint = city ? `/api/tool-requests?city_id=${city.id}` : '/api/tool-requests';
        try {
            const data = await apiFetch(endpoint);
            renderListings('toolRequestsList', data, 'tool');
        } catch (error) {
            showMessage(`Ошибка загрузки инструментов: ${error.message}`, 'error');
        }
    };

    const fetchMaterialAds = async () => {
        const city = getSelectedCity();
        const endpoint = city ? `/api/material-ads?city_id=${city.id}` : '/api/material-ads';
        try {
            const data = await apiFetch(endpoint);
            renderListings('materialAdsList', data, 'material');
        } catch (error) {
            showMessage(`Ошибка загрузки материалов: ${error.message}`, 'error');
        }
    };

    // --- ОБРАБОТЧИКИ СОБЫТИЙ ---
    const setupEventListeners = () => {
        el('saveCityBtn').addEventListener('click', () => {
            const selectedCity = el('citySelect').value;
            const city = state.cities.find(c => c.id === parseInt(selectedCity));
            if (city) {
                localStorage.setItem('selectedCity', JSON.stringify(city));
                updateCityDisplay();
                el('cityModal').classList.remove('active');
                checkAuthentication();
            }
        });

        el('cityName').addEventListener('click', () => el('cityModal').classList.add('active'));

        el('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = el('loginUsername').value;
            const password = el('loginPassword').value;
            const formData = new URLSearchParams();
            formData.append('username', username);
            formData.append('password', password);

            try {
                const response = await fetch('/api/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Неверные данные');
                }
                const data = await response.json();
                accessToken = data.access_token;
                localStorage.setItem('accessToken', accessToken);
                await fetchProfile();
                showPage('buttonContainer');
                showMessage('Вход выполнен успешно!');
            } catch (error) {
                showMessage(`Ошибка входа: ${error.message}`, 'error');
            }
        });

        el('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userType = el('toggleCustomer').classList.contains('active') ? 'customer' : 'executor';
            const specializationId = userType === 'executor' ? parseInt(el('regSpecialization').value) : null;
            const userData = {
                username: el('regUsername').value,
                password: el('regPassword').value,
                user_name: el('regName').value,
                user_type: userType,
                city_id: parseInt(el('regCitySelect').value),
                specialization_id: specializationId
            };
            try {
                const response = await apiFetch('/api/register', 'POST', userData, false);
                showMessage(response.message);
                el('registerForm').reset();
                showPage('loginPage');
            } catch (error) {
                showMessage(`Ошибка регистрации: ${error.message}`, 'error');
            }
        });

        el('logoutBtn').addEventListener('click', logout);

        el('toggleCustomer').addEventListener('click', () => {
            el('toggleCustomer').classList.add('active');
            el('toggleExecutor').classList.remove('active');
            el('specializationGroup').style.display = 'none';
        });
        el('toggleExecutor').addEventListener('click', () => {
            el('toggleExecutor').classList.add('active');
            el('toggleCustomer').classList.remove('active');
            el('specializationGroup').style.display = 'block';
        });

        el('showRegisterBtn').addEventListener('click', () => showPage('registerPage'));
        el('showLoginBtn').addEventListener('click', () => showPage('loginPage'));
        el('createWorkBtn').addEventListener('click', () => showPage('createWorkPage'));
        el('findWorkBtn').addEventListener('click', () => {
            fetchWorkRequests();
            showPage('findWorkPage');
        });
        el('machineryBtn').addEventListener('click', () => {
            fetchMachineryRequests();
            showPage('machineryPage');
        });
        el('toolsBtn').addEventListener('click', () => {
            fetchToolTypes(); // Исправлено: вызываем fetchToolTypes
            showPage('toolsPage');
        });
        el('materialsBtn').addEventListener('click', () => {
            fetchMaterialAds();
            showPage('materialsPage');
        });
        el('createMachineryBtn').addEventListener('click', () => showPage('createMachineryPage'));
        el('createToolBtn').addEventListener('click', () => showPage('createToolPage'));
        el('createMaterialBtn').addEventListener('click', () => showPage('createMaterialPage'));

        el('createWorkForm').addEventListener('submit', createWorkRequest);
        el('createMachineryForm').addEventListener('submit', createMachineryAd);
        el('createToolForm').addEventListener('submit', createToolAd);
        el('createMaterialForm').addEventListener('submit', createMaterialAd);

        const backButtons = ['backToMainFromCreateWork', 'backToMainFromFindWork', 'backToMainFromMachinery', 'backToMainFromTools', 'backToMainFromMaterials', 'backToMainFromCreateMachinery', 'backToMainFromCreateTool', 'backToMainFromCreateMaterial'];
        backButtons.forEach(btnId => {
            const btn = el(btnId);
            if (btn) btn.addEventListener('click', () => showPage('buttonContainer'));
        });
    }

    // --- АУТЕНТИФИКАЦИЯ И ИНИЦИАЛИЗАЦИЯ ---
    const checkAuthentication = async () => {
        accessToken = localStorage.getItem('accessToken');
        if (accessToken) {
            await fetchProfile();
            showPage('buttonContainer');
        } else {
            showPage('loginPage');
        }
    };

    const logout = () => {
        localStorage.removeItem('accessToken');
        accessToken = null;
        userData = {};
        showPage('loginPage');
        showMessage('Вы вышли из аккаунта.', 'success');
    };

    document.addEventListener('DOMContentLoaded', async () => {
        await fetchCities();
        await fetchSpecializations();
        await fetchMachineryTypes();
        await fetchToolTypes(); // Исправлено: вызываем fetchToolTypes
        await fetchMaterialTypes();
        setupEventListeners();

        if (getSelectedCity()) {
            updateCityDisplay();
            checkAuthentication();
        } else {
            el('cityModal').classList.add('active');
        }
    });
</script>
</body>
</html>