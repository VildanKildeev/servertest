<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СМЗ.РФ - Рабочие и спецтехника</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #e6d3b9;
            --bg-2: #d8c3a5;
            --card: #f7efe3;
            --ink: #2b2117;
            --muted: #7b6a57;
            --accent: #2f855a;
            --accent-2: #276749;
            --accent-red: #d64545;
            --accent-dark: #bfa17e;
            --radius: 14px;
            --shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; color: var(--ink); background: var(--bg); -webkit-tap-highlight-color: transparent; touch-action: manipulation; transition: background-color 0.3s ease; }
        .background-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; }
        .selected-city { margin-top: 12px; font-size: 16px; color: var(--ink); text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; flex-wrap: wrap; }
        .selected-city i { font-size: 14px; color: var(--muted); }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; width: 100%; max-width: 500px; padding: 0 20px; box-sizing: border-box; }
        .logo { width: 100%; max-width: 250px; margin-top: 25px; margin-bottom: 25px; }
        .button {
            width: 100%; max-width: 320px; padding: 18px 24px; margin: 8px 0;
            background: var(--card); border: 2px solid var(--accent); color: var(--accent);
            border-radius: var(--radius); font-size: 16px; font-weight: 600;
            cursor: pointer; text-align: center;
            transition: all 0.2s ease; box-shadow: var(--shadow);
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
        .button:hover, .button:focus { background: var(--accent); color: var(--card); }
        .button.primary { background: var(--accent); color: white; border-color: var(--accent); }
        .button.primary:hover, .button.primary:focus { background: var(--accent-2); border-color: var(--accent-2); }
        .button.secondary { background: none; border-color: var(--accent); color: var(--accent); }
        .button.secondary:hover, .button.secondary:focus { background: var(--accent); color: white; }
        .login-input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: var(--radius); border: 1px solid var(--muted); background: var(--card); color: var(--ink); }
        .login-input::placeholder { color: var(--muted); }
        .header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 15px; }
        .header h1 { font-size: 24px; font-weight: 800; }
        .header-text { margin-bottom: 15px; font-size: 18px; font-weight: 600; text-align: center; }
        .profile-container { width: 100%; max-width: 380px; text-align: center; padding: 20px; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); margin-top: 20px; }
        .profile-container h2 { margin-bottom: 10px; color: var(--accent); }
        .profile-container p { margin-bottom: 8px; font-size: 14px; }
        .profile-container .icon { font-size: 20px; color: var(--accent); margin-right: 8px; }
        .form-container { width: 100%; padding: 20px; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); margin-top: 20px; }
        .form-container h2 { color: var(--accent); margin-bottom: 20px; text-align: center; }
        .form-container label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--ink); }
        .form-container .input, .form-container textarea, .form-container select { width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid var(--muted); border-radius: var(--radius); background: var(--bg-2); color: var(--ink); font-family: inherit; font-size: 14px; }
        .form-container .input::placeholder, .form-container textarea::placeholder { color: var(--muted); }
        .form-container .button { width: 100%; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--card); margin: auto; padding: 20px; border-radius: var(--radius); width: 85%; max-width: 400px; text-align: center; box-shadow: var(--shadow); }
        .modal-content h3 { margin-bottom: 20px; color: var(--ink); }
        .modal-content ul { list-style: none; padding: 0; margin-bottom: 15px; }
        .modal-content li { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--bg-2); }
        .modal-content li:last-child { border-bottom: none; }
        .modal-content li:hover { background-color: var(--bg-2); }
        .message { padding: 10px; margin-top: 15px; border-radius: 8px; text-align: center; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .loading { display: flex; justify-content: center; align-items: center; margin-top: 20px; }
        .loader { border: 4px solid var(--bg-2); border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .navbar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: var(--accent-dark); box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; align-items: center;
            padding: 0 10px; z-index: 10;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--card); font-size: 10px; cursor: pointer; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .nav-item.active { color: var(--accent); }
    </style>
</head>
<body>

<video class="background-video" autoplay loop muted poster="placeholder.jpg">
    <source src="background.mp4" type="video/mp4">
</video>

<div class="container">

    <img src="logo.png" alt="СМЗ.РФ" class="logo">

    <div id="loginPage" class="page">
        <h2 class="header-text">Вход</h2>
        <input type="text" id="loginUsername" class="login-input" placeholder="Имя пользователя">
        <input type="password" id="loginPassword" class="login-input" placeholder="Пароль">
        <button id="loginButton" class="button primary">Войти</button>
        <button id="goToRegister" class="button secondary">Регистрация</button>
    </div>

    <div id="registerPage" class="page" style="display:none;">
        <h2 class="header-text">Регистрация</h2>
        <input type="text" id="regUsername" class="login-input" placeholder="Имя пользователя">
        <input type="password" id="regPassword" class="login-input" placeholder="Пароль">
        <input type="text" id="regName" class="login-input" placeholder="Ваше имя">
        <select id="regUserType" class="login-input"></select>
        <select id="regCity" class="login-input"></select>
        <button id="registerButton" class="button primary">Зарегистрироваться</button>
        <button id="backToLogin" class="button secondary">Назад</button>
    </div>

    <div id="buttonContainer" class="page" style="display:none;">
        <h2 class="header-text">Выберите услугу</h2>
        <button id="showWorkRequests" class="button primary">Заявки на работы</button>
        <button id="showMachineryRequests" class="button primary">Спецтехника</button>
        <button id="showToolRequests" class="button primary">Инструменты</button>
        <button id="showMaterialAds" class="button primary">Материалы</button>
        <button id="createRequest" class="button secondary">Разместить заявку</button>
    </div>

    <div id="profilePage" class="page" style="display:none;">
        <h2 class="header-text">Профиль</h2>
        <div class="profile-container">
            <p><i class="fas fa-user icon"></i> Имя: <span id="profileName"></span></p>
            <p><i class="fas fa-id-card icon"></i> Тип пользователя: <span id="profileType"></span></p>
            <p><i class="fas fa-city icon"></i> Город: <span id="profileCity"></span></p>
        </div>
        <button id="logoutButton" class="button secondary" style="margin-top: 20px;">Выйти</button>
        <button id="backToMain" class="button secondary">Назад</button>
    </div>

    <div id="createRequestPage" class="page" style="display:none;">
        <h2 class="header-text">Разместить заявку</h2>
        <div class="form-container">
            <form id="createRequestForm">
                <label for="requestType">Тип заявки:</label>
                <select id="requestType" class="input"></select>
                <div id="specializationGroup" style="display:none;">
                    <label for="requestSpecialization">Специализация:</label>
                    <select id="requestSpecialization" class="input"></select>
                </div>
                <div id="machineryTypeGroup" style="display:none;">
                    <label for="requestMachineryType">Тип техники:</label>
                    <select id="requestMachineryType" class="input"></select>
                </div>
                <div id="toolTypeGroup" style="display:none;">
                    <label for="requestToolType">Тип инструмента:</label>
                    <select id="requestToolType" class="input"></select>
                </div>
                <div id="materialTypeGroup" style="display:none;">
                    <label for="requestMaterialType">Тип материала:</label>
                    <select id="requestMaterialType" class="input"></select>
                </div>
                <label for="requestDescription">Описание:</label>
                <textarea id="requestDescription" class="input" rows="4"></textarea>
                <label for="requestPrice">Цена:</label>
                <input type="number" id="requestPrice" class="input">
                <label for="requestContact">Контактная информация:</label>
                <input type="text" id="requestContact" class="input">
                <button type="submit" class="button primary">Разместить</button>
            </form>
        </div>
        <p id="requestStatus" class="message"></p>
        <button id="backToMainFromRequest" class="button secondary">Назад</button>
    </div>

    <div id="workRequestsPage" class="page" style="display:none;">
        <h2 class="header-text">Заявки на работы</h2>
        <div id="workRequestsList"></div>
        <button id="backToMainFromRequests" class="button secondary">Назад</button>
    </div>

    <div id="machineryPage" class="page" style="display:none;">
        <h2 class="header-text">Заявки на спецтехнику</h2>
        <div id="machineryList"></div>
        <button id="backToMainFromMachinery" class="button secondary">Назад</button>
    </div>

    <div id="toolsPage" class="page" style="display:none;">
        <h2 class="header-text">Заявки на инструменты</h2>
        <div id="toolsList"></div>
        <button id="backToMainFromTools" class="button secondary">Назад</button>
    </div>

    <div id="materialsPage" class="page" style="display:none;">
        <h2 class="header-text">Объявления о материалах</h2>
        <div id="materialsList"></div>
        <button id="backToMainFromMaterials" class="button secondary">Назад</button>
    </div>

    <div id="takeOrderPage" class="page" style="display:none;">
        <h2 class="header-text">Принять заявку</h2>
        <p>Вы собираетесь принять заявку с ID: <span id="requestIdToTake"></span></p>
        <button id="confirmTakeOrder" class="button primary">Подтвердить</button>
        <p id="takeOrderStatus" class="message"></p>
        <button id="backToMainFromTakeOrder" class="button secondary">Назад</button>
    </div>

</div>

<div id="cityModal" class="modal">
    <div class="modal-content">
        <h3>Выберите ваш город</h3>
        <ul id="cityList"></ul>
    </div>
</div>

<div class="navbar">
    <div class="nav-item active" id="nav-home">
        <i class="fas fa-home"></i>
        <span>Главная</span>
    </div>
    <div class="nav-item" id="nav-profile">
        <i class="fas fa-user"></i>
        <span>Профиль</span>
    </div>
    <div class="nav-item" id="nav-add">
        <i class="fas fa-plus-circle"></i>
        <span>Добавить</span>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:8000/api';
    let accessToken = null;
    let currentUser = null;
    let selectedCity = null;
    let lastSelectedRequestId = null;

    const pages = document.querySelectorAll('.page');
    const cityModal = document.getElementById('cityModal');
    const cityListEl = document.getElementById('cityList');
    const cityNameEl = document.querySelector('.selected-city');

    function showPage(pageId) {
        pages.forEach(page => {
            page.style.display = 'none';
        });
        document.getElementById(pageId).style.display = 'flex';
    }

    function saveSelectedCity(city) {
        localStorage.setItem('selectedCity', JSON.stringify(city));
        selectedCity = city;
        cityNameEl.textContent = selectedCity.name;
    }

    function getSelectedCity() {
        return JSON.parse(localStorage.getItem('selectedCity'));
    }

    async function fetchCities() {
        const response = await fetch(`${API_URL}/cities`);
        const cities = await response.json();
        cityListEl.innerHTML = '';
        cities.forEach(city => {
            const li = document.createElement('li');
            li.textContent = city.name;
            li.addEventListener('click', () => {
                saveSelectedCity(city);
                cityModal.classList.remove('active');
                checkAuthentication();
            });
            cityListEl.appendChild(li);
        });
    }

    async function login() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        const formData = new FormData();
        formData.append('username', username);
        formData.append('password', password);
        const response = await fetch(`${API_URL}/token`, {
            method: 'POST',
            body: formData,
        });
        const data = await response.json();
        if (response.ok) {
            accessToken = data.access_token;
            localStorage.setItem('accessToken', accessToken);
            fetchProfile();
            showPage('buttonContainer');
        } else {
            alert('Ошибка входа: ' + (data.detail || 'Неверные данные'));
        }
    }

    async function register() {
        const username = document.getElementById('regUsername').value;
        const password = document.getElementById('regPassword').value;
        const name = document.getElementById('regName').value;
        const userType = document.getElementById('regUserType').value;
        const cityId = document.getElementById('regCity').value;
        const response = await fetch(`${API_URL}/users/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: username,
                password: password,
                user_name: name,
                user_type: userType,
                city_id: parseInt(cityId),
            }),
        });
        if (response.ok) {
            alert('Регистрация успешна! Теперь вы можете войти.');
            showPage('loginPage');
        } else {
            const data = await response.json();
            alert('Ошибка регистрации: ' + (data.detail || 'Неизвестная ошибка'));
        }
    }

    async function fetchProfile() {
        const response = await fetch(`${API_URL}/me`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await response.json();
        if (response.ok) {
            currentUser = data;
            document.getElementById('profileName').textContent = currentUser.user_name;
            document.getElementById('profileType').textContent = currentUser.user_type;
            const city = JSON.parse(localStorage.getItem('selectedCity'));
            document.getElementById('profileCity').textContent = city ? city.name : 'Не выбран';
        } else {
            // Если токен недействителен, возвращаемся на страницу входа
            localStorage.removeItem('accessToken');
            showPage('loginPage');
        }
    }

    async function fetchSpecializations() {
        const response = await fetch(`${API_URL}/specializations`);
        const specializations = await response.json();
        const select = document.getElementById('requestSpecialization');
        select.innerHTML = '';
        specializations.forEach(spec => {
            const option = document.createElement('option');
            option.value = spec;
            option.textContent = spec;
            select.appendChild(option);
        });
    }

    async function fetchMachineryTypes() {
        const response = await fetch(`${API_URL}/machinery-types`);
        const machineryTypes = await response.json();
        const select = document.getElementById('requestMachineryType');
        select.innerHTML = '';
        machineryTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            select.appendChild(option);
        });
    }

    async function fetchToolTypes() {
        const response = await fetch(`${API_URL}/tool-types`);
        const toolTypes = await response.json();
        const select = document.getElementById('requestToolType');
        select.innerHTML = '';
        toolTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            select.appendChild(option);
        });
    }

    async function fetchMaterialTypes() {
        const response = await fetch(`${API_URL}/material-types`);
        const materialTypes = await response.json();
        const select = document.getElementById('requestMaterialType');
        select.innerHTML = '';
        materialTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            select.appendChild(option);
        });
    }

    async function fetchWorkRequests() {
        const cityId = getSelectedCity() ? getSelectedCity().id : null;
        const response = await fetch(`${API_URL}/work-requests?city_id=${cityId}`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const requests = await response.json();
        const list = document.getElementById('workRequestsList');
        list.innerHTML = '';
        if (requests.length === 0) {
            list.innerHTML = '<p style="text-align: center;">Нет доступных заявок на работы в вашем городе.</p>';
        } else {
            requests.forEach(req => {
                const item = document.createElement('div');
                item.className = 'profile-container';
                item.innerHTML = `
                    <p><strong>Заявка #${req.id}</strong></p>
                    <p>Специализация: ${req.specialization}</p>
                    <p>Описание: ${req.description}</p>
                    <p>Цена: ${req.price} руб.</p>
                    <p>Контакты: ${req.contact_info}</p>
                    <button class="button primary take-order-btn" data-id="${req.id}">Принять заявку</button>
                `;
                list.appendChild(item);
            });
        }
    }

    async function fetchMachineryRequests() {
        const cityId = getSelectedCity() ? getSelectedCity().id : null;
        const response = await fetch(`${API_URL}/machinery-requests?city_id=${cityId}`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const requests = await response.json();
        const list = document.getElementById('machineryList');
        list.innerHTML = '';
        if (requests.length === 0) {
            list.innerHTML = '<p style="text-align: center;">Нет доступных заявок на спецтехнику в вашем городе.</p>';
        } else {
            requests.forEach(req => {
                const item = document.createElement('div');
                item.className = 'profile-container';
                item.innerHTML = `
                    <p><strong>Заявка #${req.id}</strong></p>
                    <p>Тип техники: ${req.machinery_type}</p>
                    <p>Описание: ${req.description}</p>
                    <p>Цена: ${req.rental_price} руб./час</p>
                    <p>Контакты: ${req.contact_info}</p>
                `;
                list.appendChild(item);
            });
        }
    }

    async function fetchToolsList() {
        const cityId = getSelectedCity() ? getSelectedCity().id : null;
        const response = await fetch(`${API_URL}/tool-requests?city_id=${cityId}`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const requests = await response.json();
        const list = document.getElementById('toolsList');
        list.innerHTML = '';
        if (requests.length === 0) {
            list.innerHTML = '<p style="text-align: center;">Нет доступных заявок на инструменты в вашем городе.</p>';
        } else {
            requests.forEach(req => {
                const item = document.createElement('div');
                item.className = 'profile-container';
                item.innerHTML = `
                    <p><strong>Заявка #${req.id}</strong></p>
                    <p>Инструмент: ${req.tool_name}</p>
                    <p>Описание: ${req.description}</p>
                    <p>Цена: ${req.rental_price} руб./час</p>
                    <p>Контакты: ${req.contact_info}</p>
                `;
                list.appendChild(item);
            });
        }
    }

    async function fetchMaterialsList() {
        const cityId = getSelectedCity() ? getSelectedCity().id : null;
        const response = await fetch(`${API_URL}/material-ads?city_id=${cityId}`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const ads = await response.json();
        const list = document.getElementById('materialsList');
        list.innerHTML = '';
        if (ads.length === 0) {
            list.innerHTML = '<p style="text-align: center;">Нет доступных объявлений о материалах в вашем городе.</p>';
        } else {
            ads.forEach(ad => {
                const item = document.createElement('div');
                item.className = 'profile-container';
                item.innerHTML = `
                    <p><strong>Объявление #${ad.id}</strong></p>
                    <p>Материал: ${ad.material_type}</p>
                    <p>Описание: ${ad.description}</p>
                    <p>Цена: ${ad.price} руб.</p>
                    <p>Контакты: ${ad.contact_info}</p>
                `;
                list.appendChild(item);
            });
        }
    }


    document.addEventListener('click', async (e) => {
        if (e.target.classList.contains('take-order-btn')) {
            lastSelectedRequestId = e.target.getAttribute('data-id');
            document.getElementById('requestIdToTake').textContent = lastSelectedRequestId;
            showPage('takeOrderPage');
        }
    });

    async function takeWorkRequest(request_id) {
        if (!accessToken) {
            alert('Вы не авторизованы.');
            return;
        }
        const statusEl = document.getElementById('takeOrderStatus');
        const response = await fetch(`${API_URL}/work-requests/${request_id}/take`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await response.json();
        if (response.ok) {
            statusEl.textContent = `Заявка с ID ${request_id} успешно принята.`;
            statusEl.className = 'message success';
        } else {
            statusEl.textContent = `Ошибка: ${data.detail}`;
            statusEl.className = 'message error';
        }
    }

    function checkAuthentication() {
        accessToken = localStorage.getItem('accessToken');
        if (accessToken) {
            fetchProfile();
            showPage('buttonContainer');
        } else {
            showPage('loginPage');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Кнопки
        document.getElementById('loginButton').addEventListener('click', login);
        document.getElementById('goToRegister').addEventListener('click', () => showPage('registerPage'));
        document.getElementById('backToLogin').addEventListener('click', () => showPage('loginPage'));
        document.getElementById('registerButton').addEventListener('click', register);
        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('accessToken');
            showPage('loginPage');
        });

        // Навигация
        document.getElementById('nav-home').addEventListener('click', () => showPage('buttonContainer'));
        document.getElementById('nav-profile').addEventListener('click', () => showPage('profilePage'));
        document.getElementById('nav-add').addEventListener('click', () => showPage('createRequestPage'));

        // Переходы на страницы с заявками
        document.getElementById('showWorkRequests').addEventListener('click', () => { showPage('workRequestsPage'); fetchWorkRequests(); });
        document.getElementById('showMachineryRequests').addEventListener('click', () => { showPage('machineryPage'); fetchMachineryRequests(); });
        document.getElementById('showToolRequests').addEventListener('click', () => { showPage('toolsPage'); fetchToolsList(); });
        document.getElementById('showMaterialAds').addEventListener('click', () => { showPage('materialsPage'); fetchMaterialsList(); });
        document.getElementById('createRequest').addEventListener('click', () => showPage('createRequestPage'));

        // Кнопки "Назад"
        document.getElementById('backToMain').addEventListener('click', () => showPage('buttonContainer'));
        document.getElementById('backToMainFromRequest').addEventListener('click', () => showPage('buttonContainer'));
        document.getElementById('backToMainFromRequests').addEventListener('click', () => showPage('buttonContainer'));
        document.getElementById('backToMainFromMachinery').addEventListener('click', () => showPage('buttonContainer'));
        document.getElementById('backToMainFromTools').addEventListener('click', () => showPage('buttonContainer'));
        document.getElementById('backToMainFromMaterials').addEventListener('click', () => showPage('buttonContainer'));
        document.getElementById('backToMainFromTakeOrder').addEventListener('click', () => showPage('buttonContainer'));

        document.getElementById('confirmTakeOrder').addEventListener('click', () => {
            takeWorkRequest(lastSelectedRequestId);
        });

        const requestTypeSelect = document.getElementById('requestType');
        requestTypeSelect.addEventListener('change', () => {
            const selectedType = requestTypeSelect.value;
            document.getElementById('specializationGroup').style.display = 'none';
            document.getElementById('machineryTypeGroup').style.display = 'none';
            document.getElementById('toolTypeGroup').style.display = 'none';
            document.getElementById('materialTypeGroup').style.display = 'none';
            if (selectedType === 'work') {
                document.getElementById('specializationGroup').style.display = 'block';
            } else if (selectedType === 'machinery') {
                document.getElementById('machineryTypeGroup').style.display = 'block';
            } else if (selectedType === 'tool') {
                document.getElementById('toolTypeGroup').style.display = 'block';
            } else if (selectedType === 'material') {
                document.getElementById('materialTypeGroup').style.display = 'block';
            }
        });

        const requestTypes = [
            { value: 'work', text: 'Работа' },
            { value: 'machinery', text: 'Спецтехника' },
            { value: 'tool', text: 'Инструменты' },
            { value: 'material', text: 'Материалы' }
        ];
        requestTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type.value;
            option.textContent = type.text;
            requestTypeSelect.appendChild(option);
        });

        document.getElementById('createRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('requestType').value;
            const description = document.getElementById('requestDescription').value;
            const price = document.getElementById('requestPrice').value;
            const contact = document.getElementById('requestContact').value;
            const cityId = getSelectedCity() ? getSelectedCity().id : null;
            let payload = { description, price: parseFloat(price), contact_info: contact, city_id: cityId };
            let endpoint = '';
            if (type === 'work') {
                payload.specialization = document.getElementById('requestSpecialization').value;
                endpoint = '/work-requests';
            } else if (type === 'machinery') {
                payload.machinery_type = document.getElementById('requestMachineryType').value;
                payload.rental_price = parseFloat(price);
                delete payload.price;
                endpoint = '/machinery-requests';
            } else if (type === 'tool') {
                payload.tool_name = document.getElementById('requestToolType').value;
                payload.rental_price = parseFloat(price);
                delete payload.price;
                endpoint = '/tool-requests';
            } else if (type === 'material') {
                payload.material_type = document.getElementById('requestMaterialType').value;
                endpoint = '/material-ads';
            }

            const response = await fetch(`${API_URL}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                body: JSON.stringify(payload),
            });
            const statusEl = document.getElementById('requestStatus');
            if (response.ok) {
                statusEl.textContent = 'Заявка успешно размещена!';
                statusEl.className = 'message success';
            } else {
                const data = await response.json();
                statusEl.textContent = `Ошибка: ${data.detail}`;
                statusEl.className = 'message error';
            }
        });

        fetchCities();
        fetchSpecializations();
        fetchMachineryTypes();
        fetchToolTypes();
        fetchMaterialTypes();

        if (getSelectedCity()) {
            cityNameEl.textContent = getSelectedCity().name;
            checkAuthentication();
        } else {
            cityModal.classList.add('active');
        }
    });
</script>
</body>
</html>