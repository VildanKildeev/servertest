<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СМЗ.РФ - Рабочие и спецтехника</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #2B2117; /* Темно-коричневый */
            --card-color: #F7EFE3; /* Светло-бежевый */
            --text-color: #F7EFE3; /* Светло-бежевый для текста на темном фоне */
            --ink-color: #2B2117; /* Темно-коричневый для текста на светлом фоне */
            --accent-color: #3C7A5D; /* Насыщенный зеленый */
            --accent-hover: #2F644A; /* Более темный зеленый */
            --yellow-accent: #BFA17E; /* Желтый/золотой акцент */
            --red-accent: #D64545; /* Красный для ошибок */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            color: white;
            overflow: hidden;
            background: black;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .background-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -2;
        }

        .selected-city {
            margin-top: 12px;
            font-size: 16px;
            color: #fff;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        .city-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s ease-in-out;
        }

        .city-modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: var(--ink-color);
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        button {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--accent-hover);
        }

        .logo {
            width: 80px;
            height: 80px;
            margin-top: 50px;
            animation: fadeInDown 1s ease-in-out;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page {
            width: 100%;
            max-width: 450px;
            padding: 20px;
            box-sizing: border-box;
            background-color: var(--bg-color);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            transition: all 0.5s ease-in-out;
            overflow-y: auto;
            max-height: 90vh;
        }

        .page.active {
            display: block;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .auth-form input,
        .auth-form button,
        .request-form input,
        .request-form textarea,
        .request-form select,
        .request-form button {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--card-color);
            color: var(--ink-color);
            font-size: 16px;
        }

        .auth-form button,
        .request-form button {
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .auth-form button:hover,
        .request-form button:hover {
            background-color: var(--accent-hover);
        }

        .link-text {
            display: block;
            text-align: center;
            margin-top: 10px;
            color: var(--text-color);
            text-decoration: underline;
            cursor: pointer;
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .button-grid a {
            padding: 15px;
            background-color: var(--card-color);
            color: var(--ink-color);
            text-decoration: none;
            text-align: center;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .button-grid a:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .button-grid a i {
            font-size: 20px;
        }

        .message {
            text-align: center;
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .message.success {
            color: var(--accent-color);
            background-color: rgba(60, 122, 93, 0.2);
        }

        .message.error {
            color: var(--red-accent);
            background-color: rgba(214, 69, 69, 0.2);
        }
        
        .toggle-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }
        
        .back-button {
            margin-top: 20px;
            background-color: transparent;
            color: var(--text-color);
            font-size: 16px;
        }
        
        .list-container {
            width: 100%;
            margin-top: 20px;
            display: grid;
            gap: 10px;
        }

        .list-item {
            background-color: var(--card-color);
            color: var(--ink-color);
            padding: 15px;
            border-radius: 10px;
        }

        .list-item h3 {
            margin-bottom: 5px;
        }

        .list-item p {
            font-size: 14px;
            line-height: 1.4;
        }

        .list-item .details {
            margin-top: 10px;
        }
        
        .list-item .details p {
            margin-top: 5px;
        }
        
        .list-item .details a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: bold;
        }
        
        .list-item button {
            margin-top: 10px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            width: 100%;
        }

        .profile-info p {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .profile-info p strong {
            color: var(--accent-color);
        }
        .profile-info {
            background-color: var(--card-color);
            color: var(--ink-color);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .modal-content {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: var(--ink-color);
        }

        .tab-menu {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            gap: 10px;
        }

        .tab-button {
            flex: 1;
            padding: 10px;
            border: none;
            background-color: var(--card-color);
            color: var(--ink-color);
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .tab-button.active {
            background-color: var(--accent-color);
            color: var(--text-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

    </style>
</head>
<body>

    <video autoplay muted loop class="background-video">
        <source src="https://assets.mixkit.co/videos/preview/mixkit-construction-site-with-an-excavator-4330-large.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div class="selected-city" id="selectedCityText">
        <i class="fas fa-map-marker-alt" style="color: var(--yellow-accent);"></i> <span id="cityName">Город не выбран</span>
    </div>

    <div id="cityModal" class="city-modal active">
        <div class="modal-content">
            <h2>Выберите ваш город</h2>
            <select id="citySelect"></select>
            <button id="saveCityButton">Сохранить</button>
        </div>
    </div>
    
    <div id="buttonContainer" class="page active">
        <h2>СМЗ.РФ</h2>
        <div class="button-grid">
            <a href="#" id="findWorkBtn"><i class="fas fa-hammer"></i>Найти работу</a>
            <a href="#" id="createWorkBtn"><i class="fas fa-plus"></i>Создать заявку</a>
            <a href="#" id="findMachineryBtn"><i class="fas fa-tractor"></i>Найти спецтехнику</a>
            <a href="#" id="findToolsBtn"><i class="fas fa-wrench"></i>Найти инструменты</a>
            <a href="#" id="findMaterialsBtn"><i class="fas fa-hard-hat"></i>Найти материалы</a>
            <a href="#" id="profileBtn"><i class="fas fa-user"></i>Профиль</a>
        </div>
    </div>

    <div id="registerPage" class="page">
        <h2>Регистрация</h2>
        <form id="registerForm" class="auth-form">
            <input type="text" id="regUsername" placeholder="Имя пользователя" required>
            <input type="password" id="regPassword" placeholder="Пароль" required>
            <input type="text" id="regName" placeholder="Ваше имя" required>
            <select id="regUserType" required>
                <option value="" disabled selected>Выберите тип пользователя</option>
                <option value="Заказчик">Заказчик</option>
                <option value="Исполнитель">Исполнитель</option>
            </select>
            <div id="specializationGroup" style="display: none;">
                <select id="regSpecialization" required></select>
            </div>
            <button type="submit">Зарегистрироваться</button>
            <div class="message" id="registerStatus"></div>
        </form>
        <a href="#" class="link-text" id="showLogin">Уже есть аккаунт? Войти</a>
    </div>

    <div id="loginPage" class="page">
        <h2>Вход</h2>
        <form id="loginForm" class="auth-form">
            <input type="text" id="loginUsername" placeholder="Имя пользователя" required>
            <input type="password" id="loginPassword" placeholder="Пароль" required>
            <button type="submit">Войти</button>
            <div class="message" id="loginStatus"></div>
        </form>
        <a href="#" class="link-text" id="showRegister">Нет аккаунта? Зарегистрироваться</a>
    </div>
    
    <div id="profilePage" class="page">
        <h2>Профиль</h2>
        <div class="profile-info" id="profileInfo">
            <p><strong>Имя:</strong> <span id="profileName"></span></p>
            <p><strong>Тип:</strong> <span id="profileType"></span></p>
            <p><strong>Город:</strong> <span id="profileCity"></span></p>
            <p id="profileSpecializationRow" style="display: none;"><strong>Специализация:</strong> <span id="profileSpecialization"></span></p>
        </div>
        <button id="showMyRequestsBtn">Мои заявки</button>
        <button id="showTakenRequestsBtn">Принятые заявки</button>
        <button id="logoutBtn" style="margin-top: 15px; background-color: var(--red-accent);">Выйти</button>
        <button id="backToMainFromProfile" class="back-button"><i class="fas fa-arrow-left"></i> Назад</button>
    </div>

    <div id="myRequestsPage" class="page">
        <h2>Мои заявки</h2>
        <div class="list-container" id="myRequestsList"></div>
        <div class="message" id="myRequestsStatus"></div>
        <button id="backToProfileFromRequests" class="back-button"><i class="fas fa-arrow-left"></i> Назад</button>
    </div>
    
    <div id="takenRequestsPage" class="page">
        <h2>Принятые заявки</h2>
        <div class="list-container" id="takenRequestsList"></div>
        <div class="message" id="takenRequestsStatus"></div>
        <button id="backToProfileFromRequests" class="back-button"><i class="fas fa-arrow-left"></i> Назад</button>
    </div>

    <div id="findWorkPage" class="page">
        <h2>Найти работу</h2>
        <div class="list-container" id="workRequestsList"></div>
        <div class="message" id="findWorkStatus"></div>
        <button id="backToMainFromFindWork" class="back-button"><i class="fas fa-arrow-left"></i> Назад</button>
    </div>

    <div id="createWorkPage" class="page">
        <h2>Создать заявку</h2>
        <form id="createWorkForm" class="request-form">
            <select id="workSpecializationSelect" required></select>
            <textarea id="workDescription" placeholder="Описание работы" rows="4" required></textarea>
            <input type="text" id="workContact" placeholder="Контактная информация (телефон, email)" required>
            <div class="toggle-section">
                <span>Публичная заявка</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="workIsPublic" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <button type="submit">Создать заявку</button>
            <div class="message" id="createWorkStatus"></div>
        </form>
        <button id="backToMainFromCreateWork" class="back-button"><i class="fas fa-arrow-left"></i> Назад</button>
    </div>
    
    <div id="findMachineryPage" class="page">
        <h2>Найти спецтехнику</h2>
        <div class="tab-menu">
            <button class="tab-button active" onclick="showMachineryTab('machineryFind')">Найти</button>
            <button class="tab-button" onclick="showMachineryTab('machineryCreate')">Создать объявление</button>
        </div>
        <div id="machineryFind" class="tab-content active">
            <div class="list-container" id="machineryRequestsList"></div>
            <div class="message" id="machineryFindStatus"></div>
        </div>
        <div id="machineryCreate" class="tab-content">
            <form id="createMachineryForm" class="request-form">
                <input type="text" id="machineryName" placeholder="Название техники" required>
                <textarea id="machineryDescription" placeholder="Описание и характеристики" rows="4"></textarea>
                <input type="number" id="machineryPrice" placeholder="Цена аренды (за час/смену)" step="0.01">
                <input type="text" id="machineryContact" placeholder="Контактная информация" required>
                <button type="submit">Разместить объявление</button>
                <div class="message" id="createMachineryStatus"></div>
            </form>
        </div>
        <button id="backToMainFromMachinery" class="back-button"><i class="fas fa-arrow-left"></i> Назад</button>
    </div>
    
    <div id="findToolsPage" class="page">
        <h2>Найти инструменты</h2>
        <div class="tab-menu">
            <button class="tab-button active" onclick="showToolTab('toolFind')">Найти</button>
            <button class="tab-button" onclick="showToolTab('toolCreate')">Создать объявление</button>
        </div>
        <div id="toolFind" class="tab-content active">
            <div class="list-container" id="toolRequestsList"></div>
            <div class="message" id="toolFindStatus"></div>
        </div>
        <div id="toolCreate" class="tab-content">
            <form id="createToolForm" class="request-form">
                <input type="text" id="toolName" placeholder="Название инструмента" required>
                <textarea id="toolDescription" placeholder="Описание и характеристики" rows="4"></textarea>
                <input type="number" id="toolPrice" placeholder="Цена аренды (за час/смену)" step="0.01">
                <input type="text" id="toolContact" placeholder="Контактная информация" required>
                <button type="submit">Разместить объявление</button>
                <div class="message" id="createToolStatus"></div>
            </form>
        </div>
        <button id="backToMainFromTools" class="back-button"><i class="fas fa-arrow-left"></i> Назад</button>
    </div>

    <div id="findMaterialsPage" class="page">
        <h2>Найти материалы</h2>
        <div class="tab-menu">
            <button class="tab-button active" onclick="showMaterialTab('materialFind')">Найти</button>
            <button class="tab-button" onclick="showMaterialTab('materialCreate')">Создать объявление</button>
        </div>
        <div id="materialFind" class="tab-content active">
            <div class="list-container" id="materialAdsList"></div>
            <div class="message" id="materialFindStatus"></div>
        </div>
        <div id="materialCreate" class="tab-content">
            <form id="createMaterialForm" class="request-form">
                <select id="materialType" required></select>
                <textarea id="materialDescription" placeholder="Описание материала" rows="4"></textarea>
                <input type="number" id="materialPrice" placeholder="Цена за единицу" step="0.01">
                <input type="text" id="materialContact" placeholder="Контактная информация" required>
                <button type="submit">Разместить объявление</button>
                <div class="message" id="createMaterialStatus"></div>
            </form>
        </div>
        <button id="backToMainFromMaterials" class="back-button"><i class="fas fa-arrow-left"></i> Назад</button>
    </div>

    <script>
        const API_URL = "https://servertest2-0.onrender.com/api";
        let accessToken = null;
        let selectedCity = null;
        let lastSelectedRequestId = null;

        const el = (id) => document.getElementById(id);

        const pages = document.querySelectorAll('.page');
        const showPage = (id) => {
            pages.forEach(page => page.classList.remove('active'));
            const pageToShow = el(id);
            if (pageToShow) {
                pageToShow.classList.add('active');
            }
        };

        let citiesCache = [];
        let specializationsCache = [];
        let machineryTypesCache = [];
        let toolTypesCache = [];
        let materialTypesCache = [];

        // Вспомогательные функции для преобразования ID в имена
        function getCityNameById(id) {
            const city = citiesCache.find(c => c.id === id);
            return city ? city.name : 'Неизвестный город';
        }

        function getSpecializationNameById(id) {
            const specialization = specializationsCache.find(s => s.id === id);
            return specialization ? specialization.name : 'Неизвестная специализация';
        }

        function getMachineryNameById(id) {
            const machinery = machineryTypesCache.find(m => m.id === id);
            return machinery ? machinery.name : 'Неизвестный тип';
        }
        
        function getToolNameById(id) {
            const tool = toolTypesCache.find(t => t.id === id);
            return tool ? tool.name : 'Неизвестный инструмент';
        }
        
        function getMaterialNameById(id) {
            const material = materialTypesCache.find(m => m.id === id);
            return material ? material.name : 'Неизвестный материал';
        }

        const getSelectedCity = () => {
            const storedCity = localStorage.getItem('selectedCity');
            return storedCity ? JSON.parse(storedCity) : null;
        };

        const saveCity = (city) => {
            selectedCity = city;
            localStorage.setItem('selectedCity', JSON.stringify(city));
            el('cityName').textContent = city.name;
        };
        
        function populateSelect(selectElement, data) {
            selectElement.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Выберите --';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            selectElement.appendChild(defaultOption);

            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                selectElement.appendChild(option);
            });
        }
        
        // --- API Calls ---
        async function fetchCities() {
            try {
                const response = await fetch(`${API_URL}/cities`);
                const data = await response.json();
                citiesCache = data;
                populateSelect(el('citySelect'), data);
            } catch (error) {
                console.error("Ошибка получения городов:", error);
            }
        }
        
        async function fetchSpecializations() {
            try {
                const response = await fetch(`${API_URL}/specializations`);
                const data = await response.json();
                specializationsCache = data;
                populateSelect(el('regSpecialization'), data);
                populateSelect(el('workSpecializationSelect'), data);
            } catch (error) {
                console.error("Ошибка получения специализаций:", error);
            }
        }
        
        async function fetchMachineryTypes() {
            try {
                const response = await fetch(`${API_URL}/machinery-types`);
                const data = await response.json();
                machineryTypesCache = data;
            } catch (error) {
                console.error("Ошибка получения типов спецтехники:", error);
            }
        }
        
        async function fetchToolsList() {
            try {
                const response = await fetch(`${API_URL}/tool-types`);
                const data = await response.json();
                toolTypesCache = data;
            } catch (error) {
                console.error("Ошибка получения типов инструментов:", error);
            }
        }

        async function fetchMaterialTypes() {
            try {
                const response = await fetch(`${API_URL}/material-types`);
                const data = await response.json();
                materialTypesCache = data;
                populateSelect(el('materialType'), data);
            } catch (error) {
                console.error("Ошибка получения типов материалов:", error);
            }
        }

        async function fetchProfile() {
            const profileInfoEl = el('profileInfo');
            if (!accessToken) {
                profileInfoEl.innerHTML = `<p class="message error">Ошибка аутентификации.</p>`;
                return;
            }

            try {
                const response = await fetch(`${API_URL}/profile`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const user = await response.json();
                if (response.ok) {
                    el('profileName').textContent = user.user_name;
                    el('profileType').textContent = user.user_type;
                    el('profileCity').textContent = getCityNameById(user.city_id);

                    const specRow = el('profileSpecializationRow');
                    if (user.user_type === 'Исполнитель' && user.specialization) {
                        specRow.style.display = 'block';
                        el('profileSpecialization').textContent = getSpecializationNameById(parseInt(user.specialization));
                    } else {
                        specRow.style.display = 'none';
                    }
                } else {
                    el('profileInfo').innerHTML = `<p class="message error">Ошибка: ${user.detail}</p>`;
                }
            } catch (error) {
                console.error("Ошибка получения профиля:", error);
                el('profileInfo').innerHTML = `<p class="message error">Ошибка сети.</p>`;
            }
        }

        // --- Render Functions ---
        function renderWorkRequests(requests) {
            const listEl = el('workRequestsList');
            listEl.innerHTML = '';
            if (requests.length === 0) {
                el('findWorkStatus').textContent = 'Нет доступных заявок в этом городе.';
                el('findWorkStatus').className = 'message error';
                return;
            }
            el('findWorkStatus').textContent = '';
            requests.forEach(req => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <h3>${getSpecializationNameById(req.specialization)}</h3>
                    <p>${req.description || 'Без описания'}</p>
                    <div class="details">
                        <p><strong>Город:</strong> ${getCityNameById(req.city_id)}</p>
                        <p><strong>Контакт:</strong> ${req.contact_info}</p>
                    </div>
                    <button class="take-request-btn" data-id="${req.id}">Принять</button>
                `;
                listEl.appendChild(item);
            });

            document.querySelectorAll('.take-request-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    lastSelectedRequestId = e.target.dataset.id;
                    takeWorkRequest(lastSelectedRequestId);
                });
            });
        }
        
        function renderMachineryRequests(requests) {
            const listEl = el('machineryRequestsList');
            listEl.innerHTML = '';
            if (requests.length === 0) {
                el('machineryFindStatus').textContent = 'Нет доступных объявлений в этом городе.';
                el('machineryFindStatus').className = 'message error';
                return;
            }
            el('machineryFindStatus').textContent = '';
            requests.forEach(req => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <h3>${req.machinery_name}</h3>
                    <p>${req.description || 'Без описания'}</p>
                    <div class="details">
                        <p><strong>Город:</strong> ${getCityNameById(req.city_id)}</p>
                        <p><strong>Цена:</strong> ${req.rental_price ? `${req.rental_price} ₽` : 'Не указана'}</p>
                        <p><strong>Контакт:</strong> ${req.contact_info}</p>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }
        
        function renderToolRequests(requests) {
            const listEl = el('toolRequestsList');
            listEl.innerHTML = '';
            if (requests.length === 0) {
                el('toolFindStatus').textContent = 'Нет доступных объявлений в этом городе.';
                el('toolFindStatus').className = 'message error';
                return;
            }
            el('toolFindStatus').textContent = '';
            requests.forEach(req => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <h3>${req.tool_name}</h3>
                    <p>${req.description || 'Без описания'}</p>
                    <div class="details">
                        <p><strong>Город:</strong> ${getCityNameById(req.city_id)}</p>
                        <p><strong>Цена:</strong> ${req.rental_price ? `${req.rental_price} ₽` : 'Не указана'}</p>
                        <p><strong>Контакт:</strong> ${req.contact_info}</p>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        function renderMaterialAds(ads) {
            const listEl = el('materialAdsList');
            listEl.innerHTML = '';
            if (ads.length === 0) {
                el('materialFindStatus').textContent = 'Нет доступных объявлений в этом городе.';
                el('materialFindStatus').className = 'message error';
                return;
            }
            el('materialFindStatus').textContent = '';
            ads.forEach(ad => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <h3>${getMaterialNameById(ad.material_type)}</h3>
                    <p>${ad.description || 'Без описания'}</p>
                    <div class="details">
                        <p><strong>Город:</strong> ${getCityNameById(ad.city_id)}</p>
                        <p><strong>Цена:</strong> ${ad.price ? `${ad.price} ₽` : 'Не указана'}</p>
                        <p><strong>Контакт:</strong> ${ad.contact_info}</p>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }
        
        function renderMyRequests(requests) {
            const listEl = el('myRequestsList');
            listEl.innerHTML = '';
            if (requests.length === 0) {
                el('myRequestsStatus').textContent = 'У вас нет созданных заявок.';
                el('myRequestsStatus').className = 'message error';
                return;
            }
            el('myRequestsStatus').textContent = '';
            requests.forEach(req => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <h3>${getSpecializationNameById(req.specialization)}</h3>
                    <p>${req.description || 'Без описания'}</p>
                    <div class="details">
                        <p><strong>Статус:</strong> ${req.is_taken ? 'Принята' : 'Свободна'}</p>
                        <p><strong>Контакт:</strong> ${req.contact_info}</p>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }
        
        function renderTakenRequests(requests) {
            const listEl = el('takenRequestsList');
            listEl.innerHTML = '';
            if (requests.length === 0) {
                el('takenRequestsStatus').textContent = 'У вас нет принятых заявок.';
                el('takenRequestsStatus').className = 'message error';
                return;
            }
            el('takenRequestsStatus').textContent = '';
            requests.forEach(req => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <h3>${getSpecializationNameById(req.specialization)}</h3>
                    <p>${req.description || 'Без описания'}</p>
                    <div class="details">
                        <p><strong>Статус:</strong> Принята</p>
                        <p><strong>Контакт:</strong> ${req.contact_info}</p>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        // --- Tab Logic ---
        function showMachineryTab(tabName) {
            el('machineryFind').style.display = 'none';
            el('machineryCreate').style.display = 'none';
            el(tabName).style.display = 'block';

            document.querySelectorAll('#findMachineryPage .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#findMachineryPage .tab-button[onclick="showMachineryTab('${tabName}')"]`).classList.add('active');

            if (tabName === 'machineryFind') {
                fetchMachineryRequests();
            }
        }
        
        function showToolTab(tabName) {
            el('toolFind').style.display = 'none';
            el('toolCreate').style.display = 'none';
            el(tabName).style.display = 'block';
            
            document.querySelectorAll('#findToolsPage .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#findToolsPage .tab-button[onclick="showToolTab('${tabName}')"]`).classList.add('active');
            
            if (tabName === 'toolFind') {
                fetchToolRequests();
            }
        }
        
        function showMaterialTab(tabName) {
            el('materialFind').style.display = 'none';
            el('materialCreate').style.display = 'none';
            el(tabName).style.display = 'block';
            
            document.querySelectorAll('#findMaterialsPage .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#findMaterialsPage .tab-button[onclick="showMaterialTab('${tabName}')"]`).classList.add('active');
            
            if (tabName === 'materialFind') {
                fetchMaterialAds();
            }
        }

        // --- Fetch Functions ---
        async function fetchWorkRequests() {
            const city = getSelectedCity();
            if (!city) return;
            try {
                const response = await fetch(`${API_URL}/work-requests?city_id=${city.id}`);
                const data = await response.json();
                renderWorkRequests(data);
            } catch (error) {
                console.error("Ошибка получения заявок на работу:", error);
                el('findWorkStatus').textContent = 'Ошибка загрузки заявок. Попробуйте позже.';
                el('findWorkStatus').className = 'message error';
            }
        }
        
        async function fetchMachineryRequests() {
            const city = getSelectedCity();
            if (!city) return;
            try {
                const response = await fetch(`${API_URL}/machinery-requests?city_id=${city.id}`);
                const data = await response.json();
                renderMachineryRequests(data);
            } catch (error) {
                console.error("Ошибка получения объявлений спецтехники:", error);
                el('machineryFindStatus').textContent = 'Ошибка загрузки объявлений. Попробуйте позже.';
                el('machineryFindStatus').className = 'message error';
            }
        }
        
        async function fetchToolRequests() {
            const city = getSelectedCity();
            if (!city) return;
            try {
                const response = await fetch(`${API_URL}/tool-requests?city_id=${city.id}`);
                const data = await response.json();
                renderToolRequests(data);
            } catch (error) {
                console.error("Ошибка получения объявлений инструментов:", error);
                el('toolFindStatus').textContent = 'Ошибка загрузки объявлений. Попробуйте позже.';
                el('toolFindStatus').className = 'message error';
            }
        }
        
        async function fetchMaterialAds() {
            const city = getSelectedCity();
            if (!city) return;
            try {
                const response = await fetch(`${API_URL}/material-ads?city_id=${city.id}`);
                const data = await response.json();
                renderMaterialAds(data);
            } catch (error) {
                console.error("Ошибка получения объявлений материалов:", error);
                el('materialFindStatus').textContent = 'Ошибка загрузки объявлений. Попробуйте позже.';
                el('materialFindStatus').className = 'message error';
            }
        }
        
        async function takeWorkRequest(requestId) {
            const statusEl = el('findWorkStatus');
            try {
                const response = await fetch(`${API_URL}/work-requests/${requestId}/take`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    statusEl.textContent = `Заявка с ID ${requestId} успешно принята.`;
                    statusEl.className = 'message success';
                    fetchWorkRequests(); // Обновляем список
                } else {
                    statusEl.textContent = `Ошибка: ${data.detail}`;
                    statusEl.className = 'message error';
                }
            } catch (error) {
                statusEl.textContent = 'Ошибка сети при попытке принять заявку.';
                statusEl.className = 'message error';
            }
        }

        async function fetchMyRequests() {
            const listEl = el('myRequestsList');
            const statusEl = el('myRequestsStatus');
            listEl.innerHTML = '';
            statusEl.textContent = 'Загрузка...';

            try {
                const response = await fetch(`${API_URL}/user/work-requests`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    renderMyRequests(data);
                } else {
                    statusEl.textContent = `Ошибка: ${data.detail}`;
                    statusEl.className = 'message error';
                }
            } catch (error) {
                statusEl.textContent = 'Ошибка сети при загрузке заявок.';
                statusEl.className = 'message error';
            }
        }
        
        async function fetchTakenRequests() {
            const listEl = el('takenRequestsList');
            const statusEl = el('takenRequestsStatus');
            listEl.innerHTML = '';
            statusEl.textContent = 'Загрузка...';

            try {
                const response = await fetch(`${API_URL}/user/taken-requests`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    renderTakenRequests(data);
                } else {
                    statusEl.textContent = `Ошибка: ${data.detail}`;
                    statusEl.className = 'message error';
                }
            } catch (error) {
                statusEl.textContent = 'Ошибка сети при загрузке принятых заявок.';
                statusEl.className = 'message error';
            }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            el('saveCityButton').addEventListener('click', () => {
                const selectedCityId = el('citySelect').value;
                const city = citiesCache.find(c => c.id == selectedCityId);
                if (city) {
                    saveCity(city);
                    el('cityModal').classList.remove('active');
                    checkAuthentication();
                } else {
                    alert('Пожалуйста, выберите город.');
                }
            });

            el('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                showPage('loginPage');
            });

            el('showRegister').addEventListener('click', (e) => {
                e.preventDefault();
                showPage('registerPage');
            });
            
            el('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('accessToken');
                accessToken = null;
                showPage('loginPage');
            });
            
            el('profileBtn').addEventListener('click', (e) => {
                e.preventDefault();
                if (accessToken) {
                    fetchProfile();
                    showPage('profilePage');
                } else {
                    showPage('loginPage');
                }
            });
            
            el('findWorkBtn').addEventListener('click', (e) => {
                e.preventDefault();
                if (accessToken) {
                    fetchWorkRequests();
                    showPage('findWorkPage');
                } else {
                    showPage('loginPage');
                }
            });

            el('createWorkBtn').addEventListener('click', (e) => {
                e.preventDefault();
                if (accessToken) {
                    showPage('createWorkPage');
                } else {
                    showPage('loginPage');
                }
            });
            
            el('findMachineryBtn').addEventListener('click', (e) => {
                e.preventDefault();
                if (accessToken) {
                    fetchMachineryRequests();
                    showPage('findMachineryPage');
                } else {
                    showPage('loginPage');
                }
            });

            el('findToolsBtn').addEventListener('click', (e) => {
                e.preventDefault();
                if (accessToken) {
                    fetchToolRequests();
                    showPage('findToolsPage');
                } else {
                    showPage('loginPage');
                }
            });

            el('findMaterialsBtn').addEventListener('click', (e) => {
                e.preventDefault();
                if (accessToken) {
                    fetchMaterialAds();
                    showPage('findMaterialsPage');
                } else {
                    showPage('loginPage');
                }
            });
            
            el('showMyRequestsBtn').addEventListener('click', (e) => {
                e.preventDefault();
                fetchMyRequests();
                showPage('myRequestsPage');
            });
            
            el('showTakenRequestsBtn').addEventListener('click', (e) => {
                e.preventDefault();
                fetchTakenRequests();
                showPage('takenRequestsPage');
            });

            // Формы
            el('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const statusEl = el('registerStatus');
                statusEl.textContent = 'Регистрация...';
                statusEl.className = 'message';

                const username = el('regUsername').value;
                const password = el('regPassword').value;
                const name = el('regName').value;
                const userType = el('regUserType').value;
                const cityId = getSelectedCity() ? getSelectedCity().id : null;
                const specialization = (userType === 'Исполнитель') ? el('regSpecialization').value : null;

                if (!cityId) {
                    statusEl.textContent = 'Пожалуйста, выберите город в модальном окне.';
                    statusEl.className = 'message error';
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: username,
                            password: password,
                            user_name: name,
                            user_type: userType,
                            city_id: cityId,
                            specialization: specialization
                        })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        statusEl.textContent = 'Регистрация прошла успешно! Теперь вы можете войти.';
                        statusEl.className = 'message success';
                        setTimeout(() => showPage('loginPage'), 2000);
                    } else {
                        statusEl.textContent = `Ошибка: ${data.detail || data.message}`;
                        statusEl.className = 'message error';
                    }
                } catch (error) {
                    statusEl.textContent = 'Ошибка сети. Пожалуйста, попробуйте позже.';
                    statusEl.className = 'message error';
                }
            });

            el('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const statusEl = el('loginStatus');
                statusEl.textContent = 'Вход...';
                statusEl.className = 'message';

                const formData = new URLSearchParams();
                formData.append('username', el('loginUsername').value);
                formData.append('password', el('loginPassword').value);

                try {
                    const response = await fetch(`${API_URL}/token`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData.toString()
                    });
                    const data = await response.json();
                    if (response.ok) {
                        accessToken = data.access_token;
                        localStorage.setItem('accessToken', accessToken);
                        statusEl.textContent = 'Вход успешен!';
                        statusEl.className = 'message success';
                        fetchProfile();
                        setTimeout(() => showPage('buttonContainer'), 1000);
                    } else {
                        statusEl.textContent = `Ошибка: ${data.detail}`;
                        statusEl.className = 'message error';
                    }
                } catch (error) {
                    statusEl.textContent = 'Ошибка сети. Пожалуйста, попробуйте позже.';
                    statusEl.className = 'message error';
                }
            });

            el('createWorkForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const statusEl = el('createWorkStatus');
                statusEl.textContent = 'Создание заявки...';
                statusEl.className = 'message';

                const city = getSelectedCity();
                if (!city) {
                    statusEl.textContent = 'Пожалуйста, выберите город.';
                    statusEl.className = 'message error';
                    return;
                }
                
                const specialization = el('workSpecializationSelect').value;
                const description = el('workDescription').value;
                const contact = el('workContact').value;
                const isPublic = el('workIsPublic').checked;

                try {
                    const response = await fetch(`${API_URL}/work-requests`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({
                            description: description,
                            contact_info: contact,
                            city_id: city.id,
                            specialization: specialization,
                            is_public: isPublic
                        })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        statusEl.textContent = `Заявка на работу успешно создана!`;
                        statusEl.className = 'message success';
                        el('createWorkForm').reset();
                    } else {
                        statusEl.textContent = `Ошибка: ${data.detail}`;
                        statusEl.className = 'message error';
                    }
                } catch (error) {
                    statusEl.textContent = 'Ошибка сети. Пожалуйста, попробуйте позже.';
                    statusEl.className = 'message error';
                }
            });

            el('createMachineryForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const statusEl = el('createMachineryStatus');
                statusEl.textContent = 'Размещение объявления...';
                statusEl.className = 'message';

                const city = getSelectedCity();
                if (!city) {
                    statusEl.textContent = 'Пожалуйста, выберите город.';
                    statusEl.className = 'message error';
                    return;
                }

                const machineryName = el('machineryName').value;
                const description = el('machineryDescription').value;
                const price = el('machineryPrice').value;
                const contact = el('machineryContact').value;

                try {
                    const response = await fetch(`${API_URL}/machinery-requests`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({
                            machinery_name: machineryName,
                            description: description,
                            rental_price: price ? parseFloat(price) : null,
                            contact_info: contact,
                            city_id: city.id
                        })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        statusEl.textContent = `Объявление успешно размещено!`;
                        statusEl.className = 'message success';
                        el('createMachineryForm').reset();
                    } else {
                        statusEl.textContent = `Ошибка: ${data.detail}`;
                        statusEl.className = 'message error';
                    }
                } catch (error) {
                    statusEl.textContent = 'Ошибка сети. Пожалуйста, попробуйте позже.';
                    statusEl.className = 'message error';
                }
            });
            
            el('createToolForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const statusEl = el('createToolStatus');
                statusEl.textContent = 'Размещение объявления...';
                statusEl.className = 'message';

                const city = getSelectedCity();
                if (!city) {
                    statusEl.textContent = 'Пожалуйста, выберите город.';
                    statusEl.className = 'message error';
                    return;
                }
                
                const toolName = el('toolName').value;
                const description = el('toolDescription').value;
                const price = el('toolPrice').value;
                const contact = el('toolContact').value;

                try {
                    const response = await fetch(`${API_URL}/tool-requests`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({
                            tool_name: toolName,
                            description: description,
                            rental_price: price ? parseFloat(price) : null,
                            contact_info: contact,
                            city_id: city.id
                        })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        statusEl.textContent = `Объявление успешно размещено!`;
                        statusEl.className = 'message success';
                        el('createToolForm').reset();
                    } else {
                        statusEl.textContent = `Ошибка: ${data.detail}`;
                        statusEl.className = 'message error';
                    }
                } catch (error) {
                    statusEl.textContent = 'Ошибка сети. Пожалуйста, попробуйте позже.';
                    statusEl.className = 'message error';
                }
            });
            
            el('createMaterialForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const statusEl = el('createMaterialStatus');
                statusEl.textContent = 'Размещение объявления...';
                statusEl.className = 'message';
                
                const city = getSelectedCity();
                if (!city) {
                    statusEl.textContent = 'Пожалуйста, выберите город.';
                    statusEl.className = 'message error';
                    return;
                }

                const materialType = el('materialType').value;
                const description = el('materialDescription').value;
                const price = el('materialPrice').value;
                const contact = el('materialContact').value;

                try {
                    const response = await fetch(`${API_URL}/material-ads`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({
                            material_type: materialType,
                            description: description,
                            price: price ? parseFloat(price) : null,
                            contact_info: contact,
                            city_id: city.id
                        })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        statusEl.textContent = `Объявление успешно размещено!`;
                        statusEl.className = 'message success';
                        el('createMaterialForm').reset();
                    } else {
                        statusEl.textContent = `Ошибка: ${data.detail}`;
                        statusEl.className = 'message error';
                    }
                } catch (error) {
                    statusEl.textContent = 'Ошибка сети. Пожалуйста, попробуйте позже.';
                    statusEl.className = 'message error';
                }
            });
            
            const regUserTypeSelect = el('regUserType');
            const specializationGroup = el('specializationGroup');
            if (regUserTypeSelect && specializationGroup) {
                regUserTypeSelect.addEventListener('change', (e) => {
                    specializationGroup.style.display = (e.target.value === 'Исполнитель') ? 'block' : 'none';
                });
            }
            
            // Кнопки "Назад"
            const backButtons = ['backToMainFromProfile', 'backToMainFromCreateWork', 'backToMainFromFindWork', 'backToMainFromMachinery', 'backToMainFromTools', 'backToMainFromTakeOrder', 'backToMainFromFindMachinery', 'backToMainFromFindTools', 'backToMainFromMaterials', 'backToMainFromFindMaterials'];
            backButtons.forEach(btnId => {
                const btn = el(btnId);
                if (btn) btn.addEventListener('click', () => showPage('buttonContainer'));
            });
        }
        
        function checkAuthentication() {
            accessToken = localStorage.getItem('accessToken');
            if (accessToken) {
                fetchProfile();
                showPage('buttonContainer');
            } else {
                showPage('loginPage');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            fetchCities();
            fetchSpecializations();
            fetchMachineryTypes();
            fetchToolsList();
            fetchMaterialTypes();
            setupEventListeners();
            
            if (getSelectedCity()) {
                el('cityName').textContent = getSelectedCity().name;
                checkAuthentication();
            } else {
                el('cityModal').classList.add('active');
            }
        });
    </script>
</body>
</html>