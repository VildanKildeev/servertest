<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СМЗ.РФ - Рабочие и спецтехника</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Ваши стили */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; color: white; overflow: hidden; background: black; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .background-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; }
        .selected-city { margin-top: 12px; font-size: 16px; color: #fff; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; flex-wrap: wrap; }
        .header { width: 100%; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0, 0, 0, 0.4); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); position: fixed; top: 0; z-index: 10; }
        .city-selector { cursor: pointer; color: #ffeb3b; font-weight: bold; font-size: 14px; display: flex; align-items: center; }
        .profile-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .main-content { padding-top: 60px; width: 100%; max-width: 600px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; flex-grow: 1; padding-bottom: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 20px; width: 100%; max-width: 400px; }
        .action-button { background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 15px 10px; border-radius: 15px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.3s, border-color 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100px; }
        .action-button:hover { background: rgba(255, 255, 255, 0.2); border-color: white; }
        .action-button i { font-size: 24px; margin-bottom: 5px; color: #ffeb3b; }
        .page-content { display: none; width: 100%; max-width: 600px; padding: 20px; background: rgba(0, 0, 0, 0.7); border-radius: 10px; margin-top: 20px; position: relative; }
        .page-content.active { display: block; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 20; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.9); padding-top: 60px; }
        .modal.active { display: block; }
        .modal-content { background-color: rgba(45, 45, 45, 0.95); margin: 5% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 400px; border-radius: 15px; color: white; }
        .modal-content h2 { text-align: center; margin-bottom: 20px; color: #ffeb3b; }
        .modal-content input, .modal-content select, .modal-content button { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #555; background: #333; color: white; font-size: 16px; }
        .modal-content button.primary { background-color: #ffeb3b; color: black; font-weight: bold; cursor: pointer; }
        .modal-content button.secondary { background-color: #666; }
        .modal-content button.primary:disabled { background-color: #888; cursor: not-allowed; }

        /* Form Styles (general) */
        .form-container { display: flex; flex-direction: column; gap: 15px; }
        .form-container label { font-size: 14px; color: #ccc; }
        .form-container input[type="file"] { background: none; border: none; padding: 0; margin: 0; }
        .form-container textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #555; background: #333; color: white; font-size: 16px; min-height: 80px; resize: vertical; }

        /* Page specific styles */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-header h2 { color: #ffeb3b; }
        .back-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        .profile-info { margin-bottom: 30px; text-align: center; }
        .profile-info h3 { margin-bottom: 5px; color: white; }
        .profile-info p { color: #ccc; font-size: 14px; }
        .profile-info p.active { color: #5cb85c; font-weight: bold; }
        .profile-action-btn { background-color: #ffeb3b; color: black; font-weight: bold; width: 100%; padding: 12px; border-radius: 8px; border: none; cursor: pointer; margin-top: 10px; }
        .logout-btn { background-color: #dc3545; color: white; }

        /* Request/Ad List */
        .request-list { display: flex; flex-direction: column; gap: 15px; }
        .request-item { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; border-left: 5px solid #ffeb3b; color: white; }
        .request-item h4 { margin-bottom: 5px; color: #ffeb3b; }
        .request-item p { font-size: 14px; color: #ccc; margin-bottom: 3px; }
        .request-item .contact-btn { background-color: #28a745; color: white; padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; margin-top: 10px; font-size: 14px; }
        .request-item .contact-btn:hover { background-color: #218838; }

        /* Login/Register switch */
        .switch-link { text-align: center; margin-top: 15px; font-size: 14px; color: #ccc; cursor: pointer; }
        .switch-link span { color: #ffeb3b; font-weight: bold; }

        /* Footer Nav */
        .footer-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0, 0, 0, 0.7); box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.2); display: flex; justify-content: space-around; padding: 10px 0; z-index: 10; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: white; text-decoration: none; font-size: 12px; }
        .nav-item i { font-size: 20px; margin-bottom: 3px; }
        .nav-item.active i { color: #ffeb3b; }

        /* Loading Spinner */
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #ffeb3b; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Chat Page Styles (if implemented) */
        #chatPage { padding: 0; background: none; }
        .chat-header { width: 100%; padding: 15px; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; }
        .chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 10px; border-radius: 10px; max-width: 75%; }
        .message.incoming { background: #333; align-self: flex-start; }
        .message.outgoing { background: #ffeb3b; color: black; align-self: flex-end; }
        .chat-input { display: flex; padding: 10px; background: rgba(0, 0, 0, 0.8); width: 100%; }
        .chat-input input { flex-grow: 1; margin-right: 10px; }
        .chat-input button { background: #ffeb3b; color: black; border: none; padding: 10px 15px; border-radius: 8px; }

    </style>
</head>
<body>
    <video playsinline autoplay muted loop class="background-video" poster="/static/poster.jpg">
        <source src="/static/bg.mp4" type="video/mp4">
    </video>

    <div class="header">
        <div class="city-selector" id="citySelector">
            <i class="fas fa-map-marker-alt"></i> 
            <span id="cityName">Выберите город</span>
        </div>
        <button class="profile-btn" id="profileBtn"><i class="fas fa-user-circle"></i></button>
    </div>

    <div class="main-content">
        
        <div class="grid-container page-content active" id="buttonContainer">
            <button class="action-button" id="requestWorkerBtn">
                <i class="fas fa-tools"></i>
                Найти рабочего
            </button>
            <button class="action-button" id="requestMachineryBtn">
                <i class="fas fa-truck-moving"></i>
                Найти спецтехнику
            </button>
            <button class="action-button" id="requestToolBtn">
                <i class="fas fa-hammer"></i>
                Аренда инструмента
            </button>
            <button class="action-button" id="requestMaterialBtn">
                <i class="fas fa-warehouse"></i>
                Купить материал
            </button>
            <button class="action-button" id="marketplaceBtn">
                <i class="fas fa-list-alt"></i>
                Биржа заказов
            </button>
            <button class="action-button" id="takeOrderBtn">
                <i class="fas fa-handshake"></i>
                Взять заказ
            </button>
        </div>

        <div class="page-content" id="requestFormPage">
            <div class="page-header">
                <h2>Заявка на Рабочего</h2>
                <button class="back-btn" id="backToMainFromRequest"><i class="fas fa-times"></i></button>
            </div>
            <form id="requestWorkerForm" class="form-container">
                <label for="requestSpecialization">Специализация *</label>
                <select id="requestSpecialization" required></select>

                <label for="requestDescription">Описание задачи *</label>
                <textarea id="requestDescription" required placeholder="Максимально подробно опишите задачу"></textarea>

                <label for="requestBudget">Бюджет (руб.)</label>
                <input type="number" id="requestBudget" placeholder="Опционально">

                <label for="requestContact">Контакты *</label>
                <input type="text" id="requestContact" required placeholder="Телефон или email">

                <button type="submit" class="primary">Оставить заявку</button>
            </form>
        </div>

        <div class="page-content" id="machineryFormPage">
            <div class="page-header">
                <h2>Заявка на Спецтехнику</h2>
                <button class="back-btn" id="backToMainFromMachinery"><i class="fas fa-times"></i></button>
            </div>
            <form id="requestMachineryForm" class="form-container">
                <label for="machineType">Тип техники *</label>
                <input type="text" id="machineType" required placeholder="Например: Экскаватор, Кран">

                <label for="machineryDescription">Описание</label>
                <textarea id="machineryDescription" placeholder="Детали, условия аренды"></textarea>

                <label for="machineryPrice">Цена аренды (за час/смену)</label>
                <input type="number" id="machineryPrice" required placeholder="Цена">

                <label for="machineryContact">Контакты *</label>
                <input type="text" id="machineryContact" required placeholder="Телефон или email">

                <label><input type="checkbox" id="isPreorder"> Предзаказ (нужна дата)</label>
                <input type="datetime-local" id="preorderDate" style="display: none;">

                <button type="submit" class="primary">Разместить объявление</button>
            </form>
        </div>

        <div class="page-content" id="toolsFormPage">
            <div class="page-header">
                <h2>Объявление об Инструменте</h2>
                <button class="back-btn" id="backToMainFromTools"><i class="fas fa-times"></i></button>
            </div>
            <form id="requestToolForm" class="form-container">
                <label for="toolName">Название инструмента *</label>
                <input type="text" id="toolName" required placeholder="Например: Перфоратор Bosch">

                <label for="toolDescription">Описание</label>
                <textarea id="toolDescription" placeholder="Характеристики, состояние"></textarea>

                <label for="toolPrice">Цена аренды (сутки)</label>
                <input type="number" id="toolPrice" required placeholder="Цена">

                <label for="toolContact">Контакты *</label>
                <input type="text" id="toolContact" required placeholder="Телефон или email">

                <label for="toolStartDate">Срок аренды: Начало *</label>
                <input type="date" id="toolStartDate" required>

                <label for="toolEndDate">Срок аренды: Конец *</label>
                <input type="date" id="toolEndDate" required>

                <label><input type="checkbox" id="deliveryNeeded"> Нужна доставка</label>
                <input type="text" id="deliveryAddress" placeholder="Адрес доставки" style="display: none;">

                <button type="submit" class="primary">Разместить объявление</button>
            </form>
        </div>

        <div class="page-content" id="materialsFormPage">
            <div class="page-header">
                <h2>Объявление о Материале</h2>
                <button class="back-btn" id="backToMainFromMaterials"><i class="fas fa-times"></i></button>
            </div>
            <form id="materialsForm" class="form-container">
                <label for="materialType">Тип материала *</label>
                <input type="text" id="materialType" required placeholder="Например: Цемент М500, Кирпич">

                <label for="materialDescription">Описание (объем, состояние)</label>
                <textarea id="materialDescription" placeholder="Количество, годность, особенности"></textarea>

                <label for="materialPrice">Цена (за ед. или объем) *</label>
                <input type="number" id="materialPrice" required placeholder="Цена">

                <label for="materialContact">Контакты *</label>
                <input type="text" id="materialContact" required placeholder="Телефон или email">
                
                <label for="materialCity">Город (Необязательно)</label>
                <select id="materialCity" disabled>
                    </select>

                <button type="submit" class="primary">Разместить объявление</button>
            </form>
        </div>

        <div class="page-content" id="marketplacePage">
            <div class="page-header">
                <h2>Биржа Заказов</h2>
                <button class="back-btn" id="backToMainFromMarketplace"><i class="fas fa-times"></i></button>
            </div>
            <div class="request-list" id="marketplaceList">
                </div>
        </div>

        <div class="page-content" id="myRequestsPage">
            <div class="page-header">
                <h2>Мои Заявки (Работы)</h2>
                <button class="back-btn" id="backToProfileFromRequests"><i class="fas fa-times"></i></button>
            </div>
            <div class="request-list" id="myRequestsList">
                </div>
        </div>

        <div class="page-content" id="takeOrderPage">
            <div class="page-header">
                <h2>Откликнуться на Заказ</h2>
                <button class="back-btn" id="backToMainFromTakeOrder"><i class="fas fa-times"></i></button>
            </div>
            <div id="takeOrderDetails">
                </div>
            <button class="primary" id="respondToOrderBtn" style="margin-top: 20px;">Откликнуться</button>
        </div>
        
        <div class="page-content" id="profilePage">
            <div class="page-header">
                <h2>Мой Профиль</h2>
                <button class="back-btn" id="backToMain"><i class="fas fa-times"></i></button>
            </div>
            <div class="profile-info">
                <i class="fas fa-user-circle" style="font-size: 60px; margin-bottom: 10px;"></i>
                <h3 id="profileUsername">Имя пользователя</h3>
                <p id="profileUserType">Тип аккаунта:</p>
                <p id="profileSpecialization" style="font-size: 14px; color: #ffeb3b;"></p>
                <p>Город: <span id="profileCity"></span></p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h4 style="color: #ffeb3b; margin-bottom: 10px;">Статус Подписки</h4>
                <p>Статус: <span id="subscriptionStatus">Не активна</span></p>
                <p>Срок действия: <span id="subscriptionExpiry">-</span></p>
                <button class="profile-action-btn" id="subscriptionButton">Оформить подписку</button>
            </div>

            <button class="profile-action-btn" id="showMyRequestsBtn">Мои Заявки (Работы)</button>
            <button class="profile-action-btn logout-btn" id="logoutBtn">Выход</button>
        </div>
    </div>


    <div id="cityModal" class="modal active">
        <div class="modal-content">
            <h2>Выберите свой город</h2>
            <select id="citySelect"></select>
            <button class="primary" id="saveCityBtn">Сохранить</button>
        </div>
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content">
            <h2>Вход</h2>
            <form id="loginForm">
                <input type="text" id="loginUsername" placeholder="Логин" required>
                <input type="password" id="loginPassword" placeholder="Пароль" required>
                <button type="submit" class="primary">Войти</button>
            </form>
            <p class="switch-link" id="switchToRegister">Нет аккаунта? <span>Зарегистрироваться</span></p>
        </div>
    </div>

    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h2>Регистрация</h2>
            <form id="registerForm">
                <input type="text" id="registerUsername" placeholder="Логин" required>
                <input type="password" id="registerPassword" placeholder="Пароль" required>
                <input type="text" id="registerName" placeholder="Ваше Имя" required>
                
                <label for="userType">Я ищу:</label>
                <select id="userType" required>
                    <option value="worker">Рабочих</option>
                    <option value="employer">Работу</option>
                </select>

                <input type="text" id="registerSpecialization" placeholder="Специализация (для тех, кто ищет работу)" style="display: none;">

                <select id="registerCitySelect" required></select>
                <button type="submit" class="primary">Зарегистрироваться</button>
            </form>
            <p class="switch-link" id="switchToLogin">Уже есть аккаунт? <span>Войти</span></p>
        </div>
    </div>
    
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h2>Оплата Подписки (199 руб./мес)</h2>
            <form id="paymentForm">
                <input type="text" id="cardNumber" placeholder="Номер карты" required maxlength="16">
                <input type="text" id="cardExpiry" placeholder="ММ/ГГ" required maxlength="5">
                <input type="text" id="cardCVC" placeholder="CVC" required maxlength="3">
                <button type="submit" class="primary" id="payButton">ОПЛАТИТЬ</button>
            </form>
        </div>
    </div>


    <script>
    
    const API_URL = "/api"; // Внешний URL должен быть изменен при деплое
    const pages = ['buttonContainer', 'requestFormPage', 'machineryFormPage', 'toolsFormPage', 'marketplacePage', 'materialsFormPage', 'myRequestsPage', 'takeOrderPage', 'profilePage'];
    const modals = ['cityModal', 'authModal', 'registerModal', 'paymentModal'];
    
    let cities = [];
    let specializations = [];

    // --- UTILITY FUNCTIONS ---

    function closeAllPages() {
        pages.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = 'none';
            }
        });
        document.querySelector('.main-content').scrollTop = 0; // Сброс прокрутки
    }

    function closeAllModals() {
        modals.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.remove('active');
            }
        });
    }
    
    function showPage(pageId) {
        closeAllPages();
        const el = document.getElementById(pageId);
        if (el) {
            el.classList.add('active');
        }
    }

    function getSelectedCity() {
        const cityData = localStorage.getItem('selectedCity');
        return cityData ? JSON.parse(cityData) : null;
    }

    // --- API & DATA FETCHING ---

    async function fetchCities() {
        try {
            const response = await fetch(`${API_URL}/cities`);
            cities = await response.json();
            
            // Populate City Selectors
            const selectEl = document.getElementById('citySelect');
            const registerSelectEl = document.getElementById('registerCitySelect');
            const materialCityEl = document.getElementById('materialCity');
            
            [selectEl, registerSelectEl, materialCityEl].forEach(select => select.innerHTML = '<option value="">Выберите город...</option>');

            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city.id;
                option.textContent = city.name;
                
                [selectEl, registerSelectEl, materialCityEl].forEach(select => {
                    const clone = option.cloneNode(true);
                    select.appendChild(clone);
                });
            });
            
            // Set current city if exists
            const selectedCity = getSelectedCity();
            if (selectedCity) {
                document.getElementById('cityName').textContent = selectedCity.name;
                selectEl.value = selectedCity.id;
                materialCityEl.value = selectedCity.id;
            } else {
                 document.getElementById('cityModal').classList.add('active');
            }
            
        } catch (error) {
            console.error('Ошибка при загрузке городов:', error);
            alert('Ошибка при загрузке городов: Failed to fetch');
        }
    }

    async function fetchSpecializations() {
        try {
            const response = await fetch(`${API_URL}/specializations`);
            specializations = await response.json();
            
            // Populate Request Form Specialization Select
            const selectEl = document.getElementById('requestSpecialization');
            selectEl.innerHTML = '<option value="">Выберите специализацию...</option>';
            
            specializations.forEach(spec => {
                const option = document.createElement('option');
                option.value = spec;
                option.textContent = spec;
                selectEl.appendChild(option);
            });
            
        } catch (error) {
            console.error('Ошибка при загрузке специализаций:', error);
            // alert('Ошибка при загрузке специализаций: Failed to fetch');
        }
    }

    // --- AUTHENTICATION ---

    async function checkAuthentication() {
        const token = localStorage.getItem('fake_token');
        if (token) {
            try {
                const response = await fetch(`${API_URL}/user/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const user = await response.json();
                    localStorage.setItem('user_data', JSON.stringify(user));
                    updateProfile(user);
                    return true;
                } else {
                    localStorage.removeItem('fake_token');
                    localStorage.removeItem('user_data');
                    document.getElementById('profileBtn').classList.remove('active');
                    return false;
                }
            } catch (error) {
                console.error('Ошибка аутентификации:', error);
                localStorage.removeItem('fake_token');
                localStorage.removeItem('user_data');
                document.getElementById('profileBtn').classList.remove('active');
                return false;
            }
        }
        return false;
    }
    
    function updateProfile(user) {
        document.getElementById('profileUsername').textContent = user.user_name || user.username;
        document.getElementById('profileUserType').textContent = `Тип аккаунта: ${user.user_type === 'worker' ? 'Работник' : 'Заказчик'}`;
        
        const specializationEl = document.getElementById('profileSpecialization');
        specializationEl.textContent = user.specialization || '';
        specializationEl.style.display = user.specialization ? 'block' : 'none';

        const city = cities.find(c => c.id === user.city_id);
        document.getElementById('profileCity').textContent = city ? city.name : 'Неизвестен';
        
        document.getElementById('profileBtn').classList.add('active');
        updateSubscriptionInfo();
    }

    async function submitLogin(event) {
        event.preventDefault();
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        const button = document.querySelector('#loginForm button[type="submit"]');
        button.disabled = true;
        button.textContent = 'Вход...';

        try {
            const response = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Неизвестная ошибка');
            }

            const data = await response.json();
            localStorage.setItem('fake_token', data.token);
            localStorage.setItem('user_data', JSON.stringify(data.user));
            updateProfile(data.user);
            
            closeAllModals();
            document.getElementById('loginForm').reset();
            alert('Успешный вход!');

        } catch (error) {
            console.error('Ошибка входа:', error);
            alert('Ошибка входа: ' + error.message);
        } finally {
            button.disabled = false;
            button.textContent = 'Войти';
        }
    }
    
    async function submitRegister(event) {
        event.preventDefault();
        const username = document.getElementById('registerUsername').value;
        const password = document.getElementById('registerPassword').value;
        const user_name = document.getElementById('registerName').value;
        const user_type = document.getElementById('userType').value;
        const city_id = parseInt(document.getElementById('registerCitySelect').value);
        const specialization = document.getElementById('registerSpecialization').value || null;
        const button = document.querySelector('#registerForm button[type="submit"]');
        button.disabled = true;
        button.textContent = 'Регистрация...';
        
        if (!city_id) {
            alert('Пожалуйста, выберите город.');
            button.disabled = false;
            button.textContent = 'Зарегистрироваться';
            return;
        }

        try {
            const response = await fetch(`${API_URL}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username, 
                    password, 
                    user_name, 
                    user_type, 
                    city_id, 
                    specialization 
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Неизвестная ошибка');
            }

            const data = await response.json();
            alert('Регистрация успешна! Войдите, используя свой логин и пароль.');
            
            document.getElementById('registerForm').reset();
            showPage('authModal');

        } catch (error) {
            console.error('Ошибка регистрации:', error);
            alert('Ошибка регистрации: ' + error.message);
        } finally {
            button.disabled = false;
            button.textContent = 'Зарегистрироваться';
        }
    }
    
    function logout() {
        localStorage.removeItem('fake_token');
        localStorage.removeItem('user_data');
        localStorage.removeItem('subscription');
        document.getElementById('profileBtn').classList.remove('active');
        updateSubscriptionInfo();
        showPage('buttonContainer');
        alert('Вы вышли из системы.');
    }


    // --- REQUEST & AD SUBMISSIONS ---

    async function submitWorkRequest(event) {
        event.preventDefault();
        
        const description = document.getElementById('requestDescription').value;
        const specialization = document.getElementById('requestSpecialization').value;
        const budget = document.getElementById('requestBudget').value;
        const contact_info = document.getElementById('requestContact').value;
        const city_id = getSelectedCity() ? getSelectedCity().id : null;
        
        if (!description || !specialization || !contact_info || !city_id) {
            alert('Пожалуйста, заполните все обязательные поля.');
            return;
        }
        
        const requestBody = {
            description,
            specialization,
            budget: budget ? parseFloat(budget) : null,
            contact_info,
            city_id,
        };

        const submitButton = document.querySelector('#requestWorkerForm button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Отправка...';

        const token = localStorage.getItem('fake_token');
        if (!token) {
            alert('Ошибка: Пользователь не авторизован.');
            submitButton.disabled = false;
            submitButton.textContent = 'Оставить заявку';
            return;
        }

        try {
            const response = await fetch(`${API_URL}/work-requests`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Неизвестная ошибка');
            }

            const result = await response.json();
            alert('Заявка успешно создана!');
            document.getElementById('requestWorkerForm').reset();
            showPage('buttonContainer');
        } catch (error) {
            alert('Ошибка при создании заявки: ' + error.message);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Оставить заявку';
        }
    }

    async function submitMachineryRequest(event) {
        event.preventDefault();
        
        const machine_type = document.getElementById('machineType').value;
        const description = document.getElementById('machineryDescription').value;
        const rental_price = document.getElementById('machineryPrice').value;
        const contact_info = document.getElementById('machineryContact').value;
        const is_preorder = document.getElementById('isPreorder').checked;
        const preorder_date = document.getElementById('preorderDate').value;
        const city_id = getSelectedCity() ? getSelectedCity().id : null;
        
        if (!machine_type || !rental_price || !contact_info || !city_id) {
            alert('Пожалуйста, заполните все обязательные поля.');
            return;
        }

        const requestBody = {
            machine_type,
            description,
            rental_price: parseFloat(rental_price),
            contact_info,
            city_id,
            is_preorder,
            preorder_date: is_preorder ? preorder_date : null,
            photos: []
        };

        const submitButton = document.querySelector('#requestMachineryForm button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Отправка...';

        const token = localStorage.getItem('fake_token');
        if (!token) {
            alert('Ошибка: Пользователь не авторизован.');
            submitButton.disabled = false;
            submitButton.textContent = 'Разместить объявление';
            return;
        }

        try {
            const response = await fetch(`${API_URL}/machinery-requests`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Неизвестная ошибка');
            }

            const result = await response.json();
            alert('Объявление успешно размещено!');
            document.getElementById('requestMachineryForm').reset();
            showPage('buttonContainer');
        } catch (error) {
            alert('Ошибка при размещении объявления: ' + error.message);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Разместить объявление';
        }
    }

    async function submitToolRequest(event) {
        event.preventDefault();
        
        const tool_name = document.getElementById('toolName').value;
        const description = document.getElementById('toolDescription').value;
        const rental_price = document.getElementById('toolPrice').value;
        const contact_info = document.getElementById('toolContact').value;
        const start_date = document.getElementById('toolStartDate').value;
        const end_date = document.getElementById('toolEndDate').value;
        const delivery_needed = document.getElementById('deliveryNeeded').checked;
        const delivery_address = document.getElementById('deliveryAddress').value;
        const city_id = getSelectedCity() ? getSelectedCity().id : null;
        
        if (!tool_name || !rental_price || !contact_info || !start_date || !end_date || !city_id) {
            alert('Пожалуйста, заполните все обязательные поля.');
            return;
        }

        const requestBody = {
            tool_name,
            description,
            rental_price: parseFloat(rental_price),
            contact_info,
            city_id,
            start_date,
            end_date,
            delivery_needed,
            delivery_address: delivery_needed ? delivery_address : null,
            photos: []
        };

        const submitButton = document.querySelector('#requestToolForm button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Отправка...';

        const token = localStorage.getItem('fake_token');
        if (!token) {
            alert('Ошибка: Пользователь не авторизован.');
            submitButton.disabled = false;
            submitButton.textContent = 'Разместить объявление';
            return;
        }

        try {
            const response = await fetch(`${API_URL}/tool-requests`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Неизвестная ошибка');
            }

            const result = await response.json();
            alert('Объявление успешно размещено!');
            document.getElementById('requestToolForm').reset();
            showPage('buttonContainer');
        } catch (error) {
            alert('Ошибка при размещении объявления: ' + error.message);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Разместить объявление';
        }
    }
    
    // ИСПРАВЛЕННАЯ ФУНКЦИЯ ДЛЯ МАТЕРИАЛОВ
    async function submitMaterialAd(event) {
        event.preventDefault();

        const materialType = document.getElementById('materialType').value;
        const materialDescription = document.getElementById('materialDescription').value;
        const materialPrice = document.getElementById('materialPrice').value;
        const materialContact = document.getElementById('materialContact').value;
        const materialCity = document.getElementById('materialCity').value;

        if (!materialType || !materialPrice || !materialContact || !materialCity) {
            alert('Пожалуйста, заполните все обязательные поля (Тип материала, Цена, Контакты, Город)');
            return;
        }

        // Преобразование значений в требуемые типы данных
        const requestBody = {
            material_type: materialType,
            description: materialDescription,
            price: parseFloat(materialPrice), // ИСПРАВЛЕНО: Преобразование в float
            contact_info: materialContact,
            city_id: parseInt(materialCity), // ИСПРАВЛЕНО: Преобразование в int
            photos: [] // Пока что оставляем пустым
        };

        const submitButton = document.querySelector('#materialsFormPage button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Отправка...';

        const token = localStorage.getItem('fake_token');
        if (!token) {
            alert('Ошибка: Пользователь не авторизован.');
            submitButton.disabled = false;
            submitButton.textContent = 'Разместить объявление';
            return;
        }

        try {
            const response = await fetch(`${API_URL}/material-ads`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                // Улучшенная обработка ошибки для вывода 'detail'
                throw new Error(errorData.detail || 'Неизвестная ошибка');
            }

            const result = await response.json();
            alert('Объявление успешно размещено!');
            console.log(result);
            document.getElementById('materialsForm').reset();
            showPage('buttonContainer');
        } catch (error) {
            // Теперь здесь будет выведено настоящее сообщение об ошибке от сервера
            alert('Ошибка при размещении объявления: ' + error.message);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Разместить объявление';
        }
    }


    // --- MARKETPLACE AND MY REQUESTS ---

    function createRequestItem(request) {
        const item = document.createElement('div');
        item.className = 'request-item';
        
        // Determine type-specific header
        let title = '';
        let details = '';
        let contact = request.contact_info;

        if (request.specialization) {
            // Work Request
            title = 'Требуется ' + request.specialization;
            details = `Бюджет: ${request.budget ? request.budget + ' руб.' : 'Не указан'}`;
        } else if (request.machine_type) {
            // Machinery Request
            title = 'Аренда: ' + request.machine_type;
            details = `Цена: ${request.rental_price} / час/смена`;
        } else if (request.tool_name) {
            // Tool Request
            title = 'Аренда: ' + request.tool_name;
            details = `Цена: ${request.rental_price} / сутки. Срок: ${request.start_date.substring(0, 10)} - ${request.end_date.substring(0, 10)}`;
        } else if (request.material_type) {
             // Material Ad
            title = 'Материал: ' + request.material_type;
            details = `Цена: ${request.price} руб.`;
        } else {
            title = 'Неизвестный тип запроса';
        }
        
        // Find city name
        const city = cities.find(c => c.id === request.city_id);
        const cityName = city ? city.name : 'Неизвестно';

        item.innerHTML = `
            <h4>${title}</h4>
            <p>Город: ${cityName}</p>
            <p>${details}</p>
            <p>Описание: ${request.description || 'Нет'}</p>
            <p style="font-size: 12px; color: #777;">Создано: ${new Date(request.created_at).toLocaleDateString('ru-RU')}</p>
            <button class="contact-btn" data-contact="${contact}">Связаться</button>
        `;
        
        // Add event listener to contact button
        item.querySelector('.contact-btn').addEventListener('click', (e) => {
            alert('Контактная информация: ' + e.target.getAttribute('data-contact'));
        });

        return item;
    }

    async function loadMarketplace() {
        const listEl = document.getElementById('marketplaceList');
        listEl.innerHTML = '<p style="text-align:center; color:#ccc;"><div class="spinner"></div> Загрузка...</p>';
        const city_id = getSelectedCity() ? getSelectedCity().id : null;
        
        if (!city_id) {
            listEl.innerHTML = '<p style="color:red; text-align:center;">Ошибка: Сначала выберите город.</p>';
            return;
        }

        try {
            // Загрузка заявок на работы
            const workResponse = await fetch(`${API_URL}/work-requests?city_id=${city_id}`);
            const workRequests = await workResponse.json();

            // Загрузка объявлений о материалах
            const materialResponse = await fetch(`${API_URL}/material-ads?city_id=${city_id}`);
            const materialAds = await materialResponse.json();

            const combinedList = [...workRequests, ...materialAds].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            listEl.innerHTML = ''; // Очистка списка
            
            if (combinedList.length === 0) {
                listEl.innerHTML = '<p style="color:#ccc; text-align:center;">Заказов в вашем городе пока нет.</p>';
                return;
            }

            combinedList.forEach(request => {
                listEl.appendChild(createRequestItem(request));
            });

        } catch (error) {
            listEl.innerHTML = '<p style="color:red; text-align:center;">Не удалось загрузить заказы.</p>';
            console.error('Ошибка загрузки биржи:', error);
        }
    }

    async function loadMyRequests() {
        const listEl = document.getElementById('myRequestsList');
        listEl.innerHTML = '<p style="text-align:center; color:#ccc;"><div class="spinner"></div> Загрузка...</p>';
        const token = localStorage.getItem('fake_token');
        
        try {
            const response = await fetch(`${API_URL}/my-work-requests`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                throw new Error('Не удалось загрузить Ваши заявки.');
            }

            const requests = await response.json();
            listEl.innerHTML = '';
            
            if (requests.length === 0) {
                listEl.innerHTML = '<p style="color:#ccc; text-align:center;">Вы еще не оставляли заявок на работу.</p>';
                return;
            }

            requests.forEach(request => {
                listEl.appendChild(createRequestItem(request));
            });
            
        } catch (error) {
            listEl.innerHTML = `<p style="color:red; text-align:center;">Ошибка: ${error.message}</p>`;
            console.error('Ошибка загрузки моих заявок:', error);
        }
    }


    // --- SUBSCRIPTION LOGIC (Placeholder) ---

    function isSubscriptionActive() {
        const subscription = JSON.parse(localStorage.getItem('subscription') || 'null');
        // Проверяем, есть ли подписка, активна ли она и не истек ли срок
        return subscription && subscription.active && new Date(subscription.expiry) > new Date();
    }
    
    function submitPayment(event) {
        event.preventDefault();
        
        const button = document.getElementById('payButton');
        button.disabled = true;
        button.textContent = 'Обработка...';

        // Имитация задержки и успешной оплаты
        setTimeout(() => {
            const expiryDate = new Date();
            expiryDate.setMonth(expiryDate.getMonth() + 1); // Подписка на 1 месяц
            
            // Сохраняем "активную подписку" в локальном хранилище
            localStorage.setItem('subscription', JSON.stringify({
                active: true,
                expiry: expiryDate.toISOString()
            }));
            
            updateSubscriptionInfo();
            closeAllModals();
            document.getElementById('paymentForm').reset();
            button.disabled = false;
            button.textContent = 'ОПЛАТИТЬ';
            alert('Подписка успешно оформлена!');
            
        }, 1500);
    }
    
    function updateSubscriptionInfo() {
        const statusEl = document.getElementById('subscriptionStatus');
        const expiryEl = document.getElementById('subscriptionExpiry');
        const subButton = document.getElementById('subscriptionButton');
        if (isSubscriptionActive()) {
            const sub = JSON.parse(localStorage.getItem('subscription'));
            statusEl.textContent = 'Активна';
            statusEl.classList.add('active');
            expiryEl.textContent = `до ${new Date(sub.expiry).toLocaleDateString('ru-RU')}`;
            subButton.textContent = 'Подписка активна';
            subButton.disabled = true;
        } else {
            statusEl.textContent = 'Не активна';
            statusEl.classList.remove('active');
            expiryEl.textContent = '-';
            subButton.textContent = 'Оформить подписку';
            subButton.disabled = false;
        }
    }


    // --- EVENT LISTENERS ---

    document.addEventListener('DOMContentLoaded', () => {
        const cityNameEl = document.getElementById('cityName');
        const cityModal = document.getElementById('cityModal');
        const registerSpecializationEl = document.getElementById('registerSpecialization');
        const userTypeSelect = document.getElementById('userType');

        // City Modal Handlers
        document.getElementById('saveCityBtn').addEventListener('click', () => {
            const selectEl = document.getElementById('citySelect');
            const cityId = selectEl.value;
            const cityName = selectEl.options[selectEl.selectedIndex].textContent;
            
            if (cityId) {
                localStorage.setItem('selectedCity', JSON.stringify({ id: parseInt(cityId), name: cityName }));
                cityNameEl.textContent = cityName;
                closeAllModals();
                checkAuthentication();
            } else {
                alert('Пожалуйста, выберите город.');
            }
        });
        document.getElementById('citySelector').addEventListener('click', () => {
            cityModal.classList.add('active');
        });
        
        // Auth/Register Switch Handlers
        document.getElementById('switchToRegister').addEventListener('click', () => {
            showPage('registerModal');
            document.getElementById('registerCitySelect').value = getSelectedCity() ? getSelectedCity().id : '';
        });
        document.getElementById('switchToLogin').addEventListener('click', () => {
            showPage('authModal');
        });
        
        // Specialization input display based on user type
        userTypeSelect.addEventListener('change', (e) => {
            if (e.target.value === 'employer') {
                registerSpecializationEl.style.display = 'block';
                registerSpecializationEl.required = true;
            } else {
                registerSpecializationEl.style.display = 'none';
                registerSpecializationEl.required = false;
            }
        });

        // Form submission handlers
        document.getElementById('loginForm').addEventListener('submit', submitLogin);
        document.getElementById('registerForm').addEventListener('submit', submitRegister);
        document.getElementById('requestWorkerForm').addEventListener('submit', submitWorkRequest);
        document.getElementById('requestMachineryForm').addEventListener('submit', submitMachineryRequest);
        document.getElementById('requestToolForm').addEventListener('submit', submitToolRequest);
        document.getElementById('materialsForm').addEventListener('submit', submitMaterialAd);
        document.getElementById('paymentForm').addEventListener('submit', submitPayment);

        // Machinery preorder date visibility
        document.getElementById('isPreorder').addEventListener('change', (e) => {
            document.getElementById('preorderDate').style.display = e.target.checked ? 'block' : 'none';
            document.getElementById('preorderDate').required = e.target.checked;
        });

        // Tool delivery address visibility
        document.getElementById('deliveryNeeded').addEventListener('change', (e) => {
            document.getElementById('deliveryAddress').style.display = e.target.checked ? 'block' : 'none';
        });

        // Navigation button handlers
        document.getElementById('profileBtn').addEventListener('click', () => {
            const user = localStorage.getItem('user_data');
            if (user) {
                showPage('profilePage');
            } else {
                showPage('authModal');
            }
        });

        document.getElementById('requestWorkerBtn').addEventListener('click', () => showPage('requestFormPage'));
        document.getElementById('requestMachineryBtn').addEventListener('click', () => showPage('machineryFormPage'));
        document.getElementById('requestToolBtn').addEventListener('click', () => showPage('toolsFormPage'));
        document.getElementById('requestMaterialBtn').addEventListener('click', () => showPage('materialsFormPage'));
        
        document.getElementById('marketplaceBtn').addEventListener('click', () => {
            showPage('marketplacePage');
            loadMarketplace();
        });
        
        document.getElementById('showMyRequestsBtn').addEventListener('click', () => {
            showPage('myRequestsPage');
            loadMyRequests();
        });

        document.getElementById('logoutBtn').addEventListener('click', logout);
        
        document.getElementById('subscriptionButton').addEventListener('click', () => {
            showPage('paymentModal');
        });


        // Back buttons
        document.getElementById('backToMainFromRequest').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
        document.getElementById('backToMainFromMachinery').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
        document.getElementById('backToMainFromTools').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
        document.getElementById('backToMainFromMaterials').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
        document.getElementById('backToMainFromTakeOrder').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
        document.getElementById('backToMainFromMarketplace').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
        document.getElementById('backToProfileFromRequests').addEventListener('click', (e) => { e.preventDefault(); showPage('profilePage'); });
        document.getElementById('backToMain').addEventListener('click', (e) => { e.preventDefault(); showPage('buttonContainer'); });
        
        // Initial setup
        fetchCities();
        fetchSpecializations();
        if (getSelectedCity()) {
            cityNameEl.textContent = getSelectedCity().name;
            checkAuthentication();
        } else {
            cityModal.classList.add('active');
        }
    });
    </script>
</body>
</html>